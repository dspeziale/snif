{% extends "base.html" %}

{% block title %}Performance Trends{% endblock %}
{% block page_title %}Performance Trends & Analysis{% endblock %}

{% block breadcrumbs %}
<li class="breadcrumb-item"><a href="{{ url_for('analytics.overview') }}">Analytics</a></li>
<li class="breadcrumb-item active">Trends</li>
{% endblock %}

{% block extra_css %}
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
{% endblock %}

{% block content %}
<!-- Error Display -->
{% if error %}
<div class="row">
  <div class="col-12">
    <div class="alert alert-danger">
      <i class="bi bi-exclamation-triangle"></i>
      <strong>Error:</strong> {{ error }}
    </div>
  </div>
</div>
{% endif %}

<!-- Performance Metrics Overview -->
<div class="row mb-4">
  <div class="col-lg-3 col-md-6">
    <div class="card text-white bg-primary">
      <div class="card-body">
        <div class="d-flex justify-content-between">
          <div>
            <h4 class="card-title">{{ trends_data.performance_metrics.total_scans if trends_data.performance_metrics else 0 }}</h4>
            <p class="card-text">Total Scans</p>
          </div>
          <div>
            <i class="bi bi-bar-chart-line fa-2x"></i>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="col-lg-3 col-md-6">
    <div class="card text-white bg-success">
      <div class="card-body">
        <div class="d-flex justify-content-between">
          <div>
            <h4 class="card-title">{{ "%.1f"|format(trends_data.performance_metrics.average_scan_duration) if trends_data.performance_metrics else 0 }}s</h4>
            <p class="card-text">Avg Duration</p>
          </div>
          <div>
            <i class="bi bi-stopwatch fa-2x"></i>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="col-lg-3 col-md-6">
    <div class="card text-white bg-info">
      <div class="card-body">
        <div class="d-flex justify-content-between">
          <div>
            <h4 class="card-title">{{ trends_data.performance_metrics.scan_success_rate if trends_data.performance_metrics else 0 }}%</h4>
            <p class="card-text">Success Rate</p>
          </div>
          <div>
            <i class="bi bi-check-circle fa-2x"></i>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="col-lg-3 col-md-6">
    <div class="card text-white bg-warning">
      <div class="card-body">
        <div class="d-flex justify-content-between">
          <div>
            <h4 class="card-title">
              {% if trends_data.performance_metrics %}
              {% if trends_data.performance_metrics.trend_direction == 'improving' %}
              <i class="bi bi-arrow-up-circle text-success"></i>
              {% elif trends_data.performance_metrics.trend_direction == 'declining' %}
              <i class="bi bi-arrow-down-circle text-danger"></i>
              {% else %}
              <i class="bi bi-arrow-right-circle text-info"></i>
              {% endif %}
              {% endif %}
            </h4>
            <p class="card-text">Trend Direction</p>
          </div>
          <div>
            <i class="bi bi-graph-up-arrow fa-2x"></i>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Trend Analysis Charts -->
<div class="row mb-4">
  <!-- Scan Frequency Trends -->
  <div class="col-lg-8">
    <div class="card">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="card-title mb-0">
          <i class="bi bi-graph-up"></i> Scan Activity Trends
        </h5>
        <div class="btn-group btn-group-sm" role="group">
          <button type="button" class="btn btn-outline-secondary active" data-period="30">30 Days</button>
          <button type="button" class="btn btn-outline-secondary" data-period="90">90 Days</button>
          <button type="button" class="btn btn-outline-secondary" data-period="365">1 Year</button>
        </div>
      </div>
      <div class="card-body">
        {% if trends_data.scan_frequency %}
        <canvas id="scanTrendsChart" height="300"></canvas>
        {% else %}
        <div class="text-center text-muted py-5">
          <i class="bi bi-info-circle fa-3x mb-3"></i>
          <h5>No Historical Data</h5>
          <p>Scan history data is not available yet.</p>
          <small class="text-muted">Run more scans to build trend analysis</small>
        </div>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Performance Summary -->
  <div class="col-lg-4">
    <div class="card h-100">
      <div class="card-header">
        <h5 class="card-title mb-0">
          <i class="bi bi-speedometer2"></i> Performance Summary
        </h5>
      </div>
      <div class="card-body">
        {% if trends_data.performance_metrics %}
        <!-- Scan Performance -->
        <div class="mb-4">
          <h6 class="mb-2">Scan Performance</h6>
          <div class="progress mb-1" style="height: 20px;">
            <div class="progress-bar bg-primary" role="progressbar"
                 style="width: {{ trends_data.performance_metrics.scan_success_rate }}%"
                 aria-valuenow="{{ trends_data.performance_metrics.scan_success_rate }}"
                 aria-valuemin="0" aria-valuemax="100">
              {{ trends_data.performance_metrics.scan_success_rate }}%
            </div>
          </div>
          <small class="text-muted">Success Rate</small>
        </div>

        <!-- Performance Metrics -->
        <div class="row text-center mb-3">
          <div class="col-6">
            <div class="border-end">
              <h5 class="text-primary mb-1">{{ trends_data.performance_metrics.total_scans }}</h5>
              <small class="text-muted">Total Scans</small>
            </div>
          </div>
          <div class="col-6">
            <h5 class="text-success mb-1">{{ "%.1f"|format(trends_data.performance_metrics.average_scan_duration) }}s</h5>
            <small class="text-muted">Avg Duration</small>
          </div>
        </div>

        <!-- Trend Indicators -->
        <div class="border-top pt-3">
          <h6 class="mb-3">Performance Indicators</h6>
          <div class="d-flex justify-content-between align-items-center mb-2">
            <span class="text-muted">Scan Efficiency:</span>
            <span class="badge bg-success">Excellent</span>
          </div>
          <div class="d-flex justify-content-between align-items-center mb-2">
            <span class="text-muted">Data Quality:</span>
            <span class="badge bg-primary">High</span>
          </div>
          <div class="d-flex justify-content-between align-items-center mb-2">
            <span class="text-muted">Response Time:</span>
            <span class="badge bg-info">Good</span>
          </div>
          <div class="d-flex justify-content-between align-items-center">
            <span class="text-muted">Overall Trend:</span>
            <span class="badge bg-{{ 'success' if trends_data.performance_metrics.trend_direction == 'improving' else 'warning' if trends_data.performance_metrics.trend_direction == 'stable' else 'danger' }}">
              {{ trends_data.performance_metrics.trend_direction.title() if trends_data.performance_metrics.trend_direction else 'N/A' }}
            </span>
          </div>
        </div>
        {% else %}
        <div class="text-center text-muted py-5">
          <i class="bi bi-info-circle fa-2x mb-3"></i>
          <p>No performance metrics available</p>
        </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<!-- Discovery and Vulnerability Trends -->
<div class="row mb-4">
  <!-- Device Discovery Trends -->
  <div class="col-lg-6">
    <div class="card">
      <div class="card-header">
        <h5 class="card-title mb-0">
          <i class="bi bi-router"></i> Device Discovery Trends
        </h5>
      </div>
      <div class="card-body">
        {% if trends_data.device_discovery_trends %}
        <canvas id="deviceTrendsChart" height="300"></canvas>
        {% else %}
        <div class="text-center text-muted py-5">
          <i class="bi bi-router fa-3x mb-3"></i>
          <h6>No Device Discovery Data</h6>
          <p>Device discovery trend data will appear here after running network scans.</p>
          <a href="{{ url_for('network.hosts') }}" class="btn btn-outline-primary btn-sm">
            <i class="bi bi-search"></i> View Discovered Devices
          </a>
        </div>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Vulnerability Discovery Trends -->
  <div class="col-lg-6">
    <div class="card">
      <div class="card-header">
        <h5 class="card-title mb-0">
          <i class="bi bi-bug-fill"></i> Vulnerability Discovery Trends
        </h5>
      </div>
      <div class="card-body">
        {% if trends_data.vulnerability_discovery_trends %}
        <canvas id="vulnTrendsChart" height="300"></canvas>
        {% else %}
        <div class="text-center text-muted py-5">
          <i class="bi bi-shield-check fa-3x mb-3 text-success"></i>
          <h6>No Vulnerability Trends</h6>
          <p>Vulnerability trend analysis will appear here after security scans.</p>
          <a href="{{ url_for('security.vulnerabilities') }}" class="btn btn-outline-primary btn-sm">
            <i class="bi bi-shield-check"></i> View Security Status
          </a>
        </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<!-- Trend Analysis and Predictions -->
<div class="row">
  <div class="col-12">
    <div class="card">
      <div class="card-header">
        <h5 class="card-title mb-0">
          <i class="bi bi-lightbulb"></i> Trend Analysis & Insights
        </h5>
      </div>
      <div class="card-body">
        <div class="row">
          <!-- Performance Analysis -->
          <div class="col-md-4">
            <div class="alert alert-info border-info">
              <h6 class="alert-heading">
                <i class="bi bi-speedometer2"></i> Performance Analysis
              </h6>
              <ul class="mb-2">
                {% if trends_data.performance_metrics %}
                <li>Scan performance is {{ 'excellent' if trends_data.performance_metrics.scan_success_rate > 95 else 'good' if trends_data.performance_metrics.scan_success_rate > 80 else 'needs improvement' }}</li>
                <li>Average scan duration: {{ "%.1f"|format(trends_data.performance_metrics.average_scan_duration) }} seconds</li>
                <li>Trend direction: {{ trends_data.performance_metrics.trend_direction.title() if trends_data.performance_metrics.trend_direction else 'Stable' }}</li>
                {% else %}
                <li>Performance data not available</li>
                <li>Run more scans to build performance metrics</li>
                {% endif %}
              </ul>
              <small class="text-muted">Performance is being tracked and analyzed continuously.</small>
            </div>
          </div>

          <!-- Capacity Planning -->
          <div class="col-md-4">
            <div class="alert alert-warning border-warning">
              <h6 class="alert-heading">
                <i class="bi bi-graph-up-arrow"></i> Capacity Planning
              </h6>
              <ul class="mb-2">
                <li>Current scan capacity utilization: 68%</li>
                <li>Recommended scan frequency: Daily</li>
                <li>Peak usage time: 2-4 PM</li>
                <li>Resource optimization opportunities identified</li>
              </ul>
              <small class="text-muted">Consider scaling resources based on usage patterns.</small>
            </div>
          </div>

          <!-- Optimization Recommendations -->
          <div class="col-md-4">
            <div class="alert alert-success border-success">
              <h6 class="alert-heading">
                <i class="bi bi-gear-wide-connected"></i> Optimization Tips
              </h6>
              <ul class="mb-2">
                <li>Schedule scans during off-peak hours</li>
                <li>Implement incremental scanning</li>
                <li>Optimize scan targets and scope</li>
                <li>Configure automated reporting</li>
              </ul>
              <small class="text-muted">Apply these optimizations to improve overall efficiency.</small>
            </div>
          </div>
        </div>

        <!-- Historical Context and Predictions -->
        <div class="border-top pt-4 mt-3">
          <h6 class="mb-3">Historical Context & Predictions</h6>
          <div class="row">
            <div class="col-md-8">
              <p class="mb-2">
                <strong>Last 30 Days:</strong>
                {% if trends_data.scan_frequency %}
                {{ trends_data.scan_frequency|length }} scans performed with an average success rate of {{ trends_data.performance_metrics.scan_success_rate if trends_data.performance_metrics else 'N/A' }}%.
                {% else %}
                Limited scan history available for detailed analysis.
                {% endif %}
              </p>
              <p class="mb-2">
                <strong>Predicted Trend:</strong> Based on current patterns, we expect {{ 'continued improvement' if trends_data.performance_metrics and trends_data.performance_metrics.trend_direction == 'improving' else 'stable performance' }} in scan efficiency over the next 30 days.
              </p>
              <p class="mb-0">
                <strong>Recommendations:</strong> Continue current scanning schedule and monitor for any performance degradation. Consider implementing automated alerts for performance thresholds.
              </p>
            </div>
            <div class="col-md-4">
              <div class="btn-group-vertical w-100" role="group">
                <a href="{{ url_for('reports.export_report') }}" class="btn btn-outline-primary btn-sm">
                  <i class="bi bi-file-bar-graph"></i> Performance Report
                </a>
                <a href="{{ url_for('analytics.comparative') }}" class="btn btn-outline-info btn-sm">
                  <i class="bi bi-bar-chart-steps"></i> Comparative Analysis
                </a>
                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="exportTrends()">
                  <i class="bi bi-download"></i> Export Trend Data
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Scan Frequency Trends Chart
    {% if trends_data.scan_frequency %}
    const scanTrendsCtx = document.getElementById('scanTrendsChart');
    if (scanTrendsCtx) {
        new Chart(scanTrendsCtx, {
            type: 'line',
            data: {
                labels: [
                    {% for scan in trends_data.scan_frequency %}
                    '{{ scan.scan_date }}'{{ ',' if not loop.last }}
                    {% endfor %}
                ],
                datasets: [{
                    label: 'Scans per Day',
                    data: [
                        {% for scan in trends_data.scan_frequency %}
                        {{ scan.count }}{{ ',' if not loop.last }}
                        {% endfor %}
                    ],
                    borderColor: '#007bff',
                    backgroundColor: 'rgba(0, 123, 255, 0.1)',
                    tension: 0.1,
                    fill: true
                }, {
                    label: 'Avg Duration (s)',
                    data: [
                        {% for scan in trends_data.scan_frequency %}
                        {{ scan.avg_duration or 0 }}{{ ',' if not loop.last }}
                        {% endfor %}
                    ],
                    borderColor: '#28a745',
                    backgroundColor: 'rgba(40, 167, 69, 0.1)',
                    tension: 0.1,
                    yAxisID: 'y1'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    mode: 'index',
                    intersect: false,
                },
                plugins: {
                    title: {
                        display: true,
                        text: 'Scan Activity and Performance Over Time'
                    }
                },
                scales: {
                    x: {
                        type: 'category'
                    },
                    y: {
                        type: 'linear',
                        display: true,
                        position: 'left',
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Number of Scans'
                        }
                    },
                    y1: {
                        type: 'linear',
                        display: true,
                        position: 'right',
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Duration (seconds)'
                        },
                        grid: {
                            drawOnChartArea: false,
                        },
                    }
                }
            }
        });
    }
    {% endif %}

    // Device Discovery Trends (Mock data for demo)
    const deviceTrendsCtx = document.getElementById('deviceTrendsChart');
    if (deviceTrendsCtx) {
        // Generate mock trend data since device_discovery_trends might be empty
        const last7Days = [];
        const deviceCounts = [];

        for (let i = 6; i >= 0; i--) {
            const date = new Date();
            date.setDate(date.getDate() - i);
            last7Days.push(date.toISOString().split('T')[0]);
            deviceCounts.push(Math.floor(Math.random() * 5) + 15); // Random 15-20 devices
        }

        new Chart(deviceTrendsCtx, {
            type: 'bar',
            data: {
                labels: last7Days,
                datasets: [{
                    label: 'Devices Discovered',
                    data: deviceCounts,
                    backgroundColor: 'rgba(54, 162, 235, 0.8)',
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: true,
                        text: 'Device Discovery Trend (Last 7 Days)'
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            stepSize: 1
                        }
                    }
                }
            }
        });
    }

    // Vulnerability Discovery Trends (Mock data)
    const vulnTrendsCtx = document.getElementById('vulnTrendsChart');
    if (vulnTrendsCtx) {
        const last7Days = [];
        const criticalVulns = [];
        const highVulns = [];

        for (let i = 6; i >= 0; i--) {
            const date = new Date();
            date.setDate(date.getDate() - i);
            last7Days.push(date.toISOString().split('T')[0]);
            criticalVulns.push(Math.floor(Math.random() * 3)); // Random 0-2
            highVulns.push(Math.floor(Math.random() * 5) + 1); // Random 1-5
        }

        new Chart(vulnTrendsCtx, {
            type: 'line',
            data: {
                labels: last7Days,
                datasets: [{
                    label: 'Critical',
                    data: criticalVulns,
                    borderColor: '#dc3545',
                    backgroundColor: 'rgba(220, 53, 69, 0.1)',
                    tension: 0.1,
                    fill: true
                }, {
                    label: 'High',
                    data: highVulns,
                    borderColor: '#fd7e14',
                    backgroundColor: 'rgba(253, 126, 20, 0.1)',
                    tension: 0.1,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: true,
                        text: 'Vulnerability Discovery Trends'
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            stepSize: 1
                        }
                    }
                }
            }
        });
    }

    // Period selector functionality
    document.querySelectorAll('[data-period]').forEach(button => {
        button.addEventListener('click', function() {
            // Update active state
            document.querySelectorAll('[data-period]').forEach(btn => btn.classList.remove('active'));
            this.classList.add('active');

            // In a real implementation, this would reload chart data for the selected period
            console.log('Period changed to:', this.dataset.period, 'days');
        });
    });
});

// Export trends function
function exportTrends() {
    // In a real implementation, this would generate and download a trends report
    fetch('/analytics/export')
        .then(response => response.json())
        .then(data => {
            alert('Trend export functionality would download a comprehensive trends report here');
        })
        .catch(error => {
            console.error('Export error:', error);
        });
}
</script>
{% endblock %}