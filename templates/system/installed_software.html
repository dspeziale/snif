{% extends "base.html" %}

{% block title %}Installed Software - AdminLTE{% endblock %}
{% block page_title %}Installed Software{% endblock %}

{% block breadcrumbs %}
<li class="breadcrumb-item"><a href="{{ url_for('index') }}">Home</a></li>
<li class="breadcrumb-item"><a href="{{ url_for('system.software') }}">System</a></li>
<li class="breadcrumb-item active">Installed Software</li>
{% endblock %}

{% block content %}
<div class="container-fluid">
  {% if error %}
  <div class="alert alert-danger">
    <i class="bi bi-exclamation-triangle"></i> Error: {{ error }}
  </div>
  {% else %}

  <!-- Filters -->
  <div class="card mb-4">
    <div class="card-header">
      <h3 class="card-title">
        <i class="bi bi-funnel"></i> Filters
      </h3>
    </div>
    <div class="card-body">
      <form method="GET" action="{{ url_for('system.installed_software') }}">
        <div class="row">
          <div class="col-md-3">
            <div class="mb-3">
              <label for="search" class="form-label">Search</label>
              <input type="text" class="form-control" id="search" name="search"
                     value="{{ request.args.get('search', '') }}"
                     placeholder="Search software...">
            </div>
          </div>
          <div class="col-md-3">
            <div class="mb-3">
              <label for="host" class="form-label">Host IP</label>
              <input type="text" class="form-control" id="host" name="host"
                     value="{{ request.args.get('host', '') }}"
                     placeholder="e.g., 192.168.1.10">
            </div>
          </div>
          <div class="col-md-3">
            <div class="mb-3">
              <label for="publisher" class="form-label">Publisher</label>
              <input type="text" class="form-control" id="publisher" name="publisher"
                     value="{{ request.args.get('publisher', '') }}"
                     placeholder="e.g., Microsoft">
            </div>
          </div>
          <div class="col-md-3">
            <div class="mb-3">
              <label for="has_version" class="form-label">Version Info</label>
              <select class="form-select" id="has_version" name="has_version">
                <option value="">All Software</option>
                <option value="true" {% if request.args.get('has_version') == 'true' %}selected{% endif %}>With Version</option>
                <option value="false" {% if request.args.get('has_version') == 'false' %}selected{% endif %}>Without Version</option>
              </select>
            </div>
          </div>
        </div>
        <div class="row">
          <div class="col-md-3">
            <div class="mb-3">
              <label for="per_page" class="form-label">Results per page</label>
              <select class="form-select" id="per_page" name="per_page">
                <option value="25" {% if request.args.get('per_page', '50') == '25' %}selected{% endif %}>25</option>
                <option value="50" {% if request.args.get('per_page', '50') == '50' %}selected{% endif %}>50</option>
                <option value="100" {% if request.args.get('per_page', '50') == '100' %}selected{% endif %}>100</option>
                <option value="200" {% if request.args.get('per_page', '50') == '200' %}selected{% endif %}>200</option>
              </select>
            </div>
          </div>
          <div class="col-md-9">
            <div class="mb-3 d-flex align-items-end">
              <button type="submit" class="btn btn-primary me-2">
                <i class="bi bi-search"></i> Apply Filters
              </button>
              <a href="{{ url_for('system.installed_software') }}" class="btn btn-outline-secondary me-2">
                <i class="bi bi-x-circle"></i> Clear Filters
              </a>
              <button type="button" class="btn btn-success" onclick="exportResults()">
                <i class="bi bi-download"></i> Export
              </button>
            </div>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- Results -->
  <div class="card">
    <div class="card-header">
      <h3 class="card-title">
        <i class="bi bi-app-indicator"></i> Installed Software
        {% if software_list %}
        <span class="badge bg-info">{{ software_list|length }} results</span>
        {% if total_count and total_count > software_list|length %}
        <small class="text-muted">({{ total_count }} total)</small>
        {% endif %}
        {% endif %}
      </h3>
      <div class="card-tools">
        <div class="btn-group">
          <button type="button" class="btn btn-sm btn-outline-primary" onclick="toggleView('table')" id="table-view-btn">
            <i class="bi bi-table"></i> Table
          </button>
          <button type="button" class="btn btn-sm btn-outline-primary" onclick="toggleView('cards')" id="cards-view-btn">
            <i class="bi bi-grid-3x3-gap"></i> Cards
          </button>
        </div>
      </div>
    </div>
    <div class="card-body">
      {% if software_list %}

      <!-- Table View -->
      <div id="table-view" class="view-container">
        <div class="table-responsive">
          <table class="table table-striped" id="softwareTable">
            <thead>
              <tr>
                <th>Software Name</th>
                <th>Version</th>
                <th>Publisher</th>
                <th>Host</th>
                <th>Install Date</th>
                <th class="text-center">Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for software in software_list %}
              <tr>
                <td>
                  <a href="{{ url_for('system.software_detail', software_name=software.software_name) }}"
                     class="text-decoration-none">
                    <strong>{{ software.software_name }}</strong>
                  </a>
                </td>
                <td>
                  {% if software.version %}
                  <code>{{ software.version }}</code>
                  {% else %}
                  <span class="text-muted">Unknown</span>
                  {% endif %}
                </td>
                <td>
                  {% if software.publisher %}
                  <a href="{{ url_for('system.installed_software', publisher=software.publisher) }}"
                     class="text-decoration-none">
                    {{ software.publisher }}
                  </a>
                  {% else %}
                  <span class="text-muted">Unknown</span>
                  {% endif %}
                </td>
                <td>
                  <div>
                    <a href="{{ url_for('network.host_detail', ip_address=software.ip_address) }}"
                       class="text-decoration-none">
                      <strong>{{ software.ip_address }}</strong>
                    </a>
                    {% if software.hostname %}
                    <br><small class="text-muted">{{ software.hostname }}</small>
                    {% endif %}
                    {% if software.vendor %}
                    <br><small class="text-info">{{ software.vendor }}</small>
                    {% endif %}
                  </div>
                </td>
                <td>
                  {% if software.install_date %}
                  <small>{{ software.install_date[:10] }}</small>
                  {% else %}
                  <span class="text-muted">Unknown</span>
                  {% endif %}
                </td>
                <td class="text-center">
                  <div class="btn-group btn-group-sm">
                    <a href="{{ url_for('system.software_detail', software_name=software.software_name) }}"
                       class="btn btn-outline-primary" title="View Details">
                      <i class="bi bi-eye"></i>
                    </a>
                    <a href="{{ url_for('network.host_detail', ip_address=software.ip_address) }}"
                       class="btn btn-outline-info" title="View Host">
                      <i class="bi bi-pc-display"></i>
                    </a>
                  </div>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>

      <!-- Cards View -->
      <div id="cards-view" class="view-container" style="display: none;">
        <div class="row">
          {% for software in software_list %}
          <div class="col-md-6 col-lg-4 mb-3">
            <div class="card h-100">
              <div class="card-body">
                <h5 class="card-title">
                  <a href="{{ url_for('system.software_detail', software_name=software.software_name) }}"
                     class="text-decoration-none">
                    {{ software.software_name }}
                  </a>
                </h5>
                <div class="card-text">
                  <div class="mb-2">
                    <strong>Version:</strong>
                    {% if software.version %}
                    <code>{{ software.version }}</code>
                    {% else %}
                    <span class="text-muted">Unknown</span>
                    {% endif %}
                  </div>
                  <div class="mb-2">
                    <strong>Publisher:</strong>
                    {% if software.publisher %}
                    {{ software.publisher }}
                    {% else %}
                    <span class="text-muted">Unknown</span>
                    {% endif %}
                  </div>
                  <div class="mb-2">
                    <strong>Host:</strong>
                    <a href="{{ url_for('network.host_detail', ip_address=software.ip_address) }}"
                       class="text-decoration-none">
                      {{ software.ip_address }}
                    </a>
                    {% if software.hostname %}
                    <br><small class="text-muted">{{ software.hostname }}</small>
                    {% endif %}
                  </div>
                  {% if software.install_date %}
                  <div class="mb-2">
                    <strong>Installed:</strong>
                    <small>{{ software.install_date[:10] }}</small>
                  </div>
                  {% endif %}
                </div>
              </div>
              <div class="card-footer">
                <div class="btn-group btn-group-sm w-100">
                  <a href="{{ url_for('system.software_detail', software_name=software.software_name) }}"
                     class="btn btn-outline-primary">
                    <i class="bi bi-eye"></i> Details
                  </a>
                  <a href="{{ url_for('network.host_detail', ip_address=software.ip_address) }}"
                     class="btn btn-outline-info">
                    <i class="bi bi-pc-display"></i> Host
                  </a>
                </div>
              </div>
            </div>
          </div>
          {% endfor %}
        </div>
      </div>

      <!-- Pagination -->
      {% if pagination %}
      <nav aria-label="Software pagination" class="mt-4">
        <ul class="pagination justify-content-center">
          {% if pagination.has_prev %}
          <li class="page-item">
            <a class="page-link" href="{{ url_for('system.installed_software', page=pagination.prev_num, **request.args) }}">
              <i class="bi bi-chevron-left"></i> Previous
            </a>
          </li>
          {% endif %}

          {% for page_num in pagination.iter_pages() %}
            {% if page_num %}
              {% if page_num != pagination.page %}
              <li class="page-item">
                <a class="page-link" href="{{ url_for('system.installed_software', page=page_num, **request.args) }}">
                  {{ page_num }}
                </a>
              </li>
              {% else %}
              <li class="page-item active">
                <span class="page-link">{{ page_num }}</span>
              </li>
              {% endif %}
            {% else %}
            <li class="page-item disabled">
              <span class="page-link">...</span>
            </li>
            {% endif %}
          {% endfor %}

          {% if pagination.has_next %}
          <li class="page-item">
            <a class="page-link" href="{{ url_for('system.installed_software', page=pagination.next_num, **request.args) }}">
              Next <i class="bi bi-chevron-right"></i>
            </a>
          </li>
          {% endif %}
        </ul>
      </nav>
      {% endif %}

      {% else %}
      <div class="text-center py-5">
        <i class="bi bi-inbox display-1 text-muted"></i>
        <h4 class="text-muted mt-3">No Software Found</h4>
        <p class="text-muted">No installed software matches your current filters.</p>
        <a href="{{ url_for('system.installed_software') }}" class="btn btn-primary">
          <i class="bi bi-arrow-clockwise"></i> Reset Filters
        </a>
      </div>
      {% endif %}
    </div>
  </div>

  {% endif %}
</div>

<script>
function toggleView(viewType) {
  const tableView = document.getElementById('table-view');
  const cardsView = document.getElementById('cards-view');
  const tableBtn = document.getElementById('table-view-btn');
  const cardsBtn = document.getElementById('cards-view-btn');

  if (viewType === 'table') {
    tableView.style.display = 'block';
    cardsView.style.display = 'none';
    tableBtn.classList.add('active');
    cardsBtn.classList.remove('active');
  } else {
    tableView.style.display = 'none';
    cardsView.style.display = 'block';
    tableBtn.classList.remove('active');
    cardsBtn.classList.add('active');
  }

  // Save preference
  localStorage.setItem('software-view-preference', viewType);
}

function exportResults() {
  const params = new URLSearchParams(window.location.search);
  params.set('format', 'csv');
  window.location.href = '{{ url_for("system.api_software") }}?' + params.toString();
}

// Load saved view preference
document.addEventListener('DOMContentLoaded', function() {
  const savedView = localStorage.getItem('software-view-preference') || 'table';
  toggleView(savedView);
});
</script>
{% endblock %}