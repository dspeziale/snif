{% extends "base.html" %}

{% block title %}Scan Manager - Nmap Scanner{% endblock %}
{% block page_title %}Gestione Scan{% endblock %}

{% block breadcrumbs %}
<li class="breadcrumb-item"><a href="{{ url_for('index') }}">Home</a></li>
<li class="breadcrumb-item"><a href="{{ url_for('network.dashboard') }}">Network</a></li>
<li class="breadcrumb-item active" aria-current="page">Scan</li>
{% endblock %}

{% block extra_css %}
<!-- DataTables -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/datatables.net-bs5@1.13.6/css/dataTables.bootstrap5.min.css">
{% endblock %}

{% block content %}
<!-- Statistiche rapide -->
<div class="row mb-4">
  <div class="col-lg-3 col-6">
    <div class="small-box bg-info">
      <div class="inner">
        <h3>{{ total }}</h3>
        <p>Scan Totali</p>
      </div>
      <div class="icon">
        <i class="bi bi-file-text"></i>
      </div>
      <a href="#" class="small-box-footer">
        <i class="bi bi-arrow-clockwise"></i>
      </a>
    </div>
  </div>

  <div class="col-lg-3 col-6">
    <div class="small-box bg-success">
      <div class="inner">
        <h3>{{ scans | selectattr('host_count', 'greaterthan', 0) | list | length }}</h3>
        <p>Scan con Host</p>
      </div>
      <div class="icon">
        <i class="bi bi-pc-display"></i>
      </div>
      <a href="{{ url_for('network.hosts') }}" class="small-box-footer">
        Vedi Host <i class="bi bi-arrow-right"></i>
      </a>
    </div>
  </div>

  <div class="col-lg-3 col-6">
    <div class="small-box bg-warning">
      <div class="inner">
        <h3>{{ scans | map(attribute='active_hosts') | sum }}</h3>
        <p>Host Attivi</p>
      </div>
      <div class="icon">
        <i class="bi bi-wifi"></i>
      </div>
      <a href="{{ url_for('network.hosts') }}?status=up" class="small-box-footer">
        Vedi Attivi <i class="bi bi-arrow-right"></i>
      </a>
    </div>
  </div>

  <div class="col-lg-3 col-6">
    <div class="small-box bg-danger">
      <div class="inner">
        <h3>{{ (scans | map(attribute='host_count') | sum) - (scans | map(attribute='active_hosts') | sum) }}</h3>
        <p>Host Inattivi</p>
      </div>
      <div class="icon">
        <i class="bi bi-x-circle"></i>
      </div>
      <a href="{{ url_for('network.hosts') }}?status=down" class="small-box-footer">
        Vedi Inattivi <i class="bi bi-arrow-right"></i>
      </a>
    </div>
  </div>
</div>

<!-- Filtri e azioni -->
<div class="row mb-3">
  <div class="col-12">
    <div class="card">
      <div class="card-header">
        <h3 class="card-title">
          <i class="bi bi-funnel me-1"></i>
          Filtri e Azioni
        </h3>
        <div class="card-tools">
          <button type="button" class="btn btn-tool" data-lte-toggle="card-collapse">
            <i data-lte-icon="expand" class="bi bi-plus-lg"></i>
            <i data-lte-icon="collapse" class="bi bi-dash-lg"></i>
          </button>
        </div>
      </div>
      <div class="card-body">
        <div class="row">
          <div class="col-md-6">
            <div class="input-group">
              <input type="text" class="form-control" id="searchInput" placeholder="Cerca per filename, scanner, argomenti...">
              <button class="btn btn-outline-secondary" type="button" id="searchBtn">
                <i class="bi bi-search"></i>
              </button>
            </div>
          </div>
          <div class="col-md-6">
            <div class="btn-group" role="group">
              <a href="{{ url_for('forms') }}" class="btn btn-primary">
                <i class="bi bi-upload me-1"></i>
                Carica Nuovo Scan
              </a>
              <button type="button" class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">
                <i class="bi bi-download"></i>
                Export
              </button>
              <ul class="dropdown-menu">
                <li><a class="dropdown-item" href="#" onclick="exportToCSV()">
                  <i class="bi bi-filetype-csv me-1"></i>CSV
                </a></li>
                <li><a class="dropdown-item" href="#" onclick="exportToJSON()">
                  <i class="bi bi-filetype-json me-1"></i>JSON
                </a></li>
              </ul>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Lista scan -->
<div class="row">
  <div class="col-12">
    <div class="card">
      <div class="card-header">
        <h3 class="card-title">
          <i class="bi bi-list me-1"></i>
          Lista Scan Nmap
        </h3>
        <div class="card-tools">
          <span class="badge bg-info">{{ total }} scan</span>
        </div>
      </div>
      <div class="card-body table-responsive p-0">
        {% if scans %}
        <table class="table table-striped table-hover" id="scansTable">
          <thead>
            <tr>
              <th><i class="bi bi-file-text me-1"></i>File</th>
              <th><i class="bi bi-gear me-1"></i>Scanner</th>
              <th><i class="bi bi-calendar me-1"></i>Data/Ora</th>
              <th><i class="bi bi-stopwatch me-1"></i>Durata</th>
              <th><i class="bi bi-pc-display me-1"></i>Host</th>
              <th><i class="bi bi-terminal me-1"></i>Argomenti</th>
              <th><i class="bi bi-three-dots me-1"></i>Azioni</th>
            </tr>
          </thead>
          <tbody>
            {% for scan in scans %}
            <tr>
              <td>
                <div class="d-flex align-items-center">
                  <div class="file-icon me-2">
                    {% if scan.filename %}
                    <i class="bi bi-file-earmark-text text-primary"></i>
                    {% else %}
                    <i class="bi bi-file-x text-muted"></i>
                    {% endif %}
                  </div>
                  <div>
                    <strong>{{ scan.filename or 'N/A' }}</strong>
                    {% if scan.file_size %}
                    <br><small class="text-muted">{{ (scan.file_size / 1024) | round(1) }} KB</small>
                    {% endif %}
                  </div>
                </div>
              </td>
              <td>
                <span class="badge bg-secondary">{{ scan.scanner or 'N/A' }}</span>
                {% if scan.version %}
                <br><small class="text-muted">v{{ scan.version }}</small>
                {% endif %}
              </td>
              <td>
                {% if scan.start_time %}
                <div>
                  <strong>{{ scan.start_time | timestamp }}</strong>
                  {% if scan.end_time %}
                  <br><small class="text-muted">Fine: {{ scan.end_time | timestamp }}</small>
                  {% endif %}
                </div>
                {% else %}
                <span class="text-muted">N/A</span>
                {% endif %}
              </td>
              <td>
                {% if scan.start_time and scan.end_time %}
                {% set duration = scan.end_time - scan.start_time %}
                {% if duration > 3600 %}
                <span class="badge bg-warning">{{ (duration / 3600) | round(1) }}h</span>
                {% elif duration > 60 %}
                <span class="badge bg-info">{{ (duration / 60) | round(1) }}m</span>
                {% else %}
                <span class="badge bg-success">{{ duration }}s</span>
                {% endif %}
                {% else %}
                <span class="text-muted">N/A</span>
                {% endif %}
              </td>
              <td>
                <div class="host-stats">
                  <div>
                    <span class="badge bg-primary">{{ scan.host_count or 0 }}</span>
                    <small class="text-muted">totali</small>
                  </div>
                  {% if scan.active_hosts %}
                  <div>
                    <span class="badge bg-success">{{ scan.active_hosts }}</span>
                    <small class="text-muted">attivi</small>
                  </div>
                  {% endif %}
                </div>
              </td>
              <td>
                {% if scan.args %}
                <code class="small text-break" style="max-width: 200px; display: inline-block;">
                  {{ scan.args | truncate(50) }}
                </code>
                {% if scan.args | length > 50 %}
                <button class="btn btn-link btn-sm p-0" onclick="showFullArgs('{{ scan.args | e }}')">
                  <i class="bi bi-three-dots"></i>
                </button>
                {% endif %}
                {% else %}
                <span class="text-muted">N/A</span>
                {% endif %}
              </td>
              <td>
                <div class="btn-group btn-group-sm">
                  <a href="{{ url_for('network.scan_detail', scan_id=scan.id) }}"
                     class="btn btn-outline-primary btn-sm" title="Vedi dettagli">
                    <i class="bi bi-eye"></i>
                  </a>
                  <button type="button" class="btn btn-outline-info btn-sm"
                          onclick="showScanInfo({{ scan.id }})" title="Info rapide">
                    <i class="bi bi-info-circle"></i>
                  </button>
                  <div class="btn-group btn-group-sm">
                    <button type="button" class="btn btn-outline-secondary btn-sm dropdown-toggle"
                            data-bs-toggle="dropdown" title="Più azioni">
                      <i class="bi bi-three-dots"></i>
                    </button>
                    <ul class="dropdown-menu">
                      <li><a class="dropdown-item" href="{{ url_for('network.hosts') }}?scan_id={{ scan.id }}">
                        <i class="bi bi-pc-display me-1"></i>Vedi Host
                      </a></li>
                      <li><a class="dropdown-item" href="{{ url_for('network.ports') }}?scan_id={{ scan.id }}">
                        <i class="bi bi-door-open me-1"></i>Vedi Porte
                      </a></li>
                      <li><hr class="dropdown-divider"></li>
                      <li><a class="dropdown-item" href="#" onclick="downloadScanData({{ scan.id }})">
                        <i class="bi bi-download me-1"></i>Download Dati
                      </a></li>
                      <li><a class="dropdown-item text-danger" href="#" onclick="deleteScan({{ scan.id }})">
                        <i class="bi bi-trash me-1"></i>Elimina
                      </a></li>
                    </ul>
                  </div>
                </div>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
        {% else %}
        <!-- Nessun scan -->
        <div class="text-center py-5">
          <i class="bi bi-file-text display-1 text-muted"></i>
          <h4 class="mt-3">Nessun scan trovato</h4>
          <p class="text-muted">
            Non sono stati caricati scan Nmap nel sistema.
          </p>
          <div class="mt-3">
            <a href="{{ url_for('forms') }}" class="btn btn-primary">
              <i class="bi bi-upload me-1"></i>
              Carica il Primo Scan
            </a>
            <a href="{{ url_for('network.dashboard') }}" class="btn btn-secondary">
              <i class="bi bi-arrow-left me-1"></i>
              Torna alla Dashboard
            </a>
          </div>
        </div>
        {% endif %}
      </div>

      {% if total_pages > 1 %}
      <!-- Paginazione -->
      <div class="card-footer clearfix">
        <ul class="pagination pagination-sm m-0 float-right">
          {% if page > 1 %}
          <li class="page-item">
            <a class="page-link" href="{{ url_for('network.scans', page=page-1, per_page=per_page) }}">
              <i class="bi bi-chevron-left"></i>
            </a>
          </li>
          {% endif %}

          {% for p in range(1, total_pages + 1) %}
          {% if p == page %}
          <li class="page-item active">
            <span class="page-link">{{ p }}</span>
          </li>
          {% elif p <= 3 or p >= total_pages - 2 or (p >= page - 1 and p <= page + 1) %}
          <li class="page-item">
            <a class="page-link" href="{{ url_for('network.scans', page=p, per_page=per_page) }}">{{ p }}</a>
          </li>
          {% elif p == 4 and page > 6 %}
          <li class="page-item disabled">
            <span class="page-link">...</span>
          </li>
          {% elif p == total_pages - 3 and page < total_pages - 5 %}
          <li class="page-item disabled">
            <span class="page-link">...</span>
          </li>
          {% endif %}
          {% endfor %}

          {% if page < total_pages %}
          <li class="page-item">
            <a class="page-link" href="{{ url_for('network.scans', page=page+1, per_page=per_page) }}">
              <i class="bi bi-chevron-right"></i>
            </a>
          </li>
          {% endif %}
        </ul>

        <div class="float-left">
          Mostrando {{ ((page-1) * per_page + 1) if scans else 0 }} -
          {{ (page * per_page) if (page * per_page) < total else total }}
          di {{ total }} scan
        </div>
      </div>
      {% endif %}
    </div>
  </div>
</div>

<!-- Modal per info scan rapide -->
<div class="modal fade" id="scanInfoModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="bi bi-info-circle me-1"></i>
          Informazioni Scan
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="scanInfoContent">
        <div class="text-center">
          <div class="spinner-border" role="status">
            <span class="visually-hidden">Caricamento...</span>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Chiudi</button>
        <button type="button" class="btn btn-primary" id="viewScanDetail">Vedi Dettagli Completi</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal per argomenti completi -->
<div class="modal fade" id="argsModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="bi bi-terminal me-1"></i>
          Argomenti Scan Completi
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <pre class="bg-dark text-light p-3 rounded" id="fullArgsContent"></pre>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Chiudi</button>
        <button type="button" class="btn btn-outline-primary" onclick="copyToClipboard()">
          <i class="bi bi-clipboard me-1"></i>Copia
        </button>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block extra_js %}
<!-- DataTables -->
<script src="https://cdn.jsdelivr.net/npm/datatables.net@1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/datatables.net-bs5@1.13.6/js/dataTables.bootstrap5.min.js"></script>

<script>
// Inizializza DataTables
$(document).ready(function() {
    if ($('#scansTable tbody tr').length > 0) {
        $('#scansTable').DataTable({
            "pageLength": {{ per_page }},
            "searching": false,
            "ordering": true,
            "info": false,
            "lengthChange": false,
            "paging": false,
            "order": [[2, "desc"]], // Ordina per data
            "columnDefs": [
                {"orderable": false, "targets": [6]} // Disabilita ordinamento per azioni
            ]
        });
    }
});

// Ricerca
$('#searchBtn').click(function() {
    const searchTerm = $('#searchInput').val();
    if (searchTerm) {
        window.location.href = "{{ url_for('network.scans') }}?search=" + encodeURIComponent(searchTerm);
    }
});

$('#searchInput').keypress(function(e) {
    if (e.which == 13) { // Enter
        $('#searchBtn').click();
    }
});

// Mostra info scan rapide
function showScanInfo(scanId) {
    $('#scanInfoModal').modal('show');

    fetch(`/api/scan/${scanId}`)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                $('#scanInfoContent').html(`
                    <div class="alert alert-danger">
                        <i class="bi bi-exclamation-triangle me-1"></i>
                        Errore: ${data.error}
                    </div>
                `);
                return;
            }

            const scan = data.scan;
            const hosts = data.hosts || [];

            $('#scanInfoContent').html(`
                <div class="row">
                    <div class="col-md-6">
                        <h6><i class="bi bi-file-text me-1"></i>Informazioni File</h6>
                        <dl class="row">
                            <dt class="col-4">File:</dt>
                            <dd class="col-8">${scan.filename || 'N/A'}</dd>
                            <dt class="col-4">Scanner:</dt>
                            <dd class="col-8">${scan.scanner || 'N/A'} ${scan.version || ''}</dd>
                            <dt class="col-4">Data:</dt>
                            <dd class="col-8">${scan.start_time ? new Date(scan.start_time * 1000).toLocaleString() : 'N/A'}</dd>
                        </dl>
                    </div>
                    <div class="col-md-6">
                        <h6><i class="bi bi-bar-chart me-1"></i>Statistiche</h6>
                        <dl class="row">
                            <dt class="col-4">Host totali:</dt>
                            <dd class="col-8"><span class="badge bg-primary">${hosts.length}</span></dd>
                            <dt class="col-4">Host attivi:</dt>
                            <dd class="col-8"><span class="badge bg-success">${hosts.filter(h => h.status_state === 'up').length}</span></dd>
                            <dt class="col-4">Porte totali:</dt>
                            <dd class="col-8"><span class="badge bg-info">${hosts.reduce((sum, h) => sum + (h.port_count || 0), 0)}</span></dd>
                        </dl>
                    </div>
                </div>
                ${scan.args ? `
                <div class="mt-3">
                    <h6><i class="bi bi-terminal me-1"></i>Argomenti</h6>
                    <code class="d-block bg-light p-2 rounded">${scan.args}</code>
                </div>
                ` : ''}
            `);

            $('#viewScanDetail').off('click').on('click', function() {
                window.location.href = `/network/scan/${scanId}`;
            });
        })
        .catch(error => {
            $('#scanInfoContent').html(`
                <div class="alert alert-danger">
                    <i class="bi bi-exclamation-triangle me-1"></i>
                    Errore nel caricamento: ${error.message}
                </div>
            `);
        });
}

// Mostra argomenti completi
function showFullArgs(args) {
    $('#fullArgsContent').text(args);
    $('#argsModal').modal('show');
}

// Copia negli appunti
function copyToClipboard() {
    const text = $('#fullArgsContent').text();
    navigator.clipboard.writeText(text).then(function() {
        // Feedback visivo
        const btn = event.target;
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="bi bi-check me-1"></i>Copiato!';
        btn.classList.add('btn-success');
        btn.classList.remove('btn-outline-primary');

        setTimeout(() => {
            btn.innerHTML = originalText;
            btn.classList.remove('btn-success');
            btn.classList.add('btn-outline-primary');
        }, 2000);
    });
}

// Elimina scan
function deleteScan(scanId) {
    if (confirm('Sei sicuro di voler eliminare questo scan? Questa azione non può essere annullata.')) {
        fetch(`/api/scan/${scanId}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Errore nell\'eliminazione: ' + (data.error || 'Errore sconosciuto'));
            }
        })
        .catch(error => {
            alert('Errore nell\'eliminazione: ' + error.message);
        });
    }
}

// Download dati scan
function downloadScanData(scanId) {
    window.open(`/api/scan/${scanId}/export`, '_blank');
}

// Export functions
function exportToCSV() {
    window.location.href = '{{ url_for("network.scans") }}?export=csv';
}

function exportToJSON() {
    window.location.href = '{{ url_for("network.scans") }}?export=json';
}
</script>
{% endblock %}