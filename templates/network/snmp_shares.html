{% extends "base.html" %}

{% block title %}Condivisioni SNMP - Nmap Scanner{% endblock %}
{% block page_title %}Condivisioni di Rete SNMP{% endblock %}

{% block breadcrumbs %}
<li class="breadcrumb-item"><a href="{{ url_for('index') }}">Home</a></li>
<li class="breadcrumb-item"><a href="{{ url_for('network.dashboard') }}">Network</a></li>
<li class="breadcrumb-item"><a href="{{ url_for('network.snmp_dashboard') }}">SNMP</a></li>
<li class="breadcrumb-item active" aria-current="page">Condivisioni</li>
{% endblock %}

{% block content %}
<!-- Filtri di ricerca -->
<div class="row mb-3">
  <div class="col-12">
    <div class="card">
      <div class="card-header">
        <h3 class="card-title">
          <i class="bi bi-funnel me-1"></i>
          Filtri di Ricerca
        </h3>
      </div>
      <div class="card-body">
        <form method="GET" action="{{ url_for('network.snmp_shares') }}">
          <div class="row g-3">
            <div class="col-md-6">
              <label for="search" class="form-label">Ricerca</label>
              <input type="text" class="form-control" id="search" name="search"
                     value="{{ search }}" placeholder="Nome condivisione, percorso o IP host...">
            </div>
            <div class="col-md-3 d-flex align-items-end">
              <button type="submit" class="btn btn-primary me-2">
                <i class="bi bi-search"></i> Cerca
              </button>
              <a href="{{ url_for('network.snmp_shares') }}" class="btn btn-secondary">
                <i class="bi bi-x-circle"></i> Reset
              </a>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Statistiche rapide -->
<div class="row mb-3">
  <div class="col-md-3">
    <div class="info-box">
      <span class="info-box-icon bg-info">
        <i class="bi bi-folder-shared"></i>
      </span>
      <div class="info-box-content">
        <span class="info-box-text">Condivisioni Totali</span>
        <span class="info-box-number">{{ total | default(0) }}</span>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="info-box">
      <span class="info-box-icon bg-success">
        <i class="bi bi-pc-display"></i>
      </span>
      <div class="info-box-content">
        <span class="info-box-text">Host con Shares</span>
        <span class="info-box-number">
          {{ shares | map(attribute='ip_address') | unique | list | length | default(0) }}
        </span>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="info-box">
      <span class="info-box-icon bg-warning">
        <i class="bi bi-folder"></i>
      </span>
      <div class="info-box-content">
        <span class="info-box-text">Condivisioni Sistema</span>
        <span class="info-box-number">
          {% set system_count = 0 %}
          {% for share in shares %}
            {% if share.share_name and '$' in share.share_name %}
              {% set system_count = system_count + 1 %}
            {% endif %}
          {% endfor %}
          {{ system_count }}
        </span>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="info-box">
      <span class="info-box-icon bg-danger">
        <i class="bi bi-shield-exclamation"></i>
      </span>
      <div class="info-box-content">
        <span class="info-box-text">Share Amministrative</span>
        <span class="info-box-number">
          {% set admin_count = 0 %}
          {% for share in shares %}
            {% if share.share_name and (share.share_name.endswith('$') or 'ADMIN' in share.share_name.upper()) %}
              {% set admin_count = admin_count + 1 %}
            {% endif %}
          {% endfor %}
          {{ admin_count }}
        </span>
      </div>
    </div>
  </div>
</div>

<!-- Tabella condivisioni -->
<div class="row">
  <div class="col-12">
    <div class="card">
      <div class="card-header">
        <h3 class="card-title">
          <i class="bi bi-folder-shared me-1"></i>
          Condivisioni di Rete
        </h3>
        <div class="card-tools">
          <div class="btn-group btn-group-sm">
            <button type="button" class="btn btn-outline-primary dropdown-toggle" data-bs-toggle="dropdown">
              <i class="bi bi-download"></i> Export
            </button>
            <ul class="dropdown-menu">
              <li><a class="dropdown-item" href="#" onclick="exportToCSV()">
                <i class="bi bi-filetype-csv me-1"></i>CSV
              </a></li>
              <li><a class="dropdown-item" href="#" onclick="exportToJSON()">
                <i class="bi bi-filetype-json me-1"></i>JSON
              </a></li>
            </ul>
          </div>
        </div>
      </div>
      <div class="card-body p-0">
        {% if shares %}
        <div class="table-responsive">
          <table class="table table-striped table-hover mb-0">
            <thead class="table-dark">
              <tr>
                <th>Host</th>
                <th>Nome Condivisione</th>
                <th>Percorso</th>
                <th>Tipo</th>
                <th>Descrizione</th>
                <th>Connessioni</th>
                <th class="text-center">Azioni</th>
              </tr>
            </thead>
            <tbody>
              {% for share in shares %}
              <tr>
                <td>
                  <a href="{{ url_for('network.host_detail', host_id=share.host_id) }}"
                     class="text-decoration-none">
                    <i class="bi bi-pc-display me-1"></i>
                    {{ share.ip_address }}
                  </a>
                </td>
                <td>
                  <div class="d-flex align-items-center">
                    {% if share.share_name and '$' in share.share_name %}
                    <i class="bi bi-shield-lock me-1 text-warning"></i>
                    {% else %}
                    <i class="bi bi-folder-shared me-1"></i>
                    {% endif %}
                    <strong>{{ share.share_name | default('N/A') }}</strong>
                    {% if share.share_name and '$' in share.share_name %}
                    <span class="badge bg-warning ms-2" title="Condivisione di Sistema">SYS</span>
                    {% endif %}
                  </div>
                </td>
                <td>
                  {% if share.share_path %}
                  <code class="text-break">{{ share.share_path }}</code>
                  {% else %}
                  <span class="text-muted">N/A</span>
                  {% endif %}
                </td>
                <td>
                  {% if share.share_type %}
                  <span class="badge {% if share.share_type == 'DISK' %}bg-primary{% elif share.share_type == 'PRINTER' %}bg-success{% elif share.share_type == 'DEVICE' %}bg-info{% else %}bg-secondary{% endif %}">
                    {{ share.share_type }}
                  </span>
                  {% else %}
                  <span class="text-muted">N/A</span>
                  {% endif %}
                </td>
                <td class="text-break" style="max-width: 250px;">
                  {% if share.share_description %}
                  <small>{{ share.share_description[:80] }}{% if share.share_description|length > 80 %}...{% endif %}</small>
                  {% else %}
                  <span class="text-muted">Nessuna descrizione</span>
                  {% endif %}
                </td>
                <td class="text-center">
                  {% if share.current_connections is defined and share.current_connections is not none %}
                  <span class="badge {% if share.current_connections > 0 %}bg-success{% else %}bg-secondary{% endif %}">
                    {{ share.current_connections }}
                  </span>
                  {% else %}
                  <span class="text-muted">N/A</span>
                  {% endif %}
                </td>
                <td class="text-center">
                  <div class="btn-group btn-group-sm">
                    <a href="{{ url_for('network.host_snmp_detail', host_id=share.host_id) }}"
                       class="btn btn-outline-primary btn-sm" title="Dettagli SNMP Host">
                      <i class="bi bi-info-circle"></i>
                    </a>
                    <button class="btn btn-outline-secondary btn-sm" title="Copia Path UNC"
                            onclick="copyUNCPath('{{ share.ip_address }}', '{{ share.share_name }}')">
                      <i class="bi bi-clipboard"></i>
                    </button>
                  </div>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        {% else %}
        <div class="text-center py-5">
          <i class="bi bi-folder-shared display-1 text-muted"></i>
          <h4 class="mt-3">Nessuna condivisione trovata</h4>
          <p class="text-muted">
            {% if search %}
              Nessuna condivisione corrisponde ai criteri di ricerca "{{ search }}".
            {% else %}
              Non sono state trovate condivisioni di rete SNMP nel database.
            {% endif %}
          </p>
          <div class="mt-3">
            <a href="{{ url_for('network.snmp_dashboard') }}" class="btn btn-primary">
              <i class="bi bi-arrow-left me-1"></i>
              Torna alla Dashboard SNMP
            </a>
            {% if search %}
            <a href="{{ url_for('network.snmp_shares') }}" class="btn btn-outline-secondary ms-2">
              <i class="bi bi-x-circle me-1"></i>
              Rimuovi Filtri
            </a>
            {% endif %}
          </div>
        </div>
        {% endif %}
      </div>

      <!-- Paginazione -->
      {% if total_pages > 1 %}
      <div class="card-footer clearfix">
        <div class="float-start">
          <small class="text-muted">
            Mostra da {{ (page-1) * 25 + 1 }} a {{ [page * 25, total]|min }} di {{ total }} condivisioni
          </small>
        </div>
        <nav class="float-end">
          <ul class="pagination pagination-sm m-0">
            {% if page > 1 %}
            <li class="page-item">
              <a class="page-link" href="{{ url_for('network.snmp_shares', page=page-1, search=search) }}">
                <i class="bi bi-chevron-left"></i>
              </a>
            </li>
            {% endif %}

            {% for p in range(1, total_pages + 1) %}
            {% if p == page %}
            <li class="page-item active">
              <span class="page-link">{{ p }}</span>
            </li>
            {% elif p <= 3 or p >= total_pages - 2 or (p >= page - 1 and p <= page + 1) %}
            <li class="page-item">
              <a class="page-link" href="{{ url_for('network.snmp_shares', page=p, search=search) }}">{{ p }}</a>
            </li>
            {% elif p == 4 and page > 6 %}
            <li class="page-item disabled">
              <span class="page-link">...</span>
            </li>
            {% elif p == total_pages - 3 and page < total_pages - 5 %}
            <li class="page-item disabled">
              <span class="page-link">...</span>
            </li>
            {% endif %}
            {% endfor %}

            {% if page < total_pages %}
            <li class="page-item">
              <a class="page-link" href="{{ url_for('network.snmp_shares', page=page+1, search=search) }}">
                <i class="bi bi-chevron-right"></i>
              </a>
            </li>
            {% endif %}
          </ul>
        </nav>
      </div>
      {% endif %}
    </div>
  </div>
</div>

<!-- Toast container -->
<div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 9999;">
  <div id="copyToast" class="toast align-items-center text-bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="d-flex">
      <div class="toast-body">
        Path UNC copiato negli appunti!
      </div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Copia path UNC negli appunti
function copyUNCPath(ipAddress, shareName) {
    if (!shareName || shareName === 'N/A') {
        alert('Nome condivisione non valido');
        return;
    }

    const uncPath = '\\\\' + ipAddress + '\\' + shareName;

    if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(uncPath).then(function() {
            showCopySuccess(uncPath);
        }).catch(function(err) {
            console.error('Errore nella copia:', err);
            fallbackCopy(uncPath);
        });
    } else {
        fallbackCopy(uncPath);
    }
}

// Fallback per browser che non supportano clipboard API
function fallbackCopy(text) {
    const textArea = document.createElement('textarea');
    textArea.value = text;
    textArea.style.position = 'fixed';
    textArea.style.left = '-999999px';
    textArea.style.top = '-999999px';
    document.body.appendChild(textArea);
    textArea.focus();
    textArea.select();

    try {
        const result = document.execCommand('copy');
        if (result) {
            showCopySuccess(text);
        } else {
            showCopyError();
        }
    } catch (err) {
        console.error('Fallback copy failed:', err);
        showCopyError();
    }

    document.body.removeChild(textArea);
}

// Mostra toast di successo
function showCopySuccess(path) {
    const toastEl = document.getElementById('copyToast');
    const toastBody = toastEl.querySelector('.toast-body');
    toastBody.textContent = 'Copiato: ' + path;

    const toast = new bootstrap.Toast(toastEl);
    toast.show();

    // Feedback visivo sul pulsante
    const btn = event.target.closest('button');
    if (btn) {
        const originalHTML = btn.innerHTML;
        btn.innerHTML = '<i class="bi bi-check"></i>';
        btn.classList.remove('btn-outline-secondary');
        btn.classList.add('btn-success');

        setTimeout(() => {
            btn.innerHTML = originalHTML;
            btn.classList.remove('btn-success');
            btn.classList.add('btn-outline-secondary');
        }, 2000);
    }
}

// Mostra errore nella copia
function showCopyError() {
    alert('Errore nella copia del path UNC. Prova a selezionare manualmente il testo.');
}

// Export functions
function exportToCSV() {
    const params = new URLSearchParams(window.location.search);
    params.set('export', 'csv');
    window.location.href = '{{ url_for("network.snmp_shares") }}?' + params.toString();
}

function exportToJSON() {
    const params = new URLSearchParams(window.location.search);
    params.set('export', 'json');
    window.location.href = '{{ url_for("network.snmp_shares") }}?' + params.toString();
}

// Inizializzazione
document.addEventListener('DOMContentLoaded', function() {
    // Auto-focus sul campo di ricerca
    const searchField = document.getElementById('search');
    if (searchField) {
        searchField.focus();
    }

    // Tooltip per elementi con title
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
});
</script>
{% endblock %}