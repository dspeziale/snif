{% extends "base.html" %}

{% block title %}Network Ports - AdminLTE{% endblock %}
{% block page_title %}Network Ports{% endblock %}

{% block breadcrumbs %}
<li class="breadcrumb-item"><a href="{{ url_for('index') }}">Home</a></li>
<li class="breadcrumb-item"><a href="{{ url_for('network.overview') }}">Network</a></li>
<li class="breadcrumb-item active">Ports</li>
{% endblock %}

{% block content %}
<div class="container-fluid">
  <!-- Filtri -->
  <div class="row mb-3">
    <div class="col-12">
      <div class="card">
        <div class="card-header">
          <h3 class="card-title">
            <i class="bi bi-funnel"></i> Filtri
          </h3>
          <div class="card-tools">
            <button type="button" class="btn btn-tool" data-card-widget="collapse">
              <i class="fas fa-minus"></i>
            </button>
          </div>
        </div>
        <div class="card-body">
          <form method="GET" class="row g-3">
            <div class="col-md-2">
              <label for="state" class="form-label">State</label>
              <select class="form-select" id="state" name="state">
                <option value="">All States</option>
                <option value="open" {% if request.args.get('state') == 'open' %}selected{% endif %}>Open</option>
                <option value="closed" {% if request.args.get('state') == 'closed' %}selected{% endif %}>Closed</option>
                <option value="filtered" {% if request.args.get('state') == 'filtered' %}selected{% endif %}>Filtered</option>
              </select>
            </div>
            <div class="col-md-2">
              <label for="port_number" class="form-label">Port Number</label>
              <input type="number" class="form-control" id="port_number" name="port_number"
                     value="{{ request.args.get('port_number', '') }}" placeholder="80, 443...">
            </div>
            <div class="col-md-2">
              <label for="protocol" class="form-label">Protocol</label>
              <select class="form-select" id="protocol" name="protocol">
                <option value="">All Protocols</option>
                <option value="tcp" {% if request.args.get('protocol') == 'tcp' %}selected{% endif %}>TCP</option>
                <option value="udp" {% if request.args.get('protocol') == 'udp' %}selected{% endif %}>UDP</option>
              </select>
            </div>
            <div class="col-md-2">
              <label for="service" class="form-label">Service</label>
              <input type="text" class="form-control" id="service" name="service"
                     value="{{ request.args.get('service', '') }}" placeholder="http, ssh...">
            </div>
            <div class="col-md-2">
              <label for="host_ip" class="form-label">Host IP</label>
              <input type="text" class="form-control" id="host_ip" name="host_ip"
                     value="{{ request.args.get('host_ip', '') }}" placeholder="192.168.1.1">
            </div>
            <div class="col-md-2">
              <label for="per_page" class="form-label">Per Page</label>
              <select class="form-select" id="per_page" name="per_page">
                <option value="50" {% if request.args.get('per_page', '50') == '50' %}selected{% endif %}>50</option>
                <option value="100" {% if request.args.get('per_page') == '100' %}selected{% endif %}>100</option>
                <option value="200" {% if request.args.get('per_page') == '200' %}selected{% endif %}>200</option>
              </select>
            </div>
            <div class="col-12">
              <button type="submit" class="btn btn-primary">
                <i class="bi bi-search"></i> Filter
              </button>
              <a href="{{ url_for('network.ports') }}" class="btn btn-secondary">
                <i class="bi bi-arrow-clockwise"></i> Reset
              </a>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Statistics -->
  <div class="row mb-3">
    <div class="col-lg-3 col-6">
      <div class="small-box bg-success">
        <div class="inner">
          <h3>{{ stats.open_ports if stats else 0 }}</h3>
          <p>Open Ports</p>
        </div>
        <div class="icon">
          <i class="bi bi-door-open"></i>
        </div>
      </div>
    </div>
    <div class="col-lg-3 col-6">
      <div class="small-box bg-danger">
        <div class="inner">
          <h3>{{ stats.closed_ports if stats else 0 }}</h3>
          <p>Closed Ports</p>
        </div>
        <div class="icon">
          <i class="bi bi-door-closed"></i>
        </div>
      </div>
    </div>
    <div class="col-lg-3 col-6">
      <div class="small-box bg-warning">
        <div class="inner">
          <h3>{{ stats.filtered_ports if stats else 0 }}</h3>
          <p>Filtered Ports</p>
        </div>
        <div class="icon">
          <i class="bi bi-shield"></i>
        </div>
      </div>
    </div>
    <div class="col-lg-3 col-6">
      <div class="small-box bg-info">
        <div class="inner">
          <h3>{{ total_count if total_count is defined else 0 }}</h3>
          <p>Total Scanned</p>
        </div>
        <div class="icon">
          <i class="bi bi-diagram-3"></i>
        </div>
      </div>
    </div>
  </div>

  <!-- Ports List -->
  <div class="row">
    <div class="col-12">
      <div class="card">
        <div class="card-header">
          <h3 class="card-title">
            <i class="bi bi-list"></i> Ports List
            <span class="badge bg-secondary ms-2">{{ total_count if total_count is defined else 0 }} ports</span>
          </h3>
          <div class="card-tools">
            <div class="btn-group">
              <button type="button" class="btn btn-sm btn-primary dropdown-toggle" data-bs-toggle="dropdown">
                <i class="bi bi-download"></i> Export
              </button>
              <ul class="dropdown-menu">
                <li><a class="dropdown-item" href="#" onclick="exportPorts('csv')">CSV</a></li>
                <li><a class="dropdown-item" href="#" onclick="exportPorts('json')">JSON</a></li>
              </ul>
            </div>
          </div>
        </div>
        <div class="card-body table-responsive p-0">
          {% if error %}
          <div class="alert alert-danger m-3">
            <i class="bi bi-exclamation-triangle"></i> Error: {{ error }}
          </div>
          {% elif not ports %}
          <div class="alert alert-info m-3">
            <i class="bi bi-info-circle"></i> No ports found with the specified filters.
          </div>
          {% else %}
          <table class="table table-hover text-nowrap">
            <thead>
              <tr>
                <th>Host</th>
                <th>Port</th>
                <th>Protocol</th>
                <th>State</th>
                <th>Service</th>
                <th>Version</th>
                <th>Reason</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for port in ports %}
              <tr>
                <td>
                  <div>
                    <a href="{{ url_for('network.host_detail', ip_address=port.ip_address) }}"
                       class="text-decoration-none">
                      <strong>{{ port.ip_address }}</strong>
                    </a>
                    {% if port.hostname %}
                    <br>
                    <small class="text-muted">{{ port.hostname }}</small>
                    {% endif %}
                  </div>
                </td>
                <td>
                  <span class="badge bg-primary">{{ port.port_number }}</span>
                </td>
                <td>
                  <code>{{ port.protocol|upper }}</code>
                </td>
                <td>
                  {% if port.state == 'open' %}
                  <span class="badge bg-success">{{ port.state|title }}</span>
                  {% elif port.state == 'closed' %}
                  <span class="badge bg-danger">{{ port.state|title }}</span>
                  {% elif port.state == 'filtered' %}
                  <span class="badge bg-warning">{{ port.state|title }}</span>
                  {% else %}
                  <span class="badge bg-secondary">{{ port.state|title }}</span>
                  {% endif %}
                </td>
                <td>
                  {% if port.service_name %}
                  <a href="{{ url_for('network.services') }}?service={{ port.service_name }}"
                     class="text-decoration-none">
                    {{ port.service_name }}
                  </a>
                  {% else %}
                  <span class="text-muted">Unknown</span>
                  {% endif %}
                </td>
                <td>
                  {% if port.service_product or port.service_version %}
                  <div>
                    {% if port.service_product %}
                    <span class="text-info">{{ port.service_product }}</span>
                    {% endif %}
                    {% if port.service_version %}
                    <br><code class="text-success">{{ port.service_version }}</code>
                    {% endif %}
                  </div>
                  {% else %}
                  <span class="text-muted">-</span>
                  {% endif %}
                </td>
                <td>
                  {% if port.reason %}
                  <small class="text-muted">{{ port.reason }}</small>
                  {% else %}
                  <span class="text-muted">-</span>
                  {% endif %}
                </td>
                <td>
                  <div class="btn-group btn-group-sm">
                    <a href="{{ url_for('network.host_detail', ip_address=port.ip_address) }}"
                       class="btn btn-primary" title="View Host">
                      <i class="bi bi-eye"></i>
                    </a>
                    {% if port.service_name %}
                    <a href="{{ url_for('network.services') }}?service={{ port.service_name }}"
                       class="btn btn-info" title="View Service">
                      <i class="bi bi-gear"></i>
                    </a>
                    {% endif %}
                    <a href="{{ url_for('security.vulnerabilities') }}?host_ip={{ port.ip_address }}"
                       class="btn btn-warning" title="Vulnerabilities">
                      <i class="bi bi-shield-exclamation"></i>
                    </a>
                    <button type="button" class="btn btn-secondary"
                            onclick="scanPort('{{ port.ip_address }}', '{{ port.port_number }}')"
                            title="Re-scan Port">
                      <i class="bi bi-arrow-clockwise"></i>
                    </button>
                  </div>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
          {% endif %}
        </div>

        <!-- Pagination -->
        {% if total_pages and total_pages > 1 %}
        <div class="card-footer">
          <nav aria-label="Ports pagination">
            <ul class="pagination pagination-sm m-0 float-end">
              {% set current_filters = request.args.to_dict() %}
              {% if page > 1 %}
              <li class="page-item">
                <a class="page-link" href="{{ url_for('network.ports', page=page-1, **current_filters) }}">
                  <i class="bi bi-chevron-left"></i>
                </a>
              </li>
              {% endif %}

              {% for p in range(max(1, page-2), min(total_pages+1, page+3)) %}
              <li class="page-item {% if p == page %}active{% endif %}">
                <a class="page-link" href="{{ url_for('network.ports', page=p, **current_filters) }}">{{ p }}</a>
              </li>
              {% endfor %}

              {% if page < total_pages %}
              <li class="page-item">
                <a class="page-link" href="{{ url_for('network.ports', page=page+1, **current_filters) }}">
                  <i class="bi bi-chevron-right"></i>
                </a>
              </li>
              {% endif %}
            </ul>
          </nav>
          <div class="float-start">
            {% set current_page = page or 1 %}
            {% set current_per_page = request.args.get('per_page', 50)|int %}
            Showing {{ (current_page-1)*current_per_page + 1 }} to {{ min(current_page*current_per_page, total_count) if total_count else 0 }} of {{ total_count or 0 }} ports
          </div>
        </div>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Port Analytics -->
  <div class="row mt-4">
    <div class="col-md-6">
      <div class="card">
        <div class="card-header">
          <h3 class="card-title">
            <i class="bi bi-pie-chart"></i> Port State Distribution
          </h3>
        </div>
        <div class="card-body">
          <canvas id="portStateChart" width="400" height="300"></canvas>
        </div>
      </div>
    </div>

    <div class="col-md-6">
      <div class="card">
        <div class="card-header">
          <h3 class="card-title">
            <i class="bi bi-bar-chart"></i> Top Open Ports
          </h3>
        </div>
        <div class="card-body">
          <canvas id="topPortsChart" width="400" height="300"></canvas>
        </div>
      </div>
    </div>
  </div>

  <!-- Security Analysis -->
  <div class="row mt-4">
    <div class="col-12">
      <div class="card">
        <div class="card-header">
          <h3 class="card-title">
            <i class="bi bi-shield-check"></i> Port Security Analysis
          </h3>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-3">
              <div class="info-box">
                <span class="info-box-icon bg-danger">
                  <i class="bi bi-exclamation-triangle"></i>
                </span>
                <div class="info-box-content">
                  <span class="info-box-text">High Risk Ports</span>
                  <span class="info-box-number">{{ security_analysis.high_risk_ports if security_analysis else 0 }}</span>
                </div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="info-box">
                <span class="info-box-icon bg-warning">
                  <i class="bi bi-shield-exclamation"></i>
                </span>
                <div class="info-box-content">
                  <span class="info-box-text">Uncommon Ports</span>
                  <span class="info-box-number">{{ security_analysis.uncommon_ports if security_analysis else 0 }}</span>
                </div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="info-box">
                <span class="info-box-icon bg-info">
                  <i class="bi bi-shield"></i>
                </span>
                <div class="info-box-content">
                  <span class="info-box-text">Filtered Ports</span>
                  <span class="info-box-number">{{ stats.filtered_ports if stats else 0 }}</span>
                </div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="info-box">
                <span class="info-box-icon bg-success">
                  <i class="bi bi-check-circle"></i>
                </span>
                <div class="info-box-content">
                  <span class="info-box-text">Standard Ports</span>
                  <span class="info-box-number">{{ security_analysis.standard_ports if security_analysis else 0 }}</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Port State Distribution Chart
const stateCtx = document.getElementById('portStateChart').getContext('2d');
const stateChart = new Chart(stateCtx, {
    type: 'doughnut',
    data: {
        labels: ['Open', 'Closed', 'Filtered'],
        datasets: [{
            data: [
                {{ stats.open_ports if stats else 0 }},
                {{ stats.closed_ports if stats else 0 }},
                {{ stats.filtered_ports if stats else 0 }}
            ],
            backgroundColor: ['#28a745', '#dc3545', '#ffc107']
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'bottom'
            }
        }
    }
});

// Top Ports Chart
const topPortsCtx = document.getElementById('topPortsChart').getContext('2d');
const topPortsChart = new Chart(topPortsCtx, {
    type: 'bar',
    data: {
        labels: ['80', '443', '22', '21', '25', '53', '135', '139', '445', '3389'],
        datasets: [{
            label: 'Open Count',
            data: [45, 38, 32, 15, 12, 28, 8, 6, 18, 5],
            backgroundColor: '#007bff'
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
            y: {
                beginAtZero: true
            }
        },
        plugins: {
            legend: {
                display: false
            }
        }
    }
});

function exportPorts(format) {
    const urlParams = new URLSearchParams(window.location.search);
    urlParams.set('format', format);
    const exportUrl = '/tools/database/export?table=ports&' + urlParams.toString();
    window.open(exportUrl, '_blank');
}

function scanPort(ip, port) {
    if (confirm(`Re-scan port ${port} on host ${ip}?`)) {
        alert('Port scan initiated. Results will be updated shortly.');
    }
}

// Auto-refresh every 60 seconds
setTimeout(function() {
    location.reload();
}, 60000);
</script>
{% endblock %}