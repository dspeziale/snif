{% extends "base.html" %}

{% block title %}Host {{ host.ip_address }} - Nmap Scanner{% endblock %}
{% block page_title %}Dettagli Host {{ host.ip_address }}{% endblock %}

{% block breadcrumbs %}
<li class="breadcrumb-item"><a href="{{ url_for('index') }}">Home</a></li>
<li class="breadcrumb-item"><a href="{{ url_for('network.dashboard') }}">Network</a></li>
<li class="breadcrumb-item"><a href="{{ url_for('network.hosts') }}">Host</a></li>
<li class="breadcrumb-item active" aria-current="page">{{ host.ip_address }}</li>
{% endblock %}

{% block extra_css %}
<!-- DataTables -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/datatables.net-bs5@1.13.6/css/dataTables.bootstrap5.min.css">
{% endblock %}

{% block content %}
<!-- Informazioni generali host -->
<div class="row mb-4">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="bi bi-pc-display me-1"></i>
                    Informazioni Generali
                </h3>
                <div class="card-tools">
                    {% if host.status_state == 'up' %}
                    <span class="badge bg-success">HOST ATTIVO</span>
                    {% elif host.status_state == 'down' %}
                    <span class="badge bg-danger">HOST DOWN</span>
                    {% else %}
                    <span class="badge bg-secondary">{{ host.status_state | upper }}</span>
                    {% endif %}
                </div>
            </div>
            <div class="card-body">
                <dl class="row">
                    <dt class="col-sm-3">IP Address:</dt>
                    <dd class="col-sm-9">
                        <code class="fs-5">{{ host.ip_address }}</code>
                        <button type="button" class="btn btn-outline-secondary btn-sm ms-2"
                                onclick="copyToClipboard('{{ host.ip_address }}')">
                            <i class="bi bi-clipboard"></i>
                        </button>
                    </dd>

                    <dt class="col-sm-3">Status:</dt>
                    <dd class="col-sm-9">
                        {% if host.status_state == 'up' %}
                        <span class="badge bg-success fs-6">
                <i class="bi bi-check-circle me-1"></i>ATTIVO
              </span>
                        {% elif host.status_state == 'down' %}
                        <span class="badge bg-danger fs-6">
                <i class="bi bi-x-circle me-1"></i>DOWN
              </span>
                        {% else %}
                        <span class="badge bg-secondary fs-6">{{ host.status_state | upper }}</span>
                        {% endif %}
                    </dd>

                    {% if host.mac_address %}
                    <dt class="col-sm-3">MAC Address:</dt>
                    <dd class="col-sm-9">
                        <code>{{ host.mac_address }}</code>
                        {% if host.vendor %}
                        <br><small class="text-muted">{{ host.vendor }}</small>
                        {% endif %}
                    </dd>
                    {% endif %}

                    <dt class="col-sm-3">Ultimo Scan:</dt>
                    <dd class="col-sm-9">
                        {% if host.start_time %}
                        {{ host.start_time | timestamp }}
                        <br><small class="text-muted">File: {{ host.filename }}</small>
                        {% else %}
                        <span class="text-muted">N/A</span>
                        {% endif %}
                    </dd>

                    {% if host.args %}
                    <dt class="col-sm-3">Parametri Scan:</dt>
                    <dd class="col-sm-9">
                        <code class="small">{{ host.args }}</code>
                    </dd>
                    {% endif %}
                </dl>
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="bi bi-bar-chart me-1"></i>
                    Statistiche Rapide
                </h3>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-6">
                        <div class="border-end">
                            <h4 class="text-primary">{{ ports | length }}</h4>
                            <small class="text-muted">Porte Totali</small>
                        </div>
                    </div>
                    <div class="col-6">
                        <h4 class="text-success">{{ ports | selectattr('state', 'equalto', 'open') | list | length
                            }}</h4>
                        <small class="text-muted">Porte Aperte</small>
                    </div>
                </div>
                <hr>
                <div class="row text-center">
                    <div class="col-6">
                        <div class="border-end">
                            <h4 class="text-warning">{{ vulnerabilities | length }}</h4>
                            <small class="text-muted">Vulnerabilit√†</small>
                        </div>
                    </div>
                    <div class="col-6">
                        <h4 class="text-info">{{ hostnames | length }}</h4>
                        <small class="text-muted">Hostname</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Widget SNMP -->
    <div class="row mb-4" id="snmpWidget" style="display:none;">
        <div class="col-12">
            <div class="card border-info">
                <div class="card-header bg-info text-white">
                    <h3 class="card-title mb-0">
                        <i class="bi bi-router me-2"></i>
                        Informazioni SNMP
                    </h3>
                    <div class="card-tools">
                        <a href="{{ url_for('network.host_snmp_detail', host_id=host.id) }}"
                           class="btn btn-light btn-sm">
                            <i class="bi bi-eye me-1"></i>Vedi Dettagli Completi
                        </a>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row text-center" id="snmpStats">
                        <div class="col-md-2">
                            <div class="border-end">
                                <h4 class="text-primary" id="snmpServices">-</h4>
                                <small class="text-muted">Servizi</small>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="border-end">
                                <h4 class="text-success" id="snmpProcesses">-</h4>
                                <small class="text-muted">Processi</small>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="border-end">
                                <h4 class="text-info" id="snmpSoftware">-</h4>
                                <small class="text-muted">Software</small>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="border-end">
                                <h4 class="text-warning" id="snmpUsers">-</h4>
                                <small class="text-muted">Utenti</small>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="border-end">
                                <h4 class="text-secondary" id="snmpInterfaces">-</h4>
                                <small class="text-muted">Interfacce</small>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <h4 class="text-dark" id="snmpConnections">-</h4>
                            <small class="text-muted">Connessioni</small>
                        </div>
                    </div>

                    <!-- Informazioni di sistema SNMP (se disponibili) -->
                    <div id="snmpSystemInfo" style="display:none;">
                        <hr>
                        <dl class="row mb-0">
                            <dt class="col-sm-2">Sistema:</dt>
                            <dd class="col-sm-4" id="systemDesc">-</dd>
                            <dt class="col-sm-2">Uptime:</dt>
                            <dd class="col-sm-4" id="systemUptime">-</dd>
                            <dt class="col-sm-2">Nome:</dt>
                            <dd class="col-sm-4" id="systemName">-</dd>
                            <dt class="col-sm-2">Contatto:</dt>
                            <dd class="col-sm-4" id="systemContact">-</dd>
                        </dl>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Hostname -->
{% if hostnames %}
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="bi bi-tag me-1"></i>
                    Hostname Rilevati
                </h3>
            </div>
            <div class="card-body">
                {% for hostname in hostnames %}
                <span class="badge bg-info me-2 mb-2">
          <i class="bi bi-dns me-1"></i>
          {{ hostname.hostname }}
          <small class="ms-1">({{ hostname.hostname_type }})</small>
        </span>
                {% endfor %}
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Porte -->
{% if ports %}
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="bi bi-door-open me-1"></i>
                    Porte e Servizi
                </h3>
                <div class="card-tools">
                    <span class="badge bg-success">{{ ports | selectattr('state', 'equalto', 'open') | list | length }} aperte</span>
                    <span class="badge bg-warning">{{ ports | selectattr('state', 'equalto', 'filtered') | list | length }} filtrate</span>
                    <span class="badge bg-danger">{{ ports | selectattr('state', 'equalto', 'closed') | list | length }} chiuse</span>
                </div>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover" id="portsTable">
                        <thead>
                        <tr>
                            <th>Porta</th>
                            <th>Protocollo</th>
                            <th>Stato</th>
                            <th>Servizio</th>
                            <th>Prodotto</th>
                            <th>Versione</th>
                            <th>Info</th>
                        </tr>
                        </thead>
                        <tbody>
                        {% for port in ports %}
                        <tr>
                            <td>
                                <strong>{{ port.port_id }}</strong>
                            </td>
                            <td>
                                <span class="badge bg-secondary">{{ port.protocol | upper }}</span>
                            </td>
                            <td>
                                {% if port.state == 'open' %}
                                <span class="badge bg-success">
                      <i class="bi bi-check-circle me-1"></i>{{ port.state | upper }}
                    </span>
                                {% elif port.state == 'closed' %}
                                <span class="badge bg-danger">
                      <i class="bi bi-x-circle me-1"></i>{{ port.state | upper }}
                    </span>
                                {% elif port.state == 'filtered' %}
                                <span class="badge bg-warning">
                      <i class="bi bi-shield me-1"></i>{{ port.state | upper }}
                    </span>
                                {% else %}
                                <span class="badge bg-secondary">{{ port.state | upper }}</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if port.service_name %}
                                <strong>{{ port.service_name }}</strong>
                                {% else %}
                                <span class="text-muted">N/A</span>
                                {% endif %}
                            </td>
                            <td>
                                <small class="text-muted">
                                    {{ port.service_product or 'N/A' }}
                                </small>
                            </td>
                            <td>
                                <small class="text-muted">
                                    {{ port.service_version or 'N/A' }}
                                </small>
                            </td>
                            <td>
                                <small class="text-muted">
                                    {{ port.service_extra_info or '' }}
                                </small>
                            </td>
                        </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Vulnerabilit√† -->
{% if vulnerabilities %}
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="bi bi-bug me-1"></i>
                    Vulnerabilit√†
                </h3>
                <div class="card-tools">
                    <span class="badge bg-danger">{{ vulnerabilities | length }} trovate</span>
                </div>
            </div>
            <div class="card-body">
                {% for vuln in vulnerabilities %}
                <div class="alert alert-{% if vuln.severity == 'critical' %}danger{% elif vuln.severity == 'high' %}warning{% elif vuln.severity == 'medium' %}info{% else %}secondary{% endif %} mb-3">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="alert-heading mb-1">
                                {% if vuln.cve_id %}
                                {{ vuln.cve_id }}
                                {% else %}
                                Vulnerabilit√† #{{ vuln.id }}
                                {% endif %}
                            </h6>
                            <p class="mb-2">{{ vuln.description or 'Nessuna descrizione disponibile' }}</p>
                            {% if vuln.cvss_score %}
                            <div>
                                <span class="badge bg-dark">CVSS: {{ vuln.cvss_score }}</span>
                            </div>
                            {% endif %}
                        </div>
                        <div class="text-end">
              <span class="badge bg-{% if vuln.severity == 'critical' %}danger{% elif vuln.severity == 'high' %}warning{% elif vuln.severity == 'medium' %}info{% else %}secondary{% endif %}">
                {{ vuln.severity | upper }}
              </span>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Script NSE -->
{% if scripts %}
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="bi bi-code-slash me-1"></i>
                    Script NSE
                </h3>
            </div>
            <div class="card-body">
                <div class="accordion" id="scriptsAccordion">
                    {% for script in scripts %}
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="heading{{ loop.index }}">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                                    data-bs-target="#collapse{{ loop.index }}">
                                <strong>{{ script.script_id }}</strong>
                                <small class="ms-2 text-muted">
                                    {% if script.port_id %}
                                    Porta {{ script.port_id }}/{{ script.protocol }}
                                    {% endif %}
                                </small>
                            </button>
                        </h2>
                        <div id="collapse{{ loop.index }}" class="accordion-collapse collapse"
                             data-bs-parent="#scriptsAccordion">
                            <div class="accordion-body">
                                <pre class="language-none"><code>{{ script.script_output }}</code></pre>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Azioni -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-body text-center">
                <a href="{{ url_for('network.hosts') }}" class="btn btn-secondary me-2">
                    <i class="bi bi-arrow-left me-1"></i>
                    Torna alla Lista
                </a>
                <a href="{{ url_for('network.ports') }}?search={{ host.ip_address }}" class="btn btn-info me-2">
                    <i class="bi bi-door-open me-1"></i>
                    Tutte le Porte
                </a>
                {% if vulnerabilities %}
                <a href="{{ url_for('network.vulnerabilities') }}?search={{ host.ip_address }}" class="btn btn-warning">
                    <i class="bi bi-bug me-1"></i>
                    Vulnerabilit√†
                </a>
                {% endif %}
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<!-- DataTables -->
<script src="https://cdn.jsdelivr.net/npm/datatables.net@1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/datatables.net-bs5@1.13.6/js/dataTables.bootstrap5.min.js"></script>

<script>
    $(document).ready(function() {
        // Inizializza DataTable per le porte
        {% if ports %}
        $('#portsTable').DataTable({
            "paging": false,
            "searching": true,
            "info": false,
            "language": {
                "search": "Cerca porte:",
                "emptyTable": "Nessuna porta trovata"
            },
            "order": [[ 0, "asc" ]] // Ordina per numero porta
        });
        {% endif %}

        // Tooltip
        $('[title]').tooltip();
    });

    // Funzione per copiare negli appunti
    function copyToClipboard(text) {
        navigator.clipboard.writeText(text).then(function() {
            // Mostra feedback
            const button = event.target.closest('button');
            const originalHtml = button.innerHTML;
            button.innerHTML = '<i class="bi bi-check"></i>';
            button.classList.remove('btn-outline-secondary');
            button.classList.add('btn-success');

            setTimeout(function() {
                button.innerHTML = originalHtml;
                button.classList.remove('btn-success');
                button.classList.add('btn-outline-secondary');
            }, 1500);
        }, function(err) {
            console.error('Could not copy text: ', err);
        });
    }
</script>
<script>
// Carica dati SNMP per il widget
function loadSnmpData() {
    fetch(`{{ url_for('network.api_snmp_summary', host_id=host.id) }}`)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                console.error('Errore caricamento SNMP:', data.error);
                return;
            }

            // Aggiorna le statistiche
            document.getElementById('snmpServices').textContent = data.services || 0;
            document.getElementById('snmpProcesses').textContent = data.processes || 0;
            document.getElementById('snmpSoftware').textContent = data.software || 0;
            document.getElementById('snmpUsers').textContent = data.users || 0;
            document.getElementById('snmpInterfaces').textContent = data.interfaces || 0;
            document.getElementById('snmpConnections').textContent = data.connections || 0;

            // Se ci sono dati SNMP, mostra il widget
            const totalSnmpData = (data.services || 0) + (data.processes || 0) +
                                 (data.software || 0) + (data.users || 0) +
                                 (data.interfaces || 0) + (data.connections || 0);

            if (totalSnmpData > 0) {
                document.getElementById('snmpWidget').style.display = 'block';

                // Se ci sono informazioni di sistema, mostrale
                if (data.system) {
                    document.getElementById('systemDesc').textContent = data.system.system_description || 'N/A';
                    document.getElementById('systemUptime').textContent = data.system.system_uptime || 'N/A';
                    document.getElementById('systemName').textContent = data.system.system_name || 'N/A';
                    document.getElementById('systemContact').textContent = data.system.system_contact || 'N/A';
                    document.getElementById('snmpSystemInfo').style.display = 'block';
                }
            }
        })
        .catch(error => {
            console.error('Errore nella chiamata SNMP API:', error);
        });
}

// Carica i dati quando la pagina √® pronta
$(document).ready(function() {
    loadSnmpData();
});
</script>
{% endblock %}