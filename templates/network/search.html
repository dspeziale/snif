{% extends "base.html" %}

{% block title %}Ricerca Avanzata - Nmap Scanner{% endblock %}
{% block page_title %}Ricerca Avanzata{% endblock %}

{% block breadcrumbs %}
<li class="breadcrumb-item"><a href="{{ url_for('index') }}">Home</a></li>
<li class="breadcrumb-item"><a href="{{ url_for('network.dashboard') }}">Network</a></li>
<li class="breadcrumb-item active" aria-current="page">Ricerca Avanzata</li>
{% endblock %}

{% block extra_css %}
<!-- Select2 -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" rel="stylesheet" />
{% endblock %}

{% block content %}
<!-- Form di ricerca -->
<div class="row mb-4">
  <div class="col-12">
    <div class="card">
      <div class="card-header">
        <h3 class="card-title">
          <i class="bi bi-search me-1"></i>
          Parametri di Ricerca
        </h3>
        <div class="card-tools">
          <button type="button" class="btn btn-tool" data-lte-toggle="card-collapse">
            <i data-lte-icon="expand" class="bi bi-plus-lg"></i>
            <i data-lte-icon="collapse" class="bi bi-dash-lg"></i>
          </button>
        </div>
      </div>
      <div class="card-body">
        <form method="GET" id="searchForm">
          <div class="row mb-3">
            <div class="col-md-8">
              <label for="q" class="form-label">Termine di Ricerca</label>
              <div class="input-group">
                <span class="input-group-text">
                  <i class="bi bi-search"></i>
                </span>
                <input type="text" class="form-control form-control-lg" id="q" name="q"
                       value="{{ query }}" placeholder="Inserisci IP, servizio, vulnerabilità..."
                       autocomplete="off">
                <button type="submit" class="btn btn-primary">
                  <i class="bi bi-search me-1"></i>
                  Cerca
                </button>
              </div>
              <div id="searchHelp" class="form-text">
                Esempi: "192.168.1.1", "ssh", "http", "vulnerability", "windows"
              </div>
            </div>
            <div class="col-md-4">
              <label for="type" class="form-label">Tipo di Ricerca</label>
              <select class="form-select form-select-lg" id="type" name="type">
                <option value="all" {% if search_type == 'all' %}selected{% endif %}>
                  <i class="bi bi-globe"></i> Tutto
                </option>
                <option value="hosts" {% if search_type == 'hosts' %}selected{% endif %}>
                  <i class="bi bi-pc-display"></i> Solo Host
                </option>
                <option value="ports" {% if search_type == 'ports' %}selected{% endif %}>
                  <i class="bi bi-door-open"></i> Solo Porte/Servizi
                </option>
                <option value="vulnerabilities" {% if search_type == 'vulnerabilities' %}selected{% endif %}>
                  <i class="bi bi-shield-exclamation"></i> Solo Vulnerabilità
                </option>
              </select>
            </div>
          </div>

          <!-- Filtri avanzati -->
          <div class="accordion" id="advancedFilters">
            <div class="accordion-item">
              <h2 class="accordion-header">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                        data-bs-target="#advancedOptions">
                  <i class="bi bi-sliders me-2"></i>
                  Opzioni Avanzate
                </button>
              </h2>
              <div id="advancedOptions" class="accordion-collapse collapse">
                <div class="accordion-body">
                  <div class="row">
                    <div class="col-md-4">
                      <label for="port_range" class="form-label">Range Porte</label>
                      <input type="text" class="form-control" id="port_range" name="port_range"
                             placeholder="es. 80-443">
                      <div class="form-text">Formato: porta singola (80) o range (80-443)</div>
                    </div>
                    <div class="col-md-4">
                      <label for="service_filter" class="form-label">Servizio Specifico</label>
                      <select class="form-select" id="service_filter" name="service_filter">
                        <option value="">Tutti i servizi</option>
                        <option value="http">HTTP</option>
                        <option value="https">HTTPS</option>
                        <option value="ssh">SSH</option>
                        <option value="ftp">FTP</option>
                        <option value="smtp">SMTP</option>
                        <option value="dns">DNS</option>
                        <option value="snmp">SNMP</option>
                        <option value="telnet">Telnet</option>
                      </select>
                    </div>
                    <div class="col-md-4">
                      <label for="status_filter" class="form-label">Status Host</label>
                      <select class="form-select" id="status_filter" name="status_filter">
                        <option value="">Tutti gli status</option>
                        <option value="up">Host Attivi</option>
                        <option value="down">Host Down</option>
                      </select>
                    </div>
                  </div>
                  <div class="row mt-3">
                    <div class="col-md-4">
                      <label for="cvss_min" class="form-label">CVSS Score Minimo</label>
                      <input type="number" class="form-control" id="cvss_min" name="cvss_min"
                             min="0" max="10" step="0.1" placeholder="es. 7.0">
                    </div>
                    <div class="col-md-4">
                      <label for="severity_filter" class="form-label">Severità Vulnerabilità</label>
                      <select class="form-select" id="severity_filter" name="severity_filter">
                        <option value="">Tutte le severità</option>
                        <option value="critical">Critica</option>
                        <option value="high">Alta</option>
                        <option value="medium">Media</option>
                        <option value="low">Bassa</option>
                      </select>
                    </div>
                    <div class="col-md-4">
                      <div class="form-check mt-4">
                        <input class="form-check-input" type="checkbox" id="only_vulnerable" name="only_vulnerable">
                        <label class="form-check-label" for="only_vulnerable">
                          Solo host con vulnerabilità
                        </label>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Suggerimenti di ricerca -->
{% if not query %}
<div class="row mb-4">
  <div class="col-12">
    <div class="card">
      <div class="card-header">
        <h3 class="card-title">
          <i class="bi bi-lightbulb me-1"></i>
          Suggerimenti di Ricerca
        </h3>
      </div>
      <div class="card-body">
        <div class="row">
          <div class="col-md-6">
            <h5 class="text-primary">
              <i class="bi bi-pc-display me-1"></i>
              Ricerca Host
            </h5>
            <ul class="list-unstyled">
              <li class="mb-2">
                <button class="btn btn-link p-0" onclick="quickSearch('192.168.1')">
                  <i class="bi bi-search me-1"></i>
                  Rete 192.168.1.x
                </button>
              </li>
              <li class="mb-2">
                <button class="btn btn-link p-0" onclick="quickSearch('windows', 'hosts')">
                  <i class="bi bi-search me-1"></i>
                  Host Windows
                </button>
              </li>
              <li class="mb-2">
                <button class="btn btn-link p-0" onclick="quickSearch('linux', 'hosts')">
                  <i class="bi bi-search me-1"></i>
                  Host Linux
                </button>
              </li>
            </ul>
          </div>
          <div class="col-md-6">
            <h5 class="text-success">
              <i class="bi bi-door-open me-1"></i>
              Ricerca Servizi
            </h5>
            <ul class="list-unstyled">
              <li class="mb-2">
                <button class="btn btn-link p-0" onclick="quickSearch('http', 'ports')">
                  <i class="bi bi-search me-1"></i>
                  Servizi HTTP
                </button>
              </li>
              <li class="mb-2">
                <button class="btn btn-link p-0" onclick="quickSearch('ssh', 'ports')">
                  <i class="bi bi-search me-1"></i>
                  Servizi SSH
                </button>
              </li>
              <li class="mb-2">
                <button class="btn btn-link p-0" onclick="quickSearch('22', 'ports')">
                  <i class="bi bi-search me-1"></i>
                  Porta 22
                </button>
              </li>
            </ul>
          </div>
        </div>
        <div class="row mt-3">
          <div class="col-md-6">
            <h5 class="text-warning">
              <i class="bi bi-shield-exclamation me-1"></i>
              Ricerca Vulnerabilità
            </h5>
            <ul class="list-unstyled">
              <li class="mb-2">
                <button class="btn btn-link p-0" onclick="quickSearch('critical', 'vulnerabilities')">
                  <i class="bi bi-search me-1"></i>
                  Vulnerabilità Critiche
                </button>
              </li>
              <li class="mb-2">
                <button class="btn btn-link p-0" onclick="quickSearch('high', 'vulnerabilities')">
                  <i class="bi bi-search me-1"></i>
                  Vulnerabilità Elevate
                </button>
              </li>
            </ul>
          </div>
          <div class="col-md-6">
            <h5 class="text-info">
              <i class="bi bi-clock-history me-1"></i>
              Ricerche Rapide
            </h5>
            <div class="btn-group-vertical w-100">
              <a href="{{ url_for('network.hosts', status='up') }}" class="btn btn-outline-success btn-sm">
                <i class="bi bi-check-circle me-1"></i>
                Tutti gli host attivi
              </a>
              <a href="{{ url_for('network.ports', state='open') }}" class="btn btn-outline-warning btn-sm">
                <i class="bi bi-door-open me-1"></i>
                Tutte le porte aperte
              </a>
              <a href="{{ url_for('network.vulnerabilities') }}" class="btn btn-outline-danger btn-sm">
                <i class="bi bi-bug me-1"></i>
                Tutte le vulnerabilità
              </a>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endif %}

<!-- Risultati della ricerca -->
{% if query %}
<div class="row">
  <div class="col-12">
    <div class="card">
      <div class="card-header">
        <h3 class="card-title">
          <i class="bi bi-list-ul me-1"></i>
          Risultati per "{{ query }}"
        </h3>
        <div class="card-tools">
          {% if results %}
            <span class="badge bg-primary">{{ total or results|length }} risultati</span>
          {% endif %}
        </div>
      </div>
      <div class="card-body">
        {% if results %}
        <div class="list-group">
          {% for result in results %}
          <div class="list-group-item list-group-item-action">
            <div class="d-flex w-100 justify-content-between align-items-start">
              <div class="flex-grow-1">
                <div class="d-flex align-items-center mb-1">
                  {% if result.result_type == 'host' %}
                    <i class="bi bi-pc-display text-primary me-2"></i>
                    <span class="badge bg-primary me-2">HOST</span>
                  {% elif result.result_type == 'port' %}
                    <i class="bi bi-door-open text-success me-2"></i>
                    <span class="badge bg-success me-2">PORTA</span>
                  {% elif result.result_type == 'vulnerability' %}
                    <i class="bi bi-shield-exclamation text-danger me-2"></i>
                    <span class="badge bg-danger me-2">VULN</span>
                  {% else %}
                    <i class="bi bi-file-text text-info me-2"></i>
                    <span class="badge bg-info me-2">{{ result.result_type | upper }}</span>
                  {% endif %}

                  <h5 class="mb-0">
                    <a href="{{ result.url }}" class="text-decoration-none">
                      {{ result.title }}
                    </a>
                  </h5>
                </div>

                {% if result.description %}
                <p class="mb-1 text-muted">{{ result.description }}</p>
                {% endif %}

                {% if result.context %}
                <small class="text-muted">
                  <i class="bi bi-tag me-1"></i>
                  {{ result.context }}
                </small>
                {% endif %}
              </div>

              <div class="ms-3">
                <a href="{{ result.url }}" class="btn btn-outline-primary btn-sm">
                  <i class="bi bi-arrow-right"></i>
                </a>
              </div>
            </div>
          </div>
          {% endfor %}
        </div>

        <!-- Link per vedere tutti i risultati -->
        {% if total and total > results|length %}
        <div class="text-center mt-3">
          <p class="text-muted">Mostrando {{ results|length }} di {{ total }} risultati</p>
          <div class="btn-group">
            {% if search_type == 'all' %}
            <a href="{{ url_for('network.hosts') }}?search={{ query }}" class="btn btn-outline-primary btn-sm">
              <i class="bi bi-pc-display me-1"></i>
              Vedi tutti gli host
            </a>
            <a href="{{ url_for('network.ports') }}?search={{ query }}" class="btn btn-outline-success btn-sm">
              <i class="bi bi-door-open me-1"></i>
              Vedi tutte le porte
            </a>
            <a href="{{ url_for('network.vulnerabilities') }}?search={{ query }}" class="btn btn-outline-danger btn-sm">
              <i class="bi bi-bug me-1"></i>
              Vedi tutte le vulnerabilità
            </a>
            {% endif %}
          </div>
        </div>
        {% endif %}

        {% else %}
        <!-- Nessun risultato -->
        <div class="text-center py-5">
          <i class="bi bi-search display-1 text-muted"></i>
          <h4 class="mt-3">Nessun risultato trovato</h4>
          <p class="text-muted">
            La ricerca per "<strong>{{ query }}</strong>" non ha prodotto risultati.
          </p>
          <div class="mt-3">
            <button type="button" class="btn btn-primary" onclick="document.getElementById('q').focus()">
              <i class="bi bi-search me-1"></i>
              Prova una nuova ricerca
            </button>
            <a href="{{ url_for('network.dashboard') }}" class="btn btn-secondary">
              <i class="bi bi-house me-1"></i>
              Torna alla Dashboard
            </a>
          </div>

          <div class="mt-4">
            <h6>Suggerimenti per migliorare la ricerca:</h6>
            <ul class="list-unstyled text-start d-inline-block">
              <li><i class="bi bi-check text-success me-1"></i> Verifica l'ortografia</li>
              <li><i class="bi bi-check text-success me-1"></i> Usa termini più generici</li>
              <li><i class="bi bi-check text-success me-1"></i> Prova con IP parziali (es. 192.168)</li>
              <li><i class="bi bi-check text-success me-1"></i> Cerca per nome servizio invece che versione</li>
            </ul>
          </div>
        </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>
{% endif %}

<!-- Statistiche ricerca -->
{% if query and results %}
<div class="row mt-4">
  <div class="col-12">
    <div class="card">
      <div class="card-header">
        <h3 class="card-title">
          <i class="bi bi-graph-up me-1"></i>
          Statistiche Ricerca
        </h3>
      </div>
      <div class="card-body">
        <div class="row text-center">
          {% set host_count = results | selectattr('result_type', 'equalto', 'host') | list | length %}
          {% set port_count = results | selectattr('result_type', 'equalto', 'port') | list | length %}
          {% set vuln_count = results | selectattr('result_type', 'equalto', 'vulnerability') | list | length %}

          <div class="col-md-3">
            <div class="border-end">
              <h4 class="text-primary">{{ host_count }}</h4>
              <small class="text-muted">Host trovati</small>
            </div>
          </div>
          <div class="col-md-3">
            <div class="border-end">
              <h4 class="text-success">{{ port_count }}</h4>
              <small class="text-muted">Porte/Servizi</small>
            </div>
          </div>
          <div class="col-md-3">
            <div class="border-end">
              <h4 class="text-danger">{{ vuln_count }}</h4>
              <small class="text-muted">Vulnerabilità</small>
            </div>
          </div>
          <div class="col-md-3">
            <h4 class="text-info">{{ results | length }}</h4>
            <small class="text-muted">Totale risultati</small>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<!-- Select2 -->
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script>
$(document).ready(function() {
    // Inizializza Select2
    $('#service_filter, #status_filter, #severity_filter').select2({
        theme: 'bootstrap-5',
        width: '100%'
    });

    // Auto-focus sul campo di ricerca
    $('#q').focus();

    // Abilita ricerca con Enter
    $('#q').on('keypress', function(e) {
        if (e.which == 13) {
            $('#searchForm').submit();
        }
    });

    // Auto-complete suggerimenti (simulato)
    $('#q').on('input', function() {
        const value = $(this).val().toLowerCase();
        if (value.length >= 2) {
            // Qui potresti implementare chiamate AJAX per suggerimenti
            updateSearchHelp(value);
        }
    });

    // Gestione del tipo di ricerca
    $('#type').change(function() {
        const searchType = $(this).val();
        updateAdvancedOptions(searchType);
    });
});

function updateSearchHelp(value) {
    const helpDiv = $('#searchHelp');
    let suggestions = [];

    if (value.match(/^\d{1,3}(\.\d{1,3}){0,3}$/)) {
        suggestions.push('Ricerca IP address');
    } else if (value.match(/^\d+$/)) {
        suggestions.push('Ricerca numero porta');
    } else if (['http', 'https', 'ssh', 'ftp', 'smtp'].includes(value)) {
        suggestions.push('Ricerca servizio');
    }

    if (suggestions.length > 0) {
        helpDiv.html('<i class="bi bi-lightbulb text-warning me-1"></i>' + suggestions.join(', '));
    }
}

function updateAdvancedOptions(searchType) {
    // Mostra/nascondi opzioni specifiche basate sul tipo di ricerca
    const portOptions = $('#port_range, #service_filter').closest('.col-md-4');
    const vulnOptions = $('#cvss_min, #severity_filter').closest('.col-md-4');

    if (searchType === 'hosts') {
        portOptions.hide();
        vulnOptions.hide();
    } else if (searchType === 'ports') {
        portOptions.show();
        vulnOptions.hide();
    } else if (searchType === 'vulnerabilities') {
        portOptions.hide();
        vulnOptions.show();
    } else {
        portOptions.show();
        vulnOptions.show();
    }
}

function quickSearch(term, type = 'all') {
    $('#q').val(term);
    $('#type').val(type).trigger('change');
    $('#searchForm').submit();
}

// Ricerca in tempo reale (debounced)
let searchTimeout;
$('#q').on('input', function() {
    clearTimeout(searchTimeout);
    const query = $(this).val().trim();

    if (query.length >= 3) {
        searchTimeout = setTimeout(function() {
            // Potresti implementare qui una ricerca AJAX in tempo reale
            console.log('Searching for:', query);
        }, 500);
    }
});

// Gestione degli shortcut da tastiera
$(document).on('keydown', function(e) {
    // Ctrl+K per focus sulla ricerca
    if (e.ctrlKey && e.key === 'k') {
        e.preventDefault();
        $('#q').focus().select();
    }

    // Escape per pulire la ricerca
    if (e.key === 'Escape' && $('#q').is(':focus')) {
        $('#q').val('');
    }
});

// Salva ricerche recenti in localStorage
function saveRecentSearch(query, type) {
    let recent = JSON.parse(localStorage.getItem('recentSearches') || '[]');
    const search = { query, type, timestamp: Date.now() };

    // Rimuovi duplicati
    recent = recent.filter(r => r.query !== query || r.type !== type);

    // Aggiungi in cima
    recent.unshift(search);

    // Mantieni solo le ultime 10
    recent = recent.slice(0, 10);

    localStorage.setItem('recentSearches', JSON.stringify(recent));
}

// Carica ricerche recenti
function loadRecentSearches() {
    const recent = JSON.parse(localStorage.getItem('recentSearches') || '[]');
    // Implementa UI per mostrare ricerche recenti
}

// Salva la ricerca corrente se ci sono risultati
{% if query and results %}
saveRecentSearch('{{ query }}', '{{ search_type }}');
{% endif %}
</script>

<style>
.list-group-item-action:hover {
    background-color: #f8f9fa;
    border-color: #dee2e6;
}

.search-suggestion {
    cursor: pointer;
    padding: 8px 12px;
    border-bottom: 1px solid #eee;
}

.search-suggestion:hover {
    background-color: #f8f9fa;
}

.search-shortcut {
    position: fixed;
    bottom: 20px;
    right: 20px;
    z-index: 1000;
}

/* Animazione per i risultati */
.list-group-item {
    opacity: 0;
    animation: fadeInUp 0.3s ease-out forwards;
}

.list-group-item:nth-child(1) { animation-delay: 0.1s; }
.list-group-item:nth-child(2) { animation-delay: 0.2s; }
.list-group-item:nth-child(3) { animation-delay: 0.3s; }
.list-group-item:nth-child(4) { animation-delay: 0.4s; }
.list-group-item:nth-child(5) { animation-delay: 0.5s; }

@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* Highlight del termine cercato */
.search-highlight {
    background-color: #fff3cd;
    padding: 2px 4px;
    border-radius: 3px;
    font-weight: bold;
}

/* Stile per i badge dei tipi di risultato */
.badge {
    font-size: 0.7em;
    vertical-align: middle;
}

/* Responsive per mobile */
@media (max-width: 768px) {
    .d-flex.justify-content-between {
        flex-direction: column;
    }

    .ms-3 {
        margin-left: 0 !important;
        margin-top: 10px;
        text-align: center;
    }
}
</style>
{% endblock %}