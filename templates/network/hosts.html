{% extends "base.html" %}

{% block title %}Network Hosts - AdminLTE{% endblock %}
{% block page_title %}Network Hosts{% endblock %}

{% block breadcrumbs %}
<li class="breadcrumb-item"><a href="{{ url_for('index') }}">Home</a></li>
<li class="breadcrumb-item"><a href="{{ url_for('network.overview') }}">Network</a></li>
<li class="breadcrumb-item active">Hosts</li>
{% endblock %}

{% block content %}
<div class="container-fluid">
  <!-- Filtri -->
  <div class="row mb-3">
    <div class="col-12">
      <div class="card">
        <div class="card-header">
          <h3 class="card-title">
            <i class="bi bi-funnel"></i> Filtri
          </h3>
          <div class="card-tools">
            <button type="button" class="btn btn-tool" data-card-widget="collapse">
              <i class="fas fa-minus"></i>
            </button>
          </div>
        </div>
        <div class="card-body">
          <form method="GET" class="row g-3">
            <div class="col-md-3">
              <label for="status" class="form-label">Status</label>
              <select class="form-select" id="status" name="status">
                <option value="">Tutti</option>
                <option value="up" {% if filters.status == 'up' %}selected{% endif %}>Up</option>
                <option value="down" {% if filters.status == 'down' %}selected{% endif %}>Down</option>
                <option value="filtered" {% if filters.status == 'filtered' %}selected{% endif %}>Filtered</option>
              </select>
            </div>
            <div class="col-md-3">
              <label for="vendor" class="form-label">Vendor</label>
              <select class="form-select" id="vendor" name="vendor">
                <option value="">Tutti</option>
                {% for vendor in available_filters.vendors %}
                <option value="{{ vendor.vendor }}" {% if filters.vendor == vendor.vendor %}selected{% endif %}>
                  {{ vendor.vendor }} ({{ vendor.count }})
                </option>
                {% endfor %}
              </select>
            </div>
            <div class="col-md-3">
              <label for="search" class="form-label">Cerca IP/Hostname</label>
              <input type="text" class="form-control" id="search" name="search"
                     value="{{ filters.search or '' }}" placeholder="192.168.1.1 o hostname">
            </div>
            <div class="col-md-3">
              <label for="per_page" class="form-label">Per pagina</label>
              <select class="form-select" id="per_page" name="per_page">
                <option value="50" {% if per_page == 50 %}selected{% endif %}>50</option>
                <option value="100" {% if per_page == 100 %}selected{% endif %}>100</option>
                <option value="200" {% if per_page == 200 %}selected{% endif %}>200</option>
              </select>
            </div>
            <div class="col-12">
              <button type="submit" class="btn btn-primary">
                <i class="bi bi-search"></i> Filtra
              </button>
              <a href="{{ url_for('network.hosts') }}" class="btn btn-secondary">
                <i class="bi bi-arrow-clockwise"></i> Reset
              </a>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Statistiche -->
  <div class="row mb-3">
    <div class="col-lg-3 col-6">
      <div class="small-box bg-info">
        <div class="inner">
          <h3>{{ total_count }}</h3>
          <p>Total Hosts</p>
        </div>
        <div class="icon">
          <i class="bi bi-pc-display"></i>
        </div>
      </div>
    </div>
    <div class="col-lg-3 col-6">
      <div class="small-box bg-success">
        <div class="inner">
          <h3>{{ stats.up_count if stats else 0 }}</h3>
          <p>Active Hosts</p>
        </div>
        <div class="icon">
          <i class="bi bi-check-circle"></i>
        </div>
      </div>
    </div>
    <div class="col-lg-3 col-6">
      <div class="small-box bg-warning">
        <div class="inner">
          <h3>{{ stats.down_count if stats else 0 }}</h3>
          <p>Inactive Hosts</p>
        </div>
        <div class="icon">
          <i class="bi bi-x-circle"></i>
        </div>
      </div>
    </div>
    <div class="col-lg-3 col-6">
      <div class="small-box bg-danger">
        <div class="inner">
          <h3>{{ stats.filtered_count if stats else 0 }}</h3>
          <p>Filtered Hosts</p>
        </div>
        <div class="icon">
          <i class="bi bi-shield-exclamation"></i>
        </div>
      </div>
    </div>
  </div>

  <!-- Lista Hosts -->
  <div class="row">
    <div class="col-12">
      <div class="card">
        <div class="card-header">
          <h3 class="card-title">
            <i class="bi bi-list"></i> Hosts List
            <span class="badge bg-secondary ms-2">{{ total_count }} hosts</span>
          </h3>
          <div class="card-tools">
            <div class="btn-group">
              <button type="button" class="btn btn-sm btn-primary dropdown-toggle" data-bs-toggle="dropdown">
                <i class="bi bi-download"></i> Export
              </button>
              <ul class="dropdown-menu">
                <li><a class="dropdown-item" href="{{ url_for('network.api_hosts', format='csv') }}">CSV</a></li>
                <li><a class="dropdown-item" href="{{ url_for('network.api_hosts', format='json') }}">JSON</a></li>
              </ul>
            </div>
          </div>
        </div>
        <div class="card-body table-responsive p-0">
          {% if error %}
          <div class="alert alert-danger m-3">
            <i class="bi bi-exclamation-triangle"></i> Errore: {{ error }}
          </div>
          {% elif not hosts %}
          <div class="alert alert-info m-3">
            <i class="bi bi-info-circle"></i> Nessun host trovato con i filtri specificati.
          </div>
          {% else %}
          <table class="table table-hover text-nowrap">
            <thead>
              <tr>
                <th>IP Address</th>
                <th>Hostname</th>
                <th>Status</th>
                <th>Vendor</th>
                <th>MAC Address</th>
                <th>Open Ports</th>
                <th>Vulnerabilities</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for host in hosts %}
              <tr>
                <td>
                  <a href="{{ url_for('network.host_detail', ip_address=host.ip_address) }}"
                     class="text-decoration-none">
                    <strong>{{ host.ip_address }}</strong>
                  </a>
                </td>
                <td>{{ host.hostname or '-' }}</td>
                <td>
                  {% if host.status == 'up' %}
                  <span class="badge bg-success">Up</span>
                  {% elif host.status == 'down' %}
                  <span class="badge bg-danger">Down</span>
                  {% else %}
                  <span class="badge bg-warning">{{ host.status|title }}</span>
                  {% endif %}
                </td>
                <td>{{ host.vendor or '-' }}</td>
                <td>
                  <small class="text-muted">{{ host.mac_address or '-' }}</small>
                </td>
                <td>
                  {% if host.open_ports %}
                  <span class="badge bg-info">{{ host.open_ports }}</span>
                  {% else %}
                  <span class="text-muted">0</span>
                  {% endif %}
                </td>
                <td>
                  {% if host.vuln_count %}
                  <span class="badge bg-danger">{{ host.vuln_count }}</span>
                  {% else %}
                  <span class="text-muted">0</span>
                  {% endif %}
                </td>
                <td>
                  <div class="btn-group btn-group-sm">
                    <a href="{{ url_for('network.host_detail', ip_address=host.ip_address) }}"
                       class="btn btn-primary" title="View Details">
                      <i class="bi bi-eye"></i>
                    </a>
                    <a href="{{ url_for('network.ports') }}?host_ip={{ host.ip_address }}"
                       class="btn btn-info" title="View Ports">
                      <i class="bi bi-diagram-3"></i>
                    </a>
                    <a href="{{ url_for('security.vulnerabilities') }}?host_ip={{ host.ip_address }}"
                       class="btn btn-warning" title="View Vulnerabilities">
                      <i class="bi bi-shield-exclamation"></i>
                    </a>
                  </div>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
          {% endif %}
        </div>

        <!-- Paginazione -->
        {% if total_pages > 1 %}
        <div class="card-footer">
          <nav aria-label="Host pagination">
            <ul class="pagination pagination-sm m-0 float-end">
              {% if page > 1 %}
              <li class="page-item">
                <a class="page-link" href="{{ url_for('network.hosts', page=page-1, **filters) }}">
                  <i class="bi bi-chevron-left"></i>
                </a>
              </li>
              {% endif %}

              {% for p in range(max(1, page-2), min(total_pages+1, page+3)) %}
              <li class="page-item {% if p == page %}active{% endif %}">
                <a class="page-link" href="{{ url_for('network.hosts', page=p, **filters) }}">{{ p }}</a>
              </li>
              {% endfor %}

              {% if page < total_pages %}
              <li class="page-item">
                <a class="page-link" href="{{ url_for('network.hosts', page=page+1, **filters) }}">
                  <i class="bi bi-chevron-right"></i>
                </a>
              </li>
              {% endif %}
            </ul>
          </nav>
          <div class="float-start">
            Showing {{ (page-1)*per_page + 1 }} to {{ min(page*per_page, total_count) }} of {{ total_count }} hosts
          </div>
        </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // Auto-refresh ogni 30 secondi se non ci sono filtri
    {% if not filters.get('search') and not filters.get('status') %}
    setTimeout(function() {
        location.reload();
    }, 30000);
    {% endif %}
});
</script>
{% endblock %}