{% extends "base.html" %}

{% block title %}SNMP {{ host.ip_address }} - Nmap Scanner{% endblock %}
{% block page_title %}Dettagli SNMP Host {{ host.ip_address }}{% endblock %}

{% block breadcrumbs %}
<li class="breadcrumb-item"><a href="{{ url_for('index') }}">Home</a></li>
<li class="breadcrumb-item"><a href="{{ url_for('network.dashboard') }}">Network</a></li>
<li class="breadcrumb-item"><a href="{{ url_for('network.hosts') }}">Host</a></li>
<li class="breadcrumb-item"><a href="{{ url_for('network.host_detail', host_id=host.id) }}">{{ host.ip_address }}</a></li>
<li class="breadcrumb-item active" aria-current="page">SNMP</li>
{% endblock %}

{% block extra_css %}
<!-- DataTables -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/datatables.net-bs5@1.13.6/css/dataTables.bootstrap5.min.css">
<style>
.memory-bar {
  height: 20px;
  border-radius: 4px;
}
.interface-status {
  display: inline-block;
  width: 12px;
  height: 12px;
  border-radius: 50%;
  margin-right: 8px;
}
.status-active { background-color: #28a745; }
.status-inactive { background-color: #dc3545; }
.status-unknown { background-color: #6c757d; }
</style>
{% endblock %}

{% block content %}
<!-- Header con informazioni generali -->
<div class="row mb-4">
  <div class="col-12">
    <div class="card border-primary">
      <div class="card-header bg-primary text-white">
        <h3 class="card-title mb-0">
          <i class="bi bi-router me-2"></i>
          Informazioni SNMP - {{ host.ip_address }}
        </h3>
        <div class="card-tools">
          <a href="{{ url_for('network.host_detail', host_id=host.id) }}" class="btn btn-light btn-sm">
            <i class="bi bi-arrow-left me-1"></i>Torna ai Dettagli Host
          </a>
        </div>
      </div>
      <div class="card-body">
        {% if system_info %}
        <dl class="row">
          <dt class="col-sm-2">Sistema:</dt>
          <dd class="col-sm-4">{{ system_info.system_description or 'N/A' }}</dd>

          <dt class="col-sm-2">Uptime:</dt>
          <dd class="col-sm-4">
            {% if system_info.system_uptime %}
              {{ system_info.system_uptime }}
            {% else %}
              N/A
            {% endif %}
          </dd>

          <dt class="col-sm-2">Nome Sistema:</dt>
          <dd class="col-sm-4">{{ system_info.system_name or 'N/A' }}</dd>

          <dt class="col-sm-2">Contatto:</dt>
          <dd class="col-sm-4">{{ system_info.system_contact or 'N/A' }}</dd>

          <dt class="col-sm-2">Posizione:</dt>
          <dd class="col-sm-4">{{ system_info.system_location or 'N/A' }}</dd>

          <dt class="col-sm-2">OID Oggetto:</dt>
          <dd class="col-sm-4"><code class="small">{{ system_info.system_object_id or 'N/A' }}</code></dd>
        </dl>
        {% else %}
        <div class="alert alert-info">
          <i class="bi bi-info-circle me-2"></i>
          Nessuna informazione di sistema SNMP disponibile per questo host.
        </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<!-- Statistiche rapide -->
<div class="row mb-4">
  <div class="col-md-2">
    <div class="card text-center">
      <div class="card-body">
        <h3 class="text-primary">{{ services | length }}</h3>
        <small class="text-muted">Servizi</small>
      </div>
    </div>
  </div>
  <div class="col-md-2">
    <div class="card text-center">
      <div class="card-body">
        <h3 class="text-success">{{ processes | length }}</h3>
        <small class="text-muted">Processi</small>
      </div>
    </div>
  </div>
  <div class="col-md-2">
    <div class="card text-center">
      <div class="card-body">
        <h3 class="text-info">{{ software | length }}</h3>
        <small class="text-muted">Software</small>
      </div>
    </div>
  </div>
  <div class="col-md-2">
    <div class="card text-center">
      <div class="card-body">
        <h3 class="text-warning">{{ users | length }}</h3>
        <small class="text-muted">Utenti</small>
      </div>
    </div>
  </div>
  <div class="col-md-2">
    <div class="card text-center">
      <div class="card-body">
        <h3 class="text-secondary">{{ interfaces | length }}</h3>
        <small class="text-muted">Interfacce</small>
      </div>
    </div>
  </div>
  <div class="col-md-2">
    <div class="card text-center">
      <div class="card-body">
        <h3 class="text-dark">{{ connections | length }}</h3>
        <small class="text-muted">Connessioni</small>
      </div>
    </div>
  </div>
</div>

<!-- Schede con dati SNMP -->
<div class="row">
  <div class="col-12">
    <!-- Tab navigation -->
    <ul class="nav nav-tabs" id="snmpTabs" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="services-tab" data-bs-toggle="tab" data-bs-target="#services" type="button" role="tab">
          <i class="bi bi-gear me-1"></i>Servizi ({{ services | length }})
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="processes-tab" data-bs-toggle="tab" data-bs-target="#processes" type="button" role="tab">
          <i class="bi bi-cpu me-1"></i>Processi ({{ processes | length }})
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="software-tab" data-bs-toggle="tab" data-bs-target="#software" type="button" role="tab">
          <i class="bi bi-box me-1"></i>Software ({{ software | length }})
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="users-tab" data-bs-toggle="tab" data-bs-target="#users" type="button" role="tab">
          <i class="bi bi-people me-1"></i>Utenti ({{ users | length }})
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="interfaces-tab" data-bs-toggle="tab" data-bs-target="#interfaces" type="button" role="tab">
          <i class="bi bi-ethernet me-1"></i>Interfacce ({{ interfaces | length }})
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="connections-tab" data-bs-toggle="tab" data-bs-target="#connections" type="button" role="tab">
          <i class="bi bi-diagram-3 me-1"></i>Connessioni ({{ connections | length }})
        </button>
      </li>
      {% if shares %}
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="shares-tab" data-bs-toggle="tab" data-bs-target="#shares" type="button" role="tab">
          <i class="bi bi-folder-shared me-1"></i>Condivisioni ({{ shares | length }})
        </button>
      </li>
      {% endif %}
    </ul>

    <!-- Tab content -->
    <div class="tab-content mt-3" id="snmpTabContent">

      <!-- SERVIZI -->
      <div class="tab-pane fade show active" id="services" role="tabpanel">
        <div class="card">
          <div class="card-header">
            <h4><i class="bi bi-gear me-1"></i>Servizi Windows/Sistema</h4>
          </div>
          <div class="card-body">
            {% if services %}
            <div class="table-responsive">
              <table class="table table-striped" id="servicesTable">
                <thead>
                  <tr>
                    <th>Nome Servizio</th>
                    <th>Stato</th>
                    <th>Tipo Avvio</th>
                    <th>Rilevato</th>
                  </tr>
                </thead>
                <tbody>
                  {% for service in services %}
                  <tr>
                    <td>
                      <strong>{{ service.service_name }}</strong>
                    </td>
                    <td>
                      {% if service.status == 'running' %}
                        <span class="badge bg-success">Running</span>
                      {% elif service.status == 'stopped' %}
                        <span class="badge bg-danger">Stopped</span>
                      {% else %}
                        <span class="badge bg-secondary">{{ service.status or 'Unknown' }}</span>
                      {% endif %}
                    </td>
                    <td>
                      <small class="text-muted">{{ service.startup_type or 'N/A' }}</small>
                    </td>
                    <td>
                      <small class="text-muted">{{ service.created_at | datetime }}</small>
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
            {% else %}
            <div class="alert alert-info">
              <i class="bi bi-info-circle me-2"></i>
              Nessun servizio SNMP trovato per questo host.
            </div>
            {% endif %}
          </div>
        </div>
      </div>

      <!-- PROCESSI -->
      <div class="tab-pane fade" id="processes" role="tabpanel">
        <div class="card">
          <div class="card-header">
            <h4><i class="bi bi-cpu me-1"></i>Processi Attivi</h4>
          </div>
          <div class="card-body">
            {% if processes %}
            <div class="table-responsive">
              <table class="table table-striped" id="processesTable">
                <thead>
                  <tr>
                    <th>PID</th>
                    <th>Nome Processo</th>
                    <th>Percorso</th>
                    <th>Memoria</th>
                    <th>Rilevato</th>
                  </tr>
                </thead>
                <tbody>
                  {% for process in processes %}
                  <tr>
                    <td>
                      {% if process.process_id %}
                        <code>{{ process.process_id }}</code>
                      {% else %}
                        <span class="text-muted">N/A</span>
                      {% endif %}
                    </td>
                    <td>
                      <strong>{{ process.process_name }}</strong>
                    </td>
                    <td>
                      <small class="font-monospace">
                        {{ process.process_path or 'N/A' }}
                      </small>
                    </td>
                    <td>
                      {% if process.memory_usage %}
                        <span class="badge bg-info">
                          {% if process.memory_usage > 1024*1024 %}
                            {{ (process.memory_usage / (1024*1024)) | round(1) }} MB
                          {% elif process.memory_usage > 1024 %}
                            {{ (process.memory_usage / 1024) | round(1) }} KB
                          {% else %}
                            {{ process.memory_usage }} B
                          {% endif %}
                        </span>
                      {% else %}
                        <span class="text-muted">N/A</span>
                      {% endif %}
                    </td>
                    <td>
                      <small class="text-muted">{{ process.created_at | datetime }}</small>
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
            {% else %}
            <div class="alert alert-info">
              <i class="bi bi-info-circle me-2"></i>
              Nessun processo SNMP trovato per questo host.
            </div>
            {% endif %}
          </div>
        </div>
      </div>

      <!-- SOFTWARE -->
      <div class="tab-pane fade" id="software" role="tabpanel">
        <div class="card">
          <div class="card-header">
            <h4><i class="bi bi-box me-1"></i>Software Installato</h4>
          </div>
          <div class="card-body">
            {% if software %}
            <div class="table-responsive">
              <table class="table table-striped" id="softwareTable">
                <thead>
                  <tr>
                    <th>Nome Software</th>
                    <th>Versione</th>
                    <th>Produttore</th>
                    <th>Data Installazione</th>
                  </tr>
                </thead>
                <tbody>
                  {% for sw in software %}
                  <tr>
                    <td>
                      <strong>{{ sw.software_name }}</strong>
                    </td>
                    <td>
                      <small>{{ sw.version or 'N/A' }}</small>
                    </td>
                    <td>
                      <small class="text-muted">{{ sw.vendor or 'N/A' }}</small>
                    </td>
                    <td>
                      {% if sw.install_date %}
                        <small>{{ sw.install_date }}</small>
                      {% else %}
                        <small class="text-muted">N/A</small>
                      {% endif %}
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
            {% else %}
            <div class="alert alert-info">
              <i class="bi bi-info-circle me-2"></i>
              Nessun software SNMP trovato per questo host.
            </div>
            {% endif %}
          </div>
        </div>
      </div>

      <!-- UTENTI -->
      <div class="tab-pane fade" id="users" role="tabpanel">
        <div class="card">
          <div class="card-header">
            <h4><i class="bi bi-people me-1"></i>Utenti di Sistema</h4>
          </div>
          <div class="card-body">
            {% if users %}
            <div class="table-responsive">
              <table class="table table-striped" id="usersTable">
                <thead>
                  <tr>
                    <th>Username</th>
                    <th>Nome Completo</th>
                    <th>Descrizione</th>
                    <th>Stato</th>
                    <th>Ultimo Accesso</th>
                  </tr>
                </thead>
                <tbody>
                  {% for user in users %}
                  <tr>
                    <td>
                      <code>{{ user.username }}</code>
                    </td>
                    <td>
                      {{ user.full_name or 'N/A' }}
                    </td>
                    <td>
                      <small class="text-muted">{{ user.description or 'N/A' }}</small>
                    </td>
                    <td>
                      {% if user.status == 'active' %}
                        <span class="badge bg-success">Attivo</span>
                      {% elif user.status == 'disabled' %}
                        <span class="badge bg-danger">Disabilitato</span>
                      {% else %}
                        <span class="badge bg-secondary">{{ user.status or 'Unknown' }}</span>
                      {% endif %}
                    </td>
                    <td>
                      <small>{{ user.last_logon or 'N/A' }}</small>
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
            {% else %}
            <div class="alert alert-info">
              <i class="bi bi-info-circle me-2"></i>
              Nessun utente SNMP trovato per questo host.
            </div>
            {% endif %}
          </div>
        </div>
      </div>

      <!-- INTERFACCE -->
      <div class="tab-pane fade" id="interfaces" role="tabpanel">
        <div class="card">
          <div class="card-header">
            <h4><i class="bi bi-ethernet me-1"></i>Interfacce di Rete</h4>
          </div>
          <div class="card-body">
            {% if interfaces %}
            <div class="table-responsive">
              <table class="table table-striped" id="interfacesTable">
                <thead>
                  <tr>
                    <th>Nome</th>
                    <th>Indice</th>
                    <th>IP Address</th>
                    <th>Tipo</th>
                    <th>MAC Address</th>
                    <th>Stato</th>
                    <th>Velocità</th>
                  </tr>
                </thead>
                <tbody>
                  {% for iface in interfaces %}
                  <tr>
                    <td>
                      <strong>{{ iface.interface_name }}</strong>
                    </td>
                    <td>
                      {% if iface.interface_index %}
                        <code>{{ iface.interface_index }}</code>
                      {% else %}
                        <span class="text-muted">N/A</span>
                      {% endif %}
                    </td>
                    <td>
                      {% if iface.ip_address %}
                        <code>{{ iface.ip_address }}</code>
                        {% if iface.netmask %}
                          <br><small class="text-muted">{{ iface.netmask }}</small>
                        {% endif %}
                      {% else %}
                        <span class="text-muted">N/A</span>
                      {% endif %}
                    </td>
                    <td>
                      <small>{{ iface.interface_type or 'N/A' }}</small>
                    </td>
                    <td>
                      {% if iface.mac_address %}
                        <code class="small">{{ iface.mac_address }}</code>
                      {% else %}
                        <span class="text-muted">N/A</span>
                      {% endif %}
                    </td>
                    <td>
                      <span class="interface-status
                        {% if iface.status == 'up' or iface.status == 'active' %}status-active
                        {% elif iface.status == 'down' %}status-inactive
                        {% else %}status-unknown{% endif %}"></span>
                      {{ iface.status or 'Unknown' }}
                    </td>
                    <td>
                      {% if iface.speed %}
                        {% if iface.speed >= 1000000000 %}
                          {{ (iface.speed / 1000000000) | round(1) }} Gbps
                        {% elif iface.speed >= 1000000 %}
                          {{ (iface.speed / 1000000) | round(0) }} Mbps
                        {% else %}
                          {{ iface.speed }} bps
                        {% endif %}
                      {% else %}
                        <span class="text-muted">N/A</span>
                      {% endif %}
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
            {% else %}
            <div class="alert alert-info">
              <i class="bi bi-info-circle me-2"></i>
              Nessuna interfaccia SNMP trovata per questo host.
            </div>
            {% endif %}
          </div>
        </div>
      </div>

      <!-- CONNESSIONI -->
      <div class="tab-pane fade" id="connections" role="tabpanel">
        <div class="card">
          <div class="card-header">
            <h4><i class="bi bi-diagram-3 me-1"></i>Connessioni di Rete</h4>
          </div>
          <div class="card-body">
            {% if connections %}
            <div class="table-responsive">
              <table class="table table-striped table-sm" id="connectionsTable">
                <thead>
                  <tr>
                    <th>Protocollo</th>
                    <th>Indirizzo Locale</th>
                    <th>Porta Locale</th>
                    <th>Indirizzo Remoto</th>
                    <th>Porta Remota</th>
                    <th>Stato</th>
                  </tr>
                </thead>
                <tbody>
                  {% for conn in connections %}
                  <tr>
                    <td>
                      <span class="badge
                        {% if conn.protocol == 'TCP' %}bg-primary
                        {% elif conn.protocol == 'UDP' %}bg-info
                        {% else %}bg-secondary{% endif %}">
                        {{ conn.protocol }}
                      </span>
                    </td>
                    <td>
                      <code class="small">{{ conn.local_address or 'N/A' }}</code>
                    </td>
                    <td>
                      {% if conn.local_port %}
                        <code>{{ conn.local_port }}</code>
                      {% else %}
                        <span class="text-muted">N/A</span>
                      {% endif %}
                    </td>
                    <td>
                      <code class="small">{{ conn.remote_address or 'N/A' }}</code>
                    </td>
                    <td>
                      {% if conn.remote_port %}
                        <code>{{ conn.remote_port }}</code>
                      {% else %}
                        <span class="text-muted">N/A</span>
                      {% endif %}
                    </td>
                    <td>
                      <small>{{ conn.state or 'N/A' }}</small>
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
            {% else %}
            <div class="alert alert-info">
              <i class="bi bi-info-circle me-2"></i>
              Nessuna connessione SNMP trovata per questo host.
            </div>
            {% endif %}
          </div>
        </div>
      </div>

      <!-- CONDIVISIONI (se presenti) -->
      {% if shares %}
      <div class="tab-pane fade" id="shares" role="tabpanel">
        <div class="card">
          <div class="card-header">
            <h4><i class="bi bi-folder-shared me-1"></i>Condivisioni di Rete</h4>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-striped" id="sharesTable">
                <thead>
                  <tr>
                    <th>Nome Condivisione</th>
                    <th>Percorso</th>
                    <th>Descrizione</th>
                    <th>Tipo</th>
                  </tr>
                </thead>
                <tbody>
                  {% for share in shares %}
                  <tr>
                    <td>
                      <strong>{{ share.share_name }}</strong>
                    </td>
                    <td>
                      <code class="small">{{ share.share_path or 'N/A' }}</code>
                    </td>
                    <td>
                      <small class="text-muted">{{ share.description or 'N/A' }}</small>
                    </td>
                    <td>
                      <small>{{ share.share_type or 'N/A' }}</small>
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
      {% endif %}

    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- DataTables -->
<script src="https://cdn.jsdelivr.net/npm/datatables.net@1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/datatables.net-bs5@1.13.6/js/dataTables.bootstrap5.min.js"></script>

<script>
$(document).ready(function() {
    // Inizializza DataTables per tutte le tabelle
    $('#servicesTable, #processesTable, #softwareTable, #usersTable, #interfacesTable, #connectionsTable, #sharesTable').DataTable({
        pageLength: 25,
        responsive: true,
        language: {
            url: '//cdn.datatables.net/plug-ins/1.13.6/i18n/it-IT.json'
        },
        order: [[0, 'asc']]
    });

    // Ordinamento speciale per processesTable (memoria)
    $('#processesTable').DataTable().destroy();
    $('#processesTable').DataTable({
        pageLength: 25,
        responsive: true,
        language: {
            url: '//cdn.datatables.net/plug-ins/1.13.6/i18n/it-IT.json'
        },
        order: [[3, 'desc']] // Ordina per memoria (colonna 3)
    });
});

// Funzione per copiare negli appunti
function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(function() {
        // Feedback visivo
        const button = event.target.closest('button');
        const icon = button.querySelector('i');
        const originalClass = icon.className;
        icon.className = 'bi bi-check';
        setTimeout(function() {
            icon.className = originalClass;
        }, 2000);
    });
}
</script>
{% endblock %}