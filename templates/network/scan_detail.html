{% extends "base.html" %}

{% block title %}Dettaglio Scan - {{ scan.filename or 'N/A' }}{% endblock %}
{% block page_title %}Dettaglio Scan{% endblock %}

{% block breadcrumbs %}
<li class="breadcrumb-item"><a href="{{ url_for('index') }}">Home</a></li>
<li class="breadcrumb-item"><a href="{{ url_for('network.dashboard') }}">Network</a></li>
<li class="breadcrumb-item"><a href="{{ url_for('network.scans') }}">Scan</a></li>
<li class="breadcrumb-item active" aria-current="page">{{ scan.filename or scan.id }}</li>
{% endblock %}

{% block extra_css %}
<!-- DataTables -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/datatables.net-bs5@1.13.6/css/dataTables.bootstrap5.min.css">
<!-- Highlight.js per syntax highlighting -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/default.min.css">
{% endblock %}

{% block content %}
<!-- Informazioni scan -->
<div class="row mb-4">
  <div class="col-lg-8">
    <div class="card">
      <div class="card-header">
        <h3 class="card-title">
          <i class="bi bi-file-text me-1"></i>
          Informazioni Scan
        </h3>
        <div class="card-tools">
          <span class="badge bg-{{ 'success' if scan.end_time else 'warning' }}">
            {{ 'Completato' if scan.end_time else 'In corso' }}
          </span>
        </div>
      </div>
      <div class="card-body">
        <dl class="row">
          <dt class="col-sm-3">File:</dt>
          <dd class="col-sm-9">
            <strong>{{ scan.filename or 'N/A' }}</strong>
            {% if scan.file_hash %}
            <br><small class="text-muted font-monospace">{{ scan.file_hash[:16] }}...</small>
            {% endif %}
          </dd>

          <dt class="col-sm-3">Scanner:</dt>
          <dd class="col-sm-9">
            <span class="badge bg-secondary">{{ scan.scanner or 'N/A' }}</span>
            {% if scan.version %}
            <span class="badge bg-info">v{{ scan.version }}</span>
            {% endif %}
          </dd>

          <dt class="col-sm-3">Periodo Scan:</dt>
          <dd class="col-sm-9">
            {% if scan.start_time %}
            <div>
              <i class="bi bi-play-circle text-success me-1"></i>
              <strong>Inizio:</strong> {{ scan.start_time | timestamp }}
            </div>
            {% if scan.end_time %}
            <div>
              <i class="bi bi-stop-circle text-danger me-1"></i>
              <strong>Fine:</strong> {{ scan.end_time | timestamp }}
            </div>
            <div class="mt-1">
              <i class="bi bi-stopwatch text-info me-1"></i>
              <strong>Durata:</strong>
              {% set duration = scan.end_time - scan.start_time %}
              {% if duration > 3600 %}
              {{ (duration / 3600) | round(1) }} ore
              {% elif duration > 60 %}
              {{ (duration / 60) | round(1) }} minuti
              {% else %}
              {{ duration }} secondi
              {% endif %}
            </div>
            {% endif %}
            {% else %}
            <span class="text-muted">Informazioni temporali non disponibili</span>
            {% endif %}
          </dd>

          {% if scan.xml_output_version %}
          <dt class="col-sm-3">XML Version:</dt>
          <dd class="col-sm-9">
            <code>{{ scan.xml_output_version }}</code>
          </dd>
          {% endif %}

          {% if scan.args %}
          <dt class="col-sm-3">Argomenti:</dt>
          <dd class="col-sm-9">
            <pre class="bg-dark text-light p-2 rounded small"><code>{{ scan.args }}</code></pre>
            <button class="btn btn-outline-primary btn-sm mt-1" onclick="copyToClipboard('{{ scan.args | e }}')">
              <i class="bi bi-clipboard me-1"></i>Copia Comando
            </button>
          </dd>
          {% endif %}
        </dl>
      </div>
    </div>
  </div>

  <div class="col-lg-4">
    <div class="card">
      <div class="card-header">
        <h3 class="card-title">
          <i class="bi bi-bar-chart me-1"></i>
          Statistiche Scan
        </h3>
      </div>
      <div class="card-body">
        <div class="row text-center">
          <div class="col-6">
            <div class="border-end">
              <h4 class="text-primary">{{ stats.total_hosts or 0 }}</h4>
              <small class="text-muted">Host Totali</small>
            </div>
          </div>
          <div class="col-6">
            <h4 class="text-success">{{ stats.active_hosts or 0 }}</h4>
            <small class="text-muted">Host Attivi</small>
          </div>
        </div>
        <hr>
        <div class="row text-center">
          <div class="col-6">
            <div class="border-end">
              <h4 class="text-info">{{ stats.total_ports or 0 }}</h4>
              <small class="text-muted">Porte Totali</small>
            </div>
          </div>
          <div class="col-6">
            <h4 class="text-warning">{{ stats.open_ports or 0 }}</h4>
            <small class="text-muted">Porte Aperte</small>
          </div>
        </div>

        <div class="mt-3">
          <div class="progress">
            {% set active_percentage = (stats.active_hosts / stats.total_hosts * 100) if stats.total_hosts else 0 %}
            <div class="progress-bar bg-success" style="width: {{ active_percentage }}%">
              {{ active_percentage | round(1) }}% Attivi
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Azioni rapide -->
    <div class="card mt-3">
      <div class="card-header">
        <h3 class="card-title">
          <i class="bi bi-lightning me-1"></i>
          Azioni Rapide
        </h3>
      </div>
      <div class="card-body">
        <div class="d-grid gap-2">
          <a href="{{ url_for('network.hosts') }}?scan_id={{ scan.id }}" class="btn btn-outline-primary">
            <i class="bi bi-pc-display me-1"></i>
            Vedi Host ({{ stats.total_hosts or 0 }})
          </a>
          <a href="{{ url_for('network.ports') }}?scan_id={{ scan.id }}" class="btn btn-outline-success">
            <i class="bi bi-door-open me-1"></i>
            Vedi Porte ({{ stats.total_ports or 0 }})
          </a>
          <a href="{{ url_for('network.vulnerabilities') }}?scan_id={{ scan.id }}" class="btn btn-outline-danger">
            <i class="bi bi-bug me-1"></i>
            Vedi Vulnerabilità
          </a>
          <div class="btn-group">
            <button type="button" class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">
              <i class="bi bi-download"></i> Export
            </button>
            <ul class="dropdown-menu w-100">
              <li><a class="dropdown-item" href="#" onclick="exportScanData('csv')">
                <i class="bi bi-filetype-csv me-1"></i>CSV
              </a></li>
              <li><a class="dropdown-item" href="#" onclick="exportScanData('json')">
                <i class="bi bi-filetype-json me-1"></i>JSON
              </a></li>
              <li><a class="dropdown-item" href="#" onclick="exportScanData('xml')">
                <i class="bi bi-filetype-xml me-1"></i>XML Originale
              </a></li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Host trovati -->
<div class="row">
  <div class="col-12">
    <div class="card">
      <div class="card-header">
        <h3 class="card-title">
          <i class="bi bi-pc-display me-1"></i>
          Host Rilevati
        </h3>
        <div class="card-tools">
          <span class="badge bg-info">{{ hosts | length }} host</span>
          <button type="button" class="btn btn-tool" data-lte-toggle="card-collapse">
            <i data-lte-icon="expand" class="bi bi-plus-lg"></i>
            <i data-lte-icon="collapse" class="bi bi-dash-lg"></i>
          </button>
        </div>
      </div>
      <div class="card-body table-responsive p-0">
        {% if hosts %}
        <table class="table table-striped table-hover" id="hostsTable">
          <thead>
            <tr>
              <th><i class="bi bi-hdd-network me-1"></i>IP Address</th>
              <th><i class="bi bi-activity me-1"></i>Status</th>
              <th><i class="bi bi-ethernet me-1"></i>MAC Address</th>
              <th><i class="bi bi-building me-1"></i>Vendor</th>
              <th><i class="bi bi-door-open me-1"></i>Porte</th>
              <th><i class="bi bi-shield-exclamation me-1"></i>Vulnerabilità</th>
              <th><i class="bi bi-three-dots me-1"></i>Azioni</th>
            </tr>
          </thead>
          <tbody>
            {% for host in hosts %}
            <tr class="{{ 'table-success' if host.status === 'up' else 'table-secondary' if host.status === 'down' else '' }}">
              <td>
                <div class="d-flex align-items-center">
                  <i class="bi bi-{{ 'wifi' if host.status === 'up' else 'wifi-off' }} me-2 text-{{ 'success' if host.status === 'up' else 'muted' }}"></i>
                  <strong>{{ host.ip_address }}</strong>
                </div>
              </td>
              <td>
                {% if host.status == 'up' %}
                <span class="badge bg-success">
                  <i class="bi bi-check-circle me-1"></i>Attivo
                </span>
                {% elif host.status == 'down' %}
                <span class="badge bg-secondary">
                  <i class="bi bi-x-circle me-1"></i>Inattivo
                </span>
                {% else %}
                <span class="badge bg-warning">
                  <i class="bi bi-question-circle me-1"></i>{{ host.status or 'Sconosciuto' }}
                </span>
                {% endif %}
              </td>
              <td>
                {% if host.mac_address %}
                <code class="small">{{ host.mac_address }}</code>
                {% else %}
                <span class="text-muted">N/A</span>
                {% endif %}
              </td>
              <td>
                {% if host.vendor %}
                <span class="badge bg-info">{{ host.vendor }}</span>
                {% else %}
                <span class="text-muted">Sconosciuto</span>
                {% endif %}
              </td>
              <td>
                <div class="port-stats">
                  <span class="badge bg-primary">{{ host.port_count or 0 }}</span>
                  <small class="text-muted">totali</small>
                  {% if host.open_ports %}
                  <br>
                  <span class="badge bg-success">{{ host.open_ports }}</span>
                  <small class="text-muted">aperte</small>
                  {% endif %}
                </div>
              </td>
              <td>
                {% if host.vuln_count %}
                <span class="badge bg-danger">{{ host.vuln_count }}</span>
                {% else %}
                <span class="badge bg-success">0</span>
                {% endif %}
              </td>
              <td>
                <div class="btn-group btn-group-sm">
                  <a href="{{ url_for('network.host_detail', host_id=host.id) }}"
                     class="btn btn-outline-primary btn-sm" title="Dettagli host">
                    <i class="bi bi-eye"></i>
                  </a>
                  <button type="button" class="btn btn-outline-info btn-sm"
                          onclick="showHostPorts({{ host.id }})" title="Mostra porte">
                    <i class="bi bi-door-open"></i>
                  </button>
                  <div class="btn-group btn-group-sm">
                    <button type="button" class="btn btn-outline-secondary btn-sm dropdown-toggle"
                            data-bs-toggle="dropdown" title="Più azioni">
                      <i class="bi bi-three-dots"></i>
                    </button>
                    <ul class="dropdown-menu">
                      <li><a class="dropdown-item" href="{{ url_for('network.ports') }}?host_id={{ host.id }}">
                        <i class="bi bi-door-open me-1"></i>Vedi Porte
                      </a></li>
                      {% if host.vuln_count %}
                      <li><a class="dropdown-item" href="{{ url_for('network.vulnerabilities') }}?host_id={{ host.id }}">
                        <i class="bi bi-bug me-1"></i>Vedi Vulnerabilità
                      </a></li>
                      {% endif %}
                      <li><hr class="dropdown-divider"></li>
                      <li><a class="dropdown-item" href="#" onclick="pingHost('{{ host.ip_address }}')">
                        <i class="bi bi-arrow-repeat me-1"></i>Test Ping
                      </a></li>
                      <li><a class="dropdown-item" href="#" onclick="exportHostData({{ host.id }})">
                        <i class="bi bi-download me-1"></i>Export Host
                      </a></li>
                    </ul>
                  </div>
                </div>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
        {% else %}
        <!-- Nessun host -->
        <div class="text-center py-5">
          <i class="bi bi-pc-display display-1 text-muted"></i>
          <h4 class="mt-3">Nessun host trovato</h4>
          <p class="text-muted">
            Questo scan non ha rilevato alcun host.
          </p>
        </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<!-- Modal per porte host -->
<div class="modal fade" id="hostPortsModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="bi bi-door-open me-1"></i>
          Porte Host
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="hostPortsContent">
        <div class="text-center">
          <div class="spinner-border" role="status">
            <span class="visually-hidden">Caricamento...</span>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Chiudi</button>
        <button type="button" class="btn btn-primary" id="viewHostDetail">Vedi Dettagli Host</button>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block extra_js %}
<!-- DataTables -->
<script src="https://cdn.jsdelivr.net/npm/datatables.net@1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/datatables.net-bs5@1.13.6/js/dataTables.bootstrap5.min.js"></script>
<!-- Highlight.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

<script>
// Inizializza DataTables
$(document).ready(function() {
    if ($('#hostsTable tbody tr').length > 0) {
        $('#hostsTable').DataTable({
            "pageLength": 25,
            "ordering": true,
            "searching": true,
            "info": true,
            "lengthChange": true,
            "order": [[0, "asc"]], // Ordina per IP
            "columnDefs": [
                {"orderable": false, "targets": [6]} // Disabilita ordinamento per azioni
            ]
        });
    }

    // Inizializza syntax highlighting
    hljs.highlightAll();
});

// Copia comando negli appunti
function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(function() {
        // Feedback visivo
        const btn = event.target.closest('button');
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="bi bi-check me-1"></i>Copiato!';
        btn.classList.add('btn-success');
        btn.classList.remove('btn-outline-primary');

        setTimeout(() => {
            btn.innerHTML = originalText;
            btn.classList.remove('btn-success');
            btn.classList.add('btn-outline-primary');
        }, 2000);
    });
}

// Mostra porte host
function showHostPorts(hostId) {
    $('#hostPortsModal').modal('show');

    fetch(`/api/host/${hostId}/ports`)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                $('#hostPortsContent').html(`
                    <div class="alert alert-danger">
                        <i class="bi bi-exclamation-triangle me-1"></i>
                        Errore: ${data.error}
                    </div>
                `);
                return;
            }

            const ports = data.ports || [];
            const host = data.host;

            if (ports.length === 0) {
                $('#hostPortsContent').html(`
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle me-1"></i>
                        Nessuna porta trovata per questo host.
                    </div>
                `);
                return;
            }

            let portsHtml = `
                <div class="mb-3">
                    <h6>Host: <strong>${host.ip_address}</strong></h6>
                    <p class="text-muted">Trovate ${ports.length} porte</p>
                </div>
                <div class="table-responsive">
                    <table class="table table-sm table-striped">
                        <thead>
                            <tr>
                                <th>Porta</th>
                                <th>Stato</th>
                                <th>Servizio</th>
                                <th>Versione</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            ports.forEach(port => {
                const stateClass = port.state === 'open' ? 'success' :
                                 port.state === 'closed' ? 'secondary' : 'warning';
                portsHtml += `
                    <tr>
                        <td><strong>${port.port_number}/${port.protocol}</strong></td>
                        <td><span class="badge bg-${stateClass}">${port.state}</span></td>
                        <td>${port.service || 'N/A'}</td>
                        <td><small>${port.version || 'N/A'}</small></td>
                    </tr>
                `;
            });

            portsHtml += `
                        </tbody>
                    </table>
                </div>
            `;

            $('#hostPortsContent').html(portsHtml);

            $('#viewHostDetail').off('click').on('click', function() {
                window.location.href = `/network/host/${hostId}`;
            });
        })
        .catch(error => {
            $('#hostPortsContent').html(`
                <div class="alert alert-danger">
                    <i class="bi bi-exclamation-triangle me-1"></i>
                    Errore nel caricamento: ${error.message}
                </div>
            `);
        });
}

// Export dati scan
function exportScanData(format) {
    window.open(`/api/scan/{{ scan.id }}/export?format=${format}`, '_blank');
}

// Export dati host
function exportHostData(hostId) {
    window.open(`/api/host/${hostId}/export`, '_blank');
}

// Test ping
function pingHost(ipAddress) {
    // Questa è una funzione di esempio - in un ambiente reale
    // dovresti implementare un endpoint backend per il ping
    alert(`Test ping per ${ipAddress}\n\nQuesta funzionalità richiede implementazione backend.`);
}
</script>
{% endblock %}