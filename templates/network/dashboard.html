{% extends "base.html" %}

{% block title %}Network Dashboard - Nmap Scanner{% endblock %}
{% block page_title %}Network Dashboard{% endblock %}

{% block breadcrumbs %}
<li class="breadcrumb-item"><a href="{{ url_for('index') }}">Home</a></li>
<li class="breadcrumb-item active" aria-current="page">Network Dashboard</li>
{% endblock %}

{% block extra_css %}
<!-- Chart.js -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/chart.js@4.0.0/dist/chart.min.css">
<!-- DataTables -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/datatables.net-bs5@1.13.6/css/dataTables.bootstrap5.min.css">
{% endblock %}

{% block content %}
<!-- Statistiche principali -->
<div class="row mb-4">
  <div class="col-lg-3 col-6">
    <div class="small-box text-bg-info">
      <div class="inner">
        <h3>{{ stats.total_networks or 0 }}</h3>
        <p>Reti Rilevate</p>
      </div>
      <svg class="small-box-icon" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
        <path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"></path>
        <polyline points="9,22 9,12 15,12 15,22"></polyline>
      </svg>
      <a href="{{ url_for('network.hosts') }}" class="small-box-footer link-light">
        Vedi dettagli <i class="bi bi-link-45deg"></i>
      </a>
    </div>
  </div>

  <div class="col-lg-3 col-6">
    <div class="small-box text-bg-success">
      <div class="inner">
        <h3>{{ stats.active_hosts or 0 }}</h3>
        <p>Host Attivi</p>
      </div>
      <svg class="small-box-icon" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
        <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
      </svg>
      <a href="{{ url_for('network.hosts', status='up') }}" class="small-box-footer link-light">
        Vedi host attivi <i class="bi bi-link-45deg"></i>
      </a>
    </div>
  </div>

  <div class="col-lg-3 col-6">
    <div class="small-box text-bg-warning">
      <div class="inner">
        <h3>{{ stats.open_ports or 0 }}</h3>
        <p>Porte Aperte</p>
      </div>
      <svg class="small-box-icon" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
        <path d="M8 17l4-4 4 4m-4-5v9"></path>
        <path d="M3 4h18a2 2 0 012 2v12a2 2 0 01-2 2H3a2 2 0 01-2-2V6a2 2 0 012-2z"></path>
      </svg>
      <a href="{{ url_for('network.ports', state='open') }}" class="small-box-footer link-light">
        Vedi porte <i class="bi bi-link-45deg"></i>
      </a>
    </div>
  </div>

  <div class="col-lg-3 col-6">
    <div class="small-box text-bg-danger">
      <div class="inner">
        <h3>{{ stats.vulnerabilities or 0 }}</h3>
        <p>Vulnerabilità</p>
      </div>
      <svg class="small-box-icon" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
        <path d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
      </svg>
      <a href="{{ url_for('network.vulnerabilities') }}" class="small-box-footer link-light">
        Vedi vulnerabilità <i class="bi bi-link-45deg"></i>
      </a>
    </div>
  </div>
</div>

<div class="row">
  <!-- Top Networks -->
  <div class="col-lg-6">
    <div class="card">
      <div class="card-header">
        <h3 class="card-title">
          <i class="bi bi-diagram-3 me-1"></i>
          Top Networks
        </h3>
        <div class="card-tools">
          <button type="button" class="btn btn-tool" data-lte-toggle="card-collapse">
            <i data-lte-icon="expand" class="bi bi-plus-lg"></i>
            <i data-lte-icon="collapse" class="bi bi-dash-lg"></i>
          </button>
        </div>
      </div>
      <div class="card-body">
        {% if top_networks %}
        <div class="table-responsive">
          <table class="table table-sm">
            <thead>
              <tr>
                <th>Rete</th>
                <th>Host Totali</th>
                <th>Host Attivi</th>
                <th>%</th>
              </tr>
            </thead>
            <tbody>
              {% for network in top_networks %}
              <tr>
                <td>
                  <a href="{{ url_for('network.hosts') }}?search={{ network.network }}" class="text-decoration-none">
                    {{ network.network }}.x
                  </a>
                </td>
                <td>{{ network.host_count }}</td>
                <td>
                  <span class="badge bg-success">{{ network.active_count or 0 }}</span>
                </td>
                <td>
                  {% set percentage = ((network.active_count or 0) / network.host_count * 100) | round(1) %}
                  <div class="progress" style="height: 20px;">
                    <div class="progress-bar bg-success" style="width: {{ percentage }}%">
                      {{ percentage }}%
                    </div>
                  </div>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        {% else %}
        <p class="text-muted">Nessuna rete trovata.</p>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Top Services -->
  <div class="col-lg-6">
    <div class="card">
      <div class="card-header">
        <h3 class="card-title">
          <i class="bi bi-gear me-1"></i>
          Servizi Più Comuni
        </h3>
        <div class="card-tools">
          <button type="button" class="btn btn-tool" data-lte-toggle="card-collapse">
            <i data-lte-icon="expand" class="bi bi-plus-lg"></i>
            <i data-lte-icon="collapse" class="bi bi-dash-lg"></i>
          </button>
        </div>
      </div>
      <div class="card-body">
        {% if top_services %}
        <div class="table-responsive">
          <table class="table table-sm">
            <thead>
              <tr>
                <th>Servizio</th>
                <th>Totali</th>
                <th>Aperti</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody>
              {% for service in top_services %}
              <tr>
                <td>
                  <a href="{{ url_for('network.ports') }}?service={{ service.service }}" class="text-decoration-none">
                    <i class="bi bi-gear-fill text-primary me-1"></i>
                    {{ service.service }}
                  </a>
                </td>
                <td>{{ service.count }}</td>
                <td>
                  <span class="badge bg-success">{{ service.open_count or 0 }}</span>
                </td>
                <td>
                  {% set open_percentage = ((service.open_count or 0) / service.count * 100) | round(1) %}
                  <div class="progress" style="height: 20px;">
                    <div class="progress-bar
                      {% if open_percentage > 80 %}bg-success{% elif open_percentage > 50 %}bg-warning{% else %}bg-danger{% endif %}"
                      style="width: {{ open_percentage }}%">
                      {{ open_percentage }}%
                    </div>
                  </div>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        {% else %}
        <p class="text-muted">Nessun servizio trovato.</p>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<!-- Host con vulnerabilità -->
{% if vuln_hosts %}
<div class="row mt-4">
  <div class="col-12">
    <div class="card">
      <div class="card-header">
        <h3 class="card-title">
          <i class="bi bi-shield-exclamation me-1"></i>
          Host con Vulnerabilità
        </h3>
        <div class="card-tools">
          <span class="badge bg-danger">{{ vuln_hosts | length }} host a rischio</span>
        </div>
      </div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-striped" id="vulnHostsTable">
            <thead>
              <tr>
                <th>IP Address</th>
                <th>Vulnerabilità</th>
                <th>CVSS Max</th>
                <th>Severità</th>
                <th>Azioni</th>
              </tr>
            </thead>
            <tbody>
              {% for host in vuln_hosts %}
              <tr>
                <td>
                  <a href="{{ url_for('network.host_detail', host_id=host.id) }}" class="fw-bold text-decoration-none">
                    {{ host.ip_address }}
                  </a>
                </td>
                <td>
                  <span class="badge bg-warning">{{ host.vuln_count }}</span>
                </td>
                <td>
                  {% if host.max_cvss %}
                    <span class="badge
                      {% if host.max_cvss >= 9 %}bg-danger{% elif host.max_cvss >= 7 %}bg-warning{% else %}bg-info{% endif %}">
                      {{ host.max_cvss }}
                    </span>
                  {% else %}
                    <span class="badge bg-secondary">N/A</span>
                  {% endif %}
                </td>
                <td>
                  {% if host.max_cvss >= 9 %}
                    <span class="badge bg-danger">Critica</span>
                  {% elif host.max_cvss >= 7 %}
                    <span class="badge bg-warning">Alta</span>
                  {% elif host.max_cvss >= 4 %}
                    <span class="badge bg-info">Media</span>
                  {% else %}
                    <span class="badge bg-secondary">Bassa</span>
                  {% endif %}
                </td>
                <td>
                  <div class="btn-group btn-group-sm">
                    <a href="{{ url_for('network.host_detail', host_id=host.id) }}" class="btn btn-primary btn-sm">
                      <i class="bi bi-eye"></i>
                    </a>
                    <a href="{{ url_for('network.vulnerabilities') }}?search={{ host.ip_address }}" class="btn btn-warning btn-sm">
                      <i class="bi bi-bug"></i>
                    </a>
                  </div>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>
{% endif %}

<!-- Azioni rapide -->
<div class="row mt-4">
  <div class="col-12">
    <div class="card">
      <div class="card-header">
        <h3 class="card-title">
          <i class="bi bi-lightning me-1"></i>
          Azioni Rapide
        </h3>
      </div>
      <div class="card-body">
        <div class="row">
          <div class="col-md-3 mb-2">
            <a href="{{ url_for('network.search') }}" class="btn btn-outline-primary btn-block w-100">
              <i class="bi bi-search me-1"></i>
              Ricerca Avanzata
            </a>
          </div>
          <div class="col-md-3 mb-2">
            <a href="{{ url_for('network.hosts', status='up') }}" class="btn btn-outline-success btn-block w-100">
              <i class="bi bi-pc-display me-1"></i>
              Host Attivi
            </a>
          </div>
          <div class="col-md-3 mb-2">
            <a href="{{ url_for('network.ports', state='open') }}" class="btn btn-outline-warning btn-block w-100">
              <i class="bi bi-door-open me-1"></i>
              Porte Aperte
            </a>
          </div>
          <div class="col-md-3 mb-2">
            <a href="{{ url_for('network.vulnerabilities') }}" class="btn btn-outline-danger btn-block w-100">
              <i class="bi bi-shield-exclamation me-1"></i>
              Vulnerabilità
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.0.0/dist/chart.min.js"></script>
<!-- DataTables -->
<script src="https://cdn.jsdelivr.net/npm/datatables.net@1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/datatables.net-bs5@1.13.6/js/dataTables.bootstrap5.min.js"></script>

<script>
$(document).ready(function() {
    // Inizializza DataTable per le vulnerabilità
    {% if vuln_hosts %}
    $('#vulnHostsTable').DataTable({
        "pageLength": 10,
        "language": {
            "search": "Cerca:",
            "lengthMenu": "Mostra _MENU_ elementi per pagina",
            "info": "Mostra da _START_ a _END_ di _TOTAL_ elementi",
            "paginate": {
                "first": "Primo",
                "last": "Ultimo",
                "next": "Successivo",
                "previous": "Precedente"
            }
        },
        "order": [[ 2, "desc" ]] // Ordina per CVSS score
    });
    {% endif %}
});
</script>
{% endblock %}