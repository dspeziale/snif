{% extends "base.html" %}

{% block title %}Scan Information - AdminLTE{% endblock %}
{% block page_title %}Scan Information{% endblock %}

{% block breadcrumbs %}
<li class="breadcrumb-item"><a href="{{ url_for('index') }}">Home</a></li>
<li class="breadcrumb-item"><a href="{{ url_for('network.overview') }}">Network</a></li>
<li class="breadcrumb-item active">Scan Information</li>
{% endblock %}

{% block content %}
<div class="container-fluid">
  {% if error %}
  <div class="alert alert-danger">
    <i class="bi bi-exclamation-triangle"></i> Error: {{ error }}
  </div>
  {% else %}

  <!-- Scan Statistics Overview -->
  <div class="row mb-4">
    <div class="col-lg-3 col-6">
      <div class="small-box bg-info">
        <div class="inner">
          <h3>{{ scan_stats.total_scans if scan_stats else 0 }}</h3>
          <p>Total Scans</p>
        </div>
        <div class="icon">
          <i class="bi bi-search"></i>
        </div>
      </div>
    </div>
    <div class="col-lg-3 col-6">
      <div class="small-box bg-success">
        <div class="inner">
          <h3>{{ scan_stats.total_hosts_scanned if scan_stats else 0 }}</h3>
          <p>Hosts Scanned</p>
        </div>
        <div class="icon">
          <i class="bi bi-hdd-network"></i>
        </div>
      </div>
    </div>
    <div class="col-lg-3 col-6">
      <div class="small-box bg-warning">
        <div class="inner">
          <h3>{{ scan_stats.total_hosts_up if scan_stats else 0 }}</h3>
          <p>Hosts Up</p>
        </div>
        <div class="icon">
          <i class="bi bi-check-circle"></i>
        </div>
      </div>
    </div>
    <div class="col-lg-3 col-6">
      <div class="small-box bg-danger">
        <div class="inner">
          <h3>{{ scan_stats.total_elapsed_hours if scan_stats else 0 }}h</h3>
          <p>Total Scan Time</p>
        </div>
        <div class="icon">
          <i class="bi bi-clock"></i>
        </div>
      </div>
    </div>
  </div>

  <!-- Last Scan Information -->
  {% if scan_stats and scan_stats.last_scan_date %}
  <div class="row mb-4">
    <div class="col-12">
      <div class="card bg-gradient-primary">
        <div class="card-header">
          <h3 class="card-title text-white">
            <i class="bi bi-info-circle"></i> Last Scan Information
          </h3>
        </div>
        <div class="card-body text-white">
          <div class="row">
            <div class="col-md-4">
              <div class="info-box-content">
                <span class="info-box-text text-white-50">Last Scan Date</span>
                <span class="info-box-number">{{ scan_stats.last_scan_date[:19] }}</span>
              </div>
            </div>
            <div class="col-md-4">
              <div class="info-box-content">
                <span class="info-box-text text-white-50">Hosts Scanned</span>
                <span class="info-box-number">{{ scan_stats.last_scan_hosts }}</span>
              </div>
            </div>
            <div class="col-md-4">
              <div class="info-box-content">
                <span class="info-box-text text-white-50">Status</span>
                <span class="info-box-number">
                  <i class="bi bi-check-circle"></i> Completed
                </span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  {% endif %}

  <!-- Scan Timeline Chart -->
  {% if scans %}
  <div class="row mb-4">
    <div class="col-md-8">
      <div class="card">
        <div class="card-header">
          <h3 class="card-title">
            <i class="bi bi-graph-up"></i> Scan Timeline
          </h3>
          <div class="card-tools">
            <button type="button" class="btn btn-sm btn-primary" onclick="exportScanTimeline()">
              <i class="bi bi-download"></i> Export
            </button>
          </div>
        </div>
        <div class="card-body">
          <canvas id="scanTimelineChart" height="300"></canvas>
        </div>
      </div>
    </div>

    <div class="col-md-4">
      <div class="card">
        <div class="card-header">
          <h3 class="card-title">
            <i class="bi bi-pie-chart"></i> Scan Types Distribution
          </h3>
        </div>
        <div class="card-body">
          <canvas id="scanTypesChart" height="300"></canvas>
        </div>
      </div>
    </div>
  </div>
  {% endif %}

  <!-- Detailed Scan List -->
  {% if scans %}
  <div class="row">
    <div class="col-12">
      <div class="card">
        <div class="card-header">
          <h3 class="card-title">
            <i class="bi bi-list-ul"></i> Detailed Scan History
          </h3>
          <div class="card-tools">
            <div class="input-group input-group-sm" style="width: 250px;">
              <input type="text" class="form-control" id="scanSearch" placeholder="Search scans...">
              <div class="input-group-append">
                <button type="button" class="btn btn-default">
                  <i class="bi bi-search"></i>
                </button>
              </div>
            </div>
            <button type="button" class="btn btn-sm btn-success ms-2" onclick="exportAllScans()">
              <i class="bi bi-download"></i> Export All
            </button>
          </div>
        </div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-striped table-hover" id="scansTable">
              <thead>
                <tr>
                  <th>Scan Date</th>
                  <th>Scanner</th>
                  <th>Version</th>
                  <th>Command</th>
                  <th>Duration</th>
                  <th>Hosts</th>
                  <th>Up Hosts</th>
                  <th class="text-center">Actions</th>
                </tr>
              </thead>
              <tbody>
                {% for scan in scans %}
                <tr>
                  <td>
                    <div>
                      <strong>{{ scan.start_time[:10] if scan.start_time else 'Unknown' }}</strong>
                      <br><small class="text-muted">{{ scan.start_time[11:19] if scan.start_time else '' }}</small>
                    </div>
                  </td>
                  <td>
                    <div class="d-flex align-items-center">
                      <i class="bi bi-terminal me-2"></i>
                      <div>
                        <strong>{{ scan.scanner or 'nmap' }}</strong>
                        {% if scan.scan_type %}
                        <br><small class="text-info">{{ scan.scan_type }}</small>
                        {% endif %}
                      </div>
                    </div>
                  </td>
                  <td>
                    {% if scan.nmap_version %}
                    <code class="text-success">{{ scan.nmap_version }}</code>
                    {% else %}
                    <span class="text-muted">Unknown</span>
                    {% endif %}
                  </td>
                  <td>
                    {% if scan.command_line %}
                    <div class="text-truncate" style="max-width: 200px;" title="{{ scan.command_line }}">
                      <small><code>{{ scan.command_line[:50] }}{% if scan.command_line|length > 50 %}...{% endif %}</code></small>
                    </div>
                    {% else %}
                    <span class="text-muted">N/A</span>
                    {% endif %}
                  </td>
                  <td>
                    {% if scan.elapsed_time %}
                    <div>
                      <strong>{{ "%.1f"|format(scan.elapsed_time / 60) }}m</strong>
                      <br><small class="text-muted">{{ "%.0f"|format(scan.elapsed_time) }}s</small>
                    </div>
                    {% else %}
                    <span class="text-muted">Unknown</span>
                    {% endif %}
                  </td>
                  <td>
                    <span class="badge bg-info">{{ scan.total_hosts or 0 }}</span>
                  </td>
                  <td>
                    <span class="badge bg-success">{{ scan.up_hosts or 0 }}</span>
                    {% if scan.total_hosts and scan.total_hosts > 0 %}
                    <br><small class="text-muted">{{ "%.1f"|format((scan.up_hosts or 0) / scan.total_hosts * 100) }}%</small>
                    {% endif %}
                  </td>
                  <td class="text-center">
                    <div class="btn-group btn-group-sm">
                      <button type="button" class="btn btn-outline-primary"
                              onclick="viewScanDetails('{{ scan.id }}')" title="View Details">
                        <i class="bi bi-eye"></i>
                      </button>
                      {% if scan.command_line %}
                      <button type="button" class="btn btn-outline-secondary"
                              onclick="copyToClipboard('{{ scan.command_line }}')" title="Copy Command">
                        <i class="bi bi-clipboard"></i>
                      </button>
                      {% endif %}
                      {% if scan.file_source %}
                      <button type="button" class="btn btn-outline-info"
                              title="Source: {{ scan.file_source }}">
                        <i class="bi bi-file-text"></i>
                      </button>
                      {% endif %}
                    </div>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
  {% else %}
  <div class="row">
    <div class="col-12">
      <div class="card">
        <div class="card-body text-center py-5">
          <i class="bi bi-search display-1 text-muted"></i>
          <h4 class="text-muted mt-3">No Scan Information Available</h4>
          <p class="text-muted">No scan information found. This could mean:</p>
          <ul class="list-unstyled text-muted">
            <li>• No scans have been performed yet</li>
            <li>• Scan information was not recorded</li>
            <li>• The scan data is stored elsewhere</li>
          </ul>
          <a href="{{ url_for('network.overview') }}" class="btn btn-primary">
            <i class="bi bi-arrow-left"></i> Back to Network Overview
          </a>
        </div>
      </div>
    </div>
  </div>
  {% endif %}

  {% endif %}
</div>

<!-- Scan Detail Modal -->
<div class="modal fade" id="scanDetailModal" tabindex="-1">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h4 class="modal-title">Scan Details</h4>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="scanDetailContent">
        <!-- Content will be loaded via JavaScript -->
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- Include Chart.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>

<script>
// Scan Timeline Chart
{% if scans %}
document.addEventListener('DOMContentLoaded', function() {
  const timelineCtx = document.getElementById('scanTimelineChart');
  if (timelineCtx) {
    const scanDates = [{% for scan in scans %}'{{ scan.start_time[:10] if scan.start_time else "Unknown" }}'{% if not loop.last %}, {% endif %}{% endfor %}];
    const hostsCounts = [{% for scan in scans %}{{ scan.total_hosts or 0 }}{% if not loop.last %}, {% endif %}{% endfor %}];
    const upHostsCounts = [{% for scan in scans %}{{ scan.up_hosts or 0 }}{% if not loop.last %}, {% endif %}{% endfor %}];

    new Chart(timelineCtx, {
      type: 'line',
      data: {
        labels: scanDates.reverse(),
        datasets: [{
          label: 'Total Hosts',
          data: hostsCounts.reverse(),
          borderColor: 'rgb(54, 162, 235)',
          backgroundColor: 'rgba(54, 162, 235, 0.1)',
          tension: 0.1
        }, {
          label: 'Hosts Up',
          data: upHostsCounts.reverse(),
          borderColor: 'rgb(75, 192, 192)',
          backgroundColor: 'rgba(75, 192, 192, 0.1)',
          tension: 0.1
        }]
      },
      options: {
        responsive: true,
        plugins: {
          title: {
            display: true,
            text: 'Scan Results Over Time'
          }
        },
        scales: {
          y: {
            beginAtZero: true
          }
        }
      }
    });
  }
});

// Scan Types Chart
document.addEventListener('DOMContentLoaded', function() {
  const typesCtx = document.getElementById('scanTypesChart');
  if (typesCtx) {
    // Count scan types
    const scanTypes = {};
    {% for scan in scans %}
    const scanType = '{{ scan.scan_type or "Unknown" }}';
    scanTypes[scanType] = (scanTypes[scanType] || 0) + 1;
    {% endfor %}

    const labels = Object.keys(scanTypes);
    const data = Object.values(scanTypes);

    new Chart(typesCtx, {
      type: 'doughnut',
      data: {
        labels: labels,
        datasets: [{
          data: data,
          backgroundColor: [
            'rgba(255, 99, 132, 0.8)',
            'rgba(54, 162, 235, 0.8)',
            'rgba(255, 205, 86, 0.8)',
            'rgba(75, 192, 192, 0.8)',
            'rgba(153, 102, 255, 0.8)',
            'rgba(255, 159, 64, 0.8)'
          ],
          borderWidth: 2
        }]
      },
      options: {
        responsive: true,
        plugins: {
          title: {
            display: true,
            text: 'Scan Types Distribution'
          },
          legend: {
            position: 'bottom'
          }
        }
      }
    });
  }
});
{% endif %}

// Search functionality
document.addEventListener('DOMContentLoaded', function() {
  const searchInput = document.getElementById('scanSearch');
  const table = document.getElementById('scansTable');

  if (searchInput && table) {
    searchInput.addEventListener('keyup', function() {
      const filter = searchInput.value.toLowerCase();
      const rows = table.getElementsByTagName('tbody')[0].getElementsByTagName('tr');

      for (let i = 0; i < rows.length; i++) {
        const row = rows[i];
        const text = row.textContent.toLowerCase();

        if (text.includes(filter)) {
          row.style.display = '';
        } else {
          row.style.display = 'none';
        }
      }
    });
  }
});

// Export functions - Generate CSV client-side
function exportScanTimeline() {
  let csv = 'Date,Scanner,Total Hosts,Hosts Up,Duration (seconds)\n';
  {% if scans %}
  {% for scan in scans %}
  csv += '"{{ scan.start_time[:10] if scan.start_time else "Unknown" }}","{{ scan.scanner or "nmap" }}",{{ scan.total_hosts or 0 }},{{ scan.up_hosts or 0 }},{{ scan.elapsed_time or 0 }}\n';
  {% endfor %}
  {% endif %}
  downloadCSV(csv, 'scan_timeline.csv');
}

function exportAllScans() {
  let csv = 'Date,Time,Scanner,Version,Total Hosts,Hosts Up,Duration,Command\n';
  {% if scans %}
  {% for scan in scans %}
  csv += '"{{ scan.start_time[:10] if scan.start_time else "Unknown" }}","{{ scan.start_time[11:19] if scan.start_time else "" }}","{{ scan.scanner or "nmap" }}","{{ scan.nmap_version or "" }}",{{ scan.total_hosts or 0 }},{{ scan.up_hosts or 0 }},{{ scan.elapsed_time or 0 }},"{{ scan.command_line or "" }}"\n';
  {% endfor %}
  {% endif %}
  downloadCSV(csv, 'all_scans.csv');
}

function downloadCSV(csv, filename) {
  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const link = document.createElement('a');
  if (link.download !== undefined) {
    const url = URL.createObjectURL(blob);
    link.setAttribute('href', url);
    link.setAttribute('download', filename);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  }
}

// View scan details modal
function viewScanDetails(scanId) {
  const modal = new bootstrap.Modal(document.getElementById('scanDetailModal'));
  const content = document.getElementById('scanDetailContent');

  content.innerHTML = '<div class="text-center"><i class="bi bi-hourglass-split"></i> Loading...</div>';
  modal.show();

  // Find scan data from current page
  const scanData = findScanInPageData(scanId);

  if (scanData) {
    content.innerHTML = `
      <div class="row">
        <div class="col-md-6">
          <h6>Scan Information</h6>
          <table class="table table-sm">
            <tr><td><strong>Date:</strong></td><td>${scanData.start_time || 'Unknown'}</td></tr>
            <tr><td><strong>Scanner:</strong></td><td>${scanData.scanner || 'nmap'}</td></tr>
            <tr><td><strong>Version:</strong></td><td>${scanData.nmap_version || 'Unknown'}</td></tr>
            <tr><td><strong>Scan Type:</strong></td><td>${scanData.scan_type || 'Unknown'}</td></tr>
            <tr><td><strong>Protocol:</strong></td><td>${scanData.protocol || 'Unknown'}</td></tr>
          </table>
        </div>
        <div class="col-md-6">
          <h6>Results</h6>
          <table class="table table-sm">
            <tr><td><strong>Total Hosts:</strong></td><td>${scanData.total_hosts || 0}</td></tr>
            <tr><td><strong>Hosts Up:</strong></td><td>${scanData.up_hosts || 0}</td></tr>
            <tr><td><strong>Success Rate:</strong></td><td>${scanData.total_hosts && scanData.total_hosts > 0 ? ((scanData.up_hosts || 0) / scanData.total_hosts * 100).toFixed(1) + '%' : 'N/A'}</td></tr>
            <tr><td><strong>Duration:</strong></td><td>${scanData.elapsed_time ? (scanData.elapsed_time / 60).toFixed(1) + ' minutes' : 'Unknown'}</td></tr>
            <tr><td><strong>Source File:</strong></td><td>${scanData.file_source || 'N/A'}</td></tr>
          </table>
        </div>
      </div>
      ${scanData.command_line ? `
      <div class="mt-3">
        <h6>Command Line</h6>
        <div class="bg-dark text-light p-3 rounded">
          <code>${scanData.command_line}</code>
        </div>
        <button class="btn btn-sm btn-outline-primary mt-2" onclick="copyToClipboard('${scanData.command_line}')">
          <i class="bi bi-clipboard"></i> Copy Command
        </button>
      </div>
      ` : ''}
      ${scanData.services_scanned ? `
      <div class="mt-3">
        <h6>Services Scanned</h6>
        <p class="text-muted">${scanData.services_scanned}</p>
      </div>
      ` : ''}
    `;
  } else {
    content.innerHTML = '<div class="alert alert-warning">No detailed information available for this scan.</div>';
  }
}

function findScanInPageData(scanId) {
  // This would extract scan data from the page based on scanId
  // For now, we'll use a placeholder implementation
  {% if scans %}
  const scansData = [
    {% for scan in scans %}
    {
      id: '{{ scan.id }}',
      start_time: '{{ scan.start_time }}',
      scanner: '{{ scan.scanner }}',
      nmap_version: '{{ scan.nmap_version }}',
      scan_type: '{{ scan.scan_type }}',
      protocol: '{{ scan.protocol }}',
      total_hosts: {{ scan.total_hosts or 0 }},
      up_hosts: {{ scan.up_hosts or 0 }},
      elapsed_time: {{ scan.elapsed_time or 0 }},
      command_line: '{{ scan.command_line }}',
      file_source: '{{ scan.file_source }}',
      services_scanned: '{{ scan.services_scanned }}'
    }{% if not loop.last %},{% endif %}
    {% endfor %}
  ];

  return scansData.find(scan => scan.id == scanId);
  {% else %}
  return null;
  {% endif %}
}

// Copy to clipboard function
function copyToClipboard(text) {
  navigator.clipboard.writeText(text).then(function() {
    showToast('Copied to clipboard!', 'success');
  }).catch(function(err) {
    // Fallback for older browsers
    const textArea = document.createElement('textarea');
    textArea.value = text;
    document.body.appendChild(textArea);
    textArea.select();
    try {
      document.execCommand('copy');
      showToast('Copied to clipboard!', 'success');
    } catch (fallbackErr) {
      showToast('Failed to copy to clipboard', 'error');
    }
    document.body.removeChild(textArea);
  });
}

// Toast notification function
function showToast(message, type = 'info') {
  const toast = document.createElement('div');
  toast.className = `toast-notification alert alert-${type === 'success' ? 'success' : type === 'error' ? 'danger' : 'info'}`;
  toast.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 9999; max-width: 300px;';
  toast.innerHTML = `
    <div class="d-flex align-items-center">
      <i class="bi bi-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'} me-2"></i>
      ${message}
    </div>
  `;

  document.body.appendChild(toast);
  setTimeout(() => {
    if (document.body.contains(toast)) {
      document.body.removeChild(toast);
    }
  }, 3000);
}

// Keyboard shortcuts
document.addEventListener('keydown', function(e) {
  // Ctrl+F or Cmd+F to focus search
  if ((e.ctrlKey || e.metaKey) && e.key === 'f') {
    e.preventDefault();
    const searchInput = document.getElementById('scanSearch');
    if (searchInput) {
      searchInput.focus();
      searchInput.select();
    }
  }
});
</script>
{% endblock %}