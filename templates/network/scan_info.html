<!-- FIXED VERSION: templates/network/scan_info.html -->
<!-- Risolve errore "Object of type Undefined is not JSON serializable" -->

{% extends "base.html" %}

{% block title %}Network Scan Information{% endblock %}

{% block content %}
<div class="container-fluid">
  <!-- Header -->
  <div class="row mb-4">
    <div class="col">
      <h1 class="h3 mb-0">
        <i class="bi bi-radar text-primary"></i>
        Network Scan Information
      </h1>
      <p class="text-muted">Overview of network scanning activities and results</p>
    </div>
    <div class="col-auto">
      <div class="btn-group">
        <button type="button" class="btn btn-success" onclick="exportScanTimeline()">
          <i class="bi bi-download"></i> Export Timeline
        </button>
        <button type="button" class="btn btn-outline-info" onclick="refreshScanData()">
          <i class="bi bi-arrow-clockwise"></i> Refresh
        </button>
      </div>
    </div>
  </div>

  <!-- Error Display -->
  {% if error %}
  <div class="alert alert-danger">
    <h6><i class="bi bi-exclamation-triangle"></i> Error Loading Scan Data</h6>
    <p class="mb-0">{{ error }}</p>
  </div>
  {% endif %}

  <!-- Scan Statistics -->
  {% if scan_stats %}
  <div class="row mb-4">
    <div class="col-lg-3 col-md-6">
      <div class="card bg-primary text-white">
        <div class="card-body">
          <div class="d-flex align-items-center">
            <div>
              <h3 class="mb-0">{{ scan_stats.total_scans or 0 }}</h3>
              <p class="mb-0">Total Scans</p>
            </div>
            <div class="ms-auto">
              <i class="bi bi-activity fs-1"></i>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-lg-3 col-md-6">
      <div class="card bg-success text-white">
        <div class="card-body">
          <div class="d-flex align-items-center">
            <div>
              <h3 class="mb-0">{{ scan_stats.total_hosts_scanned or 0 }}</h3>
              <p class="mb-0">Hosts Scanned</p>
            </div>
            <div class="ms-auto">
              <i class="bi bi-pc-display fs-1"></i>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-lg-3 col-md-6">
      <div class="card bg-warning text-white">
        <div class="card-body">
          <div class="d-flex align-items-center">
            <div>
              <h3 class="mb-0">{{ scan_stats.total_hosts_up or 0 }}</h3>
              <p class="mb-0">Hosts Online</p>
            </div>
            <div class="ms-auto">
              <i class="bi bi-check-circle fs-1"></i>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-lg-3 col-md-6">
      <div class="card bg-info text-white">
        <div class="card-body">
          <div class="d-flex align-items-center">
            <div>
              <h3 class="mb-0">{{ scan_stats.total_elapsed_hours or 0 }}h</h3>
              <p class="mb-0">Total Scan Time</p>
            </div>
            <div class="ms-auto">
              <i class="bi bi-clock fs-1"></i>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  {% endif %}

  <!-- Charts Section -->
  {% if scans and scans|length > 0 %}
  <div class="row mb-4">
    <div class="col-md-8">
      <div class="card">
        <div class="card-header">
          <h3 class="card-title">
            <i class="bi bi-graph-up"></i> Scan Timeline
          </h3>
        </div>
        <div class="card-body">
          <canvas id="scanTimelineChart" height="100"></canvas>
        </div>
      </div>
    </div>

    <div class="col-md-4">
      <div class="card">
        <div class="card-header">
          <h3 class="card-title">
            <i class="bi bi-pie-chart"></i> Scan Types Distribution
          </h3>
        </div>
        <div class="card-body">
          <canvas id="scanTypesChart" height="300"></canvas>
        </div>
      </div>
    </div>
  </div>
  {% endif %}

  <!-- Detailed Scan List -->
  {% if scans and scans|length > 0 %}
  <div class="row">
    <div class="col-12">
      <div class="card">
        <div class="card-header">
          <h3 class="card-title">
            <i class="bi bi-list-ul"></i> Detailed Scan History
          </h3>
          <div class="card-tools">
            <div class="input-group input-group-sm" style="width: 250px;">
              <input type="text" class="form-control" id="scanSearch" placeholder="Search scans...">
              <div class="input-group-append">
                <button type="button" class="btn btn-default">
                  <i class="bi bi-search"></i>
                </button>
              </div>
            </div>
            <button type="button" class="btn btn-sm btn-success ms-2" onclick="exportAllScans()">
              <i class="bi bi-download"></i> Export All
            </button>
          </div>
        </div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-striped table-hover" id="scansTable">
              <thead>
                <tr>
                  <th>Scan Date</th>
                  <th>Scanner</th>
                  <th>Version</th>
                  <th>Command</th>
                  <th>Duration</th>
                  <th>Hosts</th>
                  <th>Up Hosts</th>
                  <th class="text-center">Actions</th>
                </tr>
              </thead>
              <tbody>
                {% for scan in scans %}
                <tr>
                  <td>
                    <div>
                      <strong>{{ scan.start_time[:19] if scan.start_time else 'Unknown' }}</strong>
                      {% if scan.end_time %}
                      <br><small class="text-muted">Ended: {{ scan.end_time[:19] }}</small>
                      {% endif %}
                    </div>
                  </td>
                  <td>
                    <span class="badge bg-primary">{{ scan.scanner or 'nmap' }}</span>
                    {% if scan.nmap_version %}
                    <br><small class="text-muted">v{{ scan.nmap_version }}</small>
                    {% endif %}
                  </td>
                  <td>
                    {% if scan.nmap_version %}
                      <code>{{ scan.nmap_version }}</code>
                    {% else %}
                      <span class="text-muted">-</span>
                    {% endif %}
                  </td>
                  <td>
                    {% if scan.command_line %}
                    <code class="small">{{ scan.command_line[:50] }}{% if scan.command_line|length > 50 %}...{% endif %}</code>
                    {% else %}
                    <span class="text-muted">-</span>
                    {% endif %}
                  </td>
                  <td>
                    {% if scan.elapsed_time %}
                      {{ "%.1f"|format(scan.elapsed_time) }}s
                    {% else %}
                      <span class="text-muted">-</span>
                    {% endif %}
                  </td>
                  <td>
                    <span class="badge bg-info">{{ scan.total_hosts or 0 }}</span>
                  </td>
                  <td>
                    <span class="badge bg-success">{{ scan.up_hosts or 0 }}</span>
                    {% if scan.total_hosts and scan.total_hosts > 0 %}
                    <br><small class="text-muted">{{ "%.1f"|format((scan.up_hosts or 0) / scan.total_hosts * 100) }}%</small>
                    {% endif %}
                  </td>
                  <td class="text-center">
                    <div class="btn-group btn-group-sm">
                      <button type="button" class="btn btn-outline-primary"
                              onclick="viewScanDetails('{{ scan.id or '' }}')" title="View Details">
                        <i class="bi bi-eye"></i>
                      </button>
                      {% if scan.command_line %}
                      <button type="button" class="btn btn-outline-secondary"
                              onclick="copyToClipboard('{{ scan.command_line|replace("'", "\\'") }}')" title="Copy Command">
                        <i class="bi bi-clipboard"></i>
                      </button>
                      {% endif %}
                      {% if scan.file_source %}
                      <button type="button" class="btn btn-outline-info"
                              title="Source: {{ scan.file_source }}">
                        <i class="bi bi-file-text"></i>
                      </button>
                      {% endif %}
                    </div>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
  {% else %}
  <div class="row">
    <div class="col-12">
      <div class="card">
        <div class="card-body text-center py-5">
          <i class="bi bi-search display-1 text-muted"></i>
          <h4 class="text-muted mt-3">No Scan Information Available</h4>
          <p class="text-muted">No scan information found. This could mean:</p>
          <ul class="text-muted list-unstyled">
            <li>• No scans have been performed yet</li>
            <li>• Scan data hasn't been processed</li>
            <li>• Database connection issues</li>
          </ul>
          <div class="mt-4">
            <a href="{{ url_for('network.overview') }}" class="btn btn-primary">
              <i class="bi bi-arrow-left"></i> Back to Network Overview
            </a>
            <button onclick="refreshScanData()" class="btn btn-outline-secondary ms-2">
              <i class="bi bi-arrow-clockwise"></i> Refresh Data
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
  {% endif %}
</div>

<!-- JavaScript Section -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// ===== SAFE DATA PREPARATION =====
// Convert Python data to JavaScript safely, handling None/null values

function safeValue(value, defaultValue = 0) {
  return value !== null && value !== undefined ? value : defaultValue;
}

function safeString(value, defaultValue = '') {
  return value !== null && value !== undefined ? String(value) : defaultValue;
}

// Prepare scan data for charts
const scanData = [
  {% if scans %}
  {% for scan in scans %}
  {
    date: "{{ scan.start_time[:10] if scan.start_time else 'Unknown' }}",
    scanner: "{{ scan.scanner or 'nmap' }}",
    totalHosts: {{ scan.total_hosts or 0 }},
    upHosts: {{ scan.up_hosts or 0 }},
    duration: {{ scan.elapsed_time or 0 }},
    command: "{{ (scan.command_line or '')[:30] }}",
    version: "{{ scan.nmap_version or '' }}"
  }{% if not loop.last %},{% endif %}
  {% endfor %}
  {% endif %}
];

// ===== CHARTS =====
{% if scans and scans|length > 0 %}

// Timeline Chart
document.addEventListener('DOMContentLoaded', function() {
  const timelineCtx = document.getElementById('scanTimelineChart');
  if (timelineCtx && scanData.length > 0) {
    new Chart(timelineCtx, {
      type: 'line',
      data: {
        labels: scanData.map(scan => scan.date),
        datasets: [{
          label: 'Total Hosts',
          data: scanData.map(scan => scan.totalHosts),
          borderColor: 'rgb(54, 162, 235)',
          backgroundColor: 'rgba(54, 162, 235, 0.1)',
          tension: 0.4
        }, {
          label: 'Hosts Up',
          data: scanData.map(scan => scan.upHosts),
          borderColor: 'rgb(75, 192, 192)',
          backgroundColor: 'rgba(75, 192, 192, 0.1)',
          tension: 0.4
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          y: {
            beginAtZero: true
          }
        },
        plugins: {
          legend: {
            position: 'top'
          },
          title: {
            display: true,
            text: 'Scan Results Over Time'
          }
        }
      }
    });
  }

  // Scan Types Distribution
  const typesCtx = document.getElementById('scanTypesChart');
  if (typesCtx && scanData.length > 0) {
    // Count scanners
    const scannerCounts = {};
    scanData.forEach(scan => {
      const scanner = scan.scanner || 'Unknown';
      scannerCounts[scanner] = (scannerCounts[scanner] || 0) + 1;
    });

    new Chart(typesCtx, {
      type: 'doughnut',
      data: {
        labels: Object.keys(scannerCounts),
        datasets: [{
          data: Object.values(scannerCounts),
          backgroundColor: [
            'rgba(255, 99, 132, 0.8)',
            'rgba(54, 162, 235, 0.8)',
            'rgba(255, 205, 86, 0.8)',
            'rgba(75, 192, 192, 0.8)',
            'rgba(153, 102, 255, 0.8)'
          ]
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            position: 'bottom'
          }
        }
      }
    });
  }
});
{% endif %}

// ===== UTILITY FUNCTIONS =====

// Search functionality
document.addEventListener('DOMContentLoaded', function() {
  const searchInput = document.getElementById('scanSearch');
  const table = document.getElementById('scansTable');

  if (searchInput && table) {
    searchInput.addEventListener('keyup', function() {
      const filter = searchInput.value.toLowerCase();
      const rows = table.getElementsByTagName('tbody')[0].getElementsByTagName('tr');

      for (let i = 0; i < rows.length; i++) {
        const row = rows[i];
        const text = row.textContent.toLowerCase();

        if (text.includes(filter)) {
          row.style.display = '';
        } else {
          row.style.display = 'none';
        }
      }
    });
  }
});

// Export functions
function exportScanTimeline() {
  let csv = 'Date,Scanner,Total Hosts,Hosts Up,Duration (seconds)\n';
  scanData.forEach(scan => {
    csv += `"${scan.date}","${scan.scanner}",${scan.totalHosts},${scan.upHosts},${scan.duration}\n`;
  });
  downloadCSV(csv, 'scan_timeline.csv');
}

function exportAllScans() {
  let csv = 'Date,Scanner,Version,Total Hosts,Hosts Up,Duration,Command\n';
  scanData.forEach(scan => {
    csv += `"${scan.date}","${scan.scanner}","${scan.version}",${scan.totalHosts},${scan.upHosts},${scan.duration},"${scan.command}"\n`;
  });
  downloadCSV(csv, 'all_scans.csv');
}

function downloadCSV(csv, filename) {
  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const link = document.createElement('a');

  if (link.download !== undefined) {
    const url = URL.createObjectURL(blob);
    link.setAttribute('href', url);
    link.setAttribute('download', filename);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  }
}

// Other utility functions
function viewScanDetails(scanId) {
  if (scanId) {
    window.location.href = `/network/scan/${scanId}`;
  } else {
    alert('Scan ID not available');
  }
}

function copyToClipboard(text) {
  if (navigator.clipboard && navigator.clipboard.writeText) {
    navigator.clipboard.writeText(text).then(() => {
      showToast('Command copied to clipboard!', 'success');
    }).catch(err => {
      console.error('Failed to copy: ', err);
      fallbackCopyTextToClipboard(text);
    });
  } else {
    fallbackCopyTextToClipboard(text);
  }
}

function fallbackCopyTextToClipboard(text) {
  const textArea = document.createElement('textarea');
  textArea.value = text;
  textArea.style.top = '0';
  textArea.style.left = '0';
  textArea.style.position = 'fixed';
  document.body.appendChild(textArea);
  textArea.focus();
  textArea.select();

  try {
    document.execCommand('copy');
    showToast('Command copied to clipboard!', 'success');
  } catch (err) {
    console.error('Fallback: Oops, unable to copy', err);
    showToast('Failed to copy command', 'error');
  }

  document.body.removeChild(textArea);
}

function refreshScanData() {
  location.reload();
}

function showToast(message, type = 'info') {
  // Simple toast notification (you can enhance this)
  const alertClass = type === 'success' ? 'alert-success' :
                    type === 'error' ? 'alert-danger' : 'alert-info';

  const toast = document.createElement('div');
  toast.className = `alert ${alertClass} position-fixed`;
  toast.style.top = '20px';
  toast.style.right = '20px';
  toast.style.zIndex = '9999';
  toast.style.opacity = '0.9';
  toast.innerHTML = message;

  document.body.appendChild(toast);

  setTimeout(() => {
    toast.remove();
  }, 3000);
}
</script>
{% endblock %}