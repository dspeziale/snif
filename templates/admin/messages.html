{% extends "base.html" %}

{% block title %}Message Management{% endblock %}
{% block page_title %}Message Management{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{{ url_for('index') }}">Home</a></li>
<li class="breadcrumb-item"><a href="{{ url_for('admin_dashboard') }}">Admin</a></li>
<li class="breadcrumb-item active" aria-current="page">Messages</li>
{% endblock %}

{% block content %}
<!-- Quick Actions Bar -->
<div class="row">
  <div class="col-12">
    <div class="card">
      <div class="card-header">
        <h3 class="card-title">
          <i class="bi bi-lightning-fill me-2"></i>Quick Actions
        </h3>
      </div>
      <div class="card-body">
        <div class="row">
          <div class="col-md-8">
            <div class="btn-group" role="group">
              <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#newMessageModal">
                <i class="bi bi-plus-circle me-1"></i>New Message
              </button>
              <button type="button" class="btn btn-warning" onclick="markAllMessagesRead()">
                <i class="bi bi-check-all me-1"></i>Mark All Read
              </button>
              <button type="button" class="btn btn-info" onclick="refreshMessagesTable()">
                <i class="bi bi-arrow-clockwise me-1"></i>Refresh
              </button>
            </div>
          </div>
          <div class="col-md-4 text-end">
            <div class="btn-group" role="group">
              <button type="button" class="btn btn-outline-primary" onclick="exportMessages('excel')">
                <i class="bi bi-file-earmark-excel me-1"></i>Excel
              </button>
              <button type="button" class="btn btn-outline-success" onclick="exportMessages('csv')">
                <i class="bi bi-file-earmark-text me-1"></i>CSV
              </button>
              <button type="button" class="btn btn-outline-danger" onclick="exportMessages('pdf')">
                <i class="bi bi-file-earmark-pdf me-1"></i>PDF
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Messages DataTable -->
<div class="row">
  <div class="col-12">
    <div class="card">
      <div class="card-header">
        <h3 class="card-title">
          <i class="bi bi-chat-text me-2"></i>Messages Database
          <span class="badge bg-primary ms-2" id="messages-total-count">{{ messages|length }}</span>
        </h3>
        <div class="card-tools">
          <div class="btn-group btn-group-sm">
            <button type="button" class="btn btn-outline-secondary" onclick="toggleSelectAll()">
              <i class="bi bi-check-square me-1"></i>Select All
            </button>
            <button type="button" class="btn btn-outline-secondary" onclick="clearSelection()">
              <i class="bi bi-square me-1"></i>Clear Selection
            </button>
          </div>
        </div>
      </div>
      <div class="card-body">
        <!-- DataTable will be inserted here -->
        <table id="messagesTable" class="table table-bordered table-striped table-hover"
               data-table="messages"
               {% if database_mode %}data-ajax-url="/api/messages"{% endif %}>
          <thead>
            <tr>
              <th class="no-sort no-search" width="30">
                <input type="checkbox" id="selectAllMessages">
              </th>
              <th class="no-sort" width="50">Avatar</th>
              <th>Sender</th>
              <th>Subject</th>
              <th>Content</th>
              <th>Type</th>
              <th>Priority</th>
              <th>Status</th>
              <th>Time</th>
              <th class="no-sort" width="150">Actions</th>
            </tr>
          </thead>
          <tbody>
            {% if not database_mode %}
            {% for message in messages %}
            <tr class="{% if message.unread %}table-row-unread{% endif %} {% if message.priority_info %}table-row-{{ message.priority_info.level }}-priority{% endif %}"
                data-message-id="{{ message.id }}">
              <td class="text-center">
                <input type="checkbox" class="message-checkbox" value="{{ message.id }}">
              </td>
              <td class="text-center">
                <img src="{{ message.avatar or url_for('static', filename='assets/img/user-default.jpg') }}"
                     alt="Avatar" class="img-circle" width="40" height="40">
              </td>
              <td>
                <strong>{{ message.sender }}</strong>
                {% if message.unread %}
                <span class="badge bg-danger badge-sm ms-1">Unread</span>
                {% endif %}
              </td>
              <td>
                <strong>{{ message.subject or 'No Subject' }}</strong>
              </td>
              <td>
                <div class="message-content" style="max-width: 300px;">
                  {{ message.content[:100] }}
                  {% if message.content|length > 100 %}...{% endif %}
                </div>
              </td>
              <td class="text-center">
                {% if message.type_info %}
                <span class="badge bg-{{ message.type_info.color }}">
                  <i class="bi {{ message.type_info.icon }} me-1"></i>{{ message.type_info.label }}
                </span>
                {% else %}
                <span class="badge bg-secondary">Unknown</span>
                {% endif %}
              </td>
              <td class="text-center">
                {% if message.priority_info %}
                <span class="badge bg-{{ message.priority_info.color }}">
                  <i class="bi {{ message.priority_info.icon }} me-1"></i>{{ message.priority_info.label }}
                </span>
                {% else %}
                <span class="badge bg-secondary">Normal</span>
                {% endif %}
              </td>
              <td class="text-center">
                {% if message.unread %}
                <span class="badge bg-warning">Unread</span>
                {% elif message.archived %}
                <span class="badge bg-secondary">Archived</span>
                {% else %}
                <span class="badge bg-success">Read</span>
                {% endif %}
              </td>
              <td>
                <small>{{ message.time }}</small>
              </td>
              <td class="text-center">
                <div class="btn-group btn-group-sm" role="group">
                  {% if message.unread %}
                  <button class="btn btn-outline-success" onclick="AdminLTE.Actions.markMessageRead({{ message.id }})" title="Mark as Read">
                    <i class="bi bi-check"></i>
                  </button>
                  {% endif %}
                  <button class="btn btn-outline-primary" onclick="AdminLTE.Actions.viewMessage({{ message.id }})" title="View">
                    <i class="bi bi-eye"></i>
                  </button>
                  {% if not message.archived %}
                  <button class="btn btn-outline-warning" onclick="AdminLTE.Actions.archiveMessage({{ message.id }})" title="Archive">
                    <i class="bi bi-archive"></i>
                  </button>
                  {% endif %}
                  <button class="btn btn-outline-danger" onclick="AdminLTE.Actions.deleteMessage({{ message.id }})" title="Delete">
                    <i class="bi bi-trash"></i>
                  </button>
                </div>
              </td>
            </tr>
            {% endfor %}
            {% endif %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Bulk Actions Card -->
<div class="row">
  <div class="col-12">
    <div class="card card-outline card-info">
      <div class="card-header">
        <h3 class="card-title">
          <i class="bi bi-collection me-2"></i>Bulk Actions
        </h3>
        <div class="card-tools">
          <span class="badge bg-info" id="selected-count">0 selected</span>
        </div>
      </div>
      <div class="card-body">
        <div class="row">
          <div class="col-md-8">
            <div class="btn-group" role="group">
              <button class="btn btn-success" onclick="bulkMarkRead()" id="bulkReadBtn" disabled>
                <i class="bi bi-check-all me-1"></i>Mark as Read
              </button>
              <button class="btn btn-warning" onclick="bulkArchive()" id="bulkArchiveBtn" disabled>
                <i class="bi bi-archive me-1"></i>Archive Selected
              </button>
              <button class="btn btn-danger" onclick="bulkDelete()" id="bulkDeleteBtn" disabled>
                <i class="bi bi-trash me-1"></i>Delete Selected
              </button>
            </div>
          </div>
          <div class="col-md-4 text-end">
            <div class="btn-group" role="group">
              <button class="btn btn-outline-primary" onclick="bulkExport('selected')" id="bulkExportBtn" disabled>
                <i class="bi bi-download me-1"></i>Export Selected
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- New Message Modal -->
<div class="modal fade" id="newMessageModal" tabindex="-1" aria-labelledby="newMessageModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="newMessageModalLabel">
          <i class="bi bi-plus-circle me-2"></i>Create New Message
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="newMessageForm">
          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <label for="messageSender" class="form-label">
                  <i class="bi bi-person me-1"></i>Sender *
                </label>
                <input type="text" class="form-control" id="messageSender" required
                       placeholder="Enter sender name">
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <label for="messageSubject" class="form-label">
                  <i class="bi bi-chat-square-text me-1"></i>Subject
                </label>
                <input type="text" class="form-control" id="messageSubject"
                       placeholder="Enter message subject">
              </div>
            </div>
          </div>

          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <label for="messageType" class="form-label">
                  <i class="bi bi-tag me-1"></i>Type
                </label>
                <select class="form-select" id="messageType">
                  <option value="">Select Type</option>
                  {% for msg_type in message_types %}
                  <option value="{{ msg_type.type }}">
                    <i class="bi {{ msg_type.icon }}"></i> {{ msg_type.label }}
                  </option>
                  {% endfor %}
                </select>
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <label for="messagePriority" class="form-label">
                  <i class="bi bi-exclamation-circle me-1"></i>Priority
                </label>
                <select class="form-select" id="messagePriority">
                  {% for priority in priorities %}
                  <option value="{{ priority.level }}" {% if priority.level == 'medium' %}selected{% endif %}>
                    {{ priority.label }}
                  </option>
                  {% endfor %}
                </select>
              </div>
            </div>
          </div>

          <div class="mb-3">
            <label for="messageContent" class="form-label">
              <i class="bi bi-card-text me-1"></i>Content *
            </label>
            <textarea class="form-control" id="messageContent" rows="4" required
                      placeholder="Enter message content..."></textarea>
            <div class="form-text">
              <small class="text-muted">
                <span id="contentCount">0</span>/1000 characters
              </small>
            </div>
          </div>

          <div class="mb-3">
            <label for="messageAvatar" class="form-label">
              <i class="bi bi-person-circle me-1"></i>Avatar URL
            </label>
            <input type="url" class="form-control" id="messageAvatar"
                   placeholder="https://example.com/avatar.jpg">
            <div class="form-text">
              <small class="text-muted">Optional: URL to sender's avatar image</small>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          <i class="bi bi-x-circle me-1"></i>Cancel
        </button>
        <button type="button" class="btn btn-primary" onclick="createMessage()">
          <i class="bi bi-plus-circle me-1"></i>Create Message
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Statistics Cards (if needed) -->
<div class="row mt-3">
  <div class="col-md-3">
    <div class="info-box bg-info">
      <span class="info-box-icon"><i class="bi bi-envelope"></i></span>
      <div class="info-box-content">
        <span class="info-box-text">Total Messages</span>
        <span class="info-box-number" id="total-messages">{{ messages|length }}</span>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="info-box bg-warning">
      <span class="info-box-icon"><i class="bi bi-envelope-open"></i></span>
      <div class="info-box-content">
        <span class="info-box-text">Unread</span>
        <span class="info-box-number" id="unread-messages">
          {% set unread_count = messages|selectattr('unread')|list|length %}
          {{ unread_count }}
        </span>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="info-box bg-success">
      <span class="info-box-icon"><i class="bi bi-check-circle"></i></span>
      <div class="info-box-content">
        <span class="info-box-text">Read</span>
        <span class="info-box-number" id="read-messages">
          {% set read_count = messages|rejectattr('unread')|rejectattr('archived')|list|length %}
          {{ read_count }}
        </span>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="info-box bg-secondary">
      <span class="info-box-icon"><i class="bi bi-archive"></i></span>
      <div class="info-box-content">
        <span class="info-box-text">Archived</span>
        <span class="info-box-number" id="archived-messages">
          {% set archived_count = messages|selectattr('archived')|list|length %}
          {{ archived_count }}
        </span>
      </div>
    </div>
  </div>
</div>
{% endblock %}
<script>
// SOLUZIONE SEMPLICE - Sostituisci tutto il JavaScript in admin/messages.html con questo:

let messagesTable;

$(document).ready(function() {
    console.log('Initializing messages page...');

    // Inizializza DataTable SEMPLICE (senza AJAX per ora)
    messagesTable = $('#messagesTable').DataTable({
        responsive: true,
        processing: false,
        serverSide: false,
        pageLength: 25,
        order: [[8, 'desc']], // Ordina per colonna Time
        columnDefs: [
            { orderable: false, targets: [0, 1, 9] }, // Checkbox, Avatar, Actions non ordinabili
            { searchable: false, targets: [0, 1, 9] }  // Checkbox, Avatar, Actions non ricercabili
        ],
        language: {
            emptyTable: 'No messages found',
            zeroRecords: 'No matching messages found',
            search: 'Search messages:',
            lengthMenu: 'Show _MENU_ messages',
            info: 'Showing _START_ to _END_ of _TOTAL_ messages'
        }
    });

    console.log('DataTable initialized successfully');

    // Setup event listeners
    setupEventListeners();
});

function setupEventListeners() {
    // Select all checkbox handler
    $('#selectAllMessages').on('change', function() {
        const isChecked = $(this).is(':checked');
        $('.message-checkbox').prop('checked', isChecked);
        updateBulkActionButtons();
    });

    // Individual checkbox handler
    $(document).on('change', '.message-checkbox', function() {
        updateBulkActionButtons();
    });

    // Character counter for message content
    $('#messageContent').on('input', function() {
        const length = $(this).val().length;
        $('#contentCount').text(length);

        if (length > 1000) {
            $(this).addClass('is-invalid');
        } else {
            $(this).removeClass('is-invalid');
        }
    });

    // Modal form reset on hide
    $('#newMessageModal').on('hidden.bs.modal', function() {
        $('#newMessageForm')[0].reset();
        $('#contentCount').text('0');
        $('#messageContent').removeClass('is-invalid');
    });
}

function updateBulkActionButtons() {
    const selectedCount = $('.message-checkbox:checked').length;
    const bulkButtons = ['#bulkReadBtn', '#bulkArchiveBtn', '#bulkDeleteBtn', '#bulkExportBtn'];

    bulkButtons.forEach(btn => {
        $(btn).prop('disabled', selectedCount === 0);
    });

    $('#selected-count').text(`${selectedCount} selected`);
}

// FUNZIONE PRINCIPALE - Create Message
function createMessage() {
    console.log('createMessage called');

    // Verifica che il modal sia aperto e i campi esistano
    const modal = document.getElementById('newMessageModal');
    if (!modal || !modal.classList.contains('show')) {
        console.error('Modal not open or not found');
        alert('Please open the message form first');
        return;
    }

    // Raccogli i dati dai campi
    const senderField = document.getElementById('messageSender');
    const subjectField = document.getElementById('messageSubject');
    const contentField = document.getElementById('messageContent');
    const typeField = document.getElementById('messageType');
    const priorityField = document.getElementById('messagePriority');
    const avatarField = document.getElementById('messageAvatar');

    // Debug: verifica che i campi esistano
    console.log('Field check:');
    console.log('sender:', senderField ? senderField.value : 'FIELD NOT FOUND');
    console.log('content:', contentField ? contentField.value : 'FIELD NOT FOUND');

    if (!senderField || !contentField) {
        alert('Error: Form fields not found. Please refresh the page and try again.');
        return;
    }

    const formData = {
        sender: senderField.value.trim(),
        subject: subjectField ? subjectField.value.trim() : '',
        content: contentField.value.trim(),
        type: typeField ? typeField.value : '',
        priority: priorityField ? priorityField.value : 'medium',
        avatar: avatarField ? avatarField.value.trim() : ''
    };

    console.log('Collected form data:', formData);

    // Validazione
    if (!formData.sender) {
        alert('Please enter a sender name');
        senderField.focus();
        return;
    }

    if (!formData.content) {
        alert('Please enter message content');
        contentField.focus();
        return;
    }

    if (formData.content.length > 1000) {
        alert('Message content is too long (max 1000 characters)');
        return;
    }

    // Mostra loading
    const submitBtn = document.querySelector('#newMessageModal .btn-primary');
    const originalText = submitBtn.textContent;
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="bi bi-hourglass"></i> Creating...';

    // Invia i dati
    fetch('/api/messages', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(formData)
    })
    .then(response => {
        console.log('API Response Status:', response.status);

        if (!response.ok) {
            return response.text().then(text => {
                console.error('Error response text:', text);
                try {
                    const errorJson = JSON.parse(text);
                    throw new Error(errorJson.error || `HTTP ${response.status}`);
                } catch (e) {
                    throw new Error(`HTTP ${response.status}: ${text}`);
                }
            });
        }

        return response.json();
    })
    .then(data => {
        console.log('API Response Data:', data);

        if (data.success) {
            alert('Message created successfully!');

            // Chiudi il modal
            const modalInstance = bootstrap.Modal.getInstance(modal);
            if (modalInstance) {
                modalInstance.hide();
            }

            // Reset form
            document.getElementById('newMessageForm').reset();

            // Ricarica la pagina per vedere il nuovo messaggio
            setTimeout(() => {
                location.reload();
            }, 500);

        } else {
            throw new Error(data.error || 'Unknown error occurred');
        }
    })
    .catch(error => {
        console.error('Create message error:', error);
        alert('Error creating message: ' + error.message);
    })
    .finally(() => {
        // Ripristina il pulsante
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalText;
    });
}

// Funzioni di utility semplici
function toggleSelectAll() {
    const allSelected = $('.message-checkbox:checked').length === $('.message-checkbox').length;
    $('.message-checkbox').prop('checked', !allSelected);
    $('#selectAllMessages').prop('checked', !allSelected);
    updateBulkActionButtons();
}

function clearSelection() {
    $('.message-checkbox, #selectAllMessages').prop('checked', false);
    updateBulkActionButtons();
}

function refreshMessagesTable() {
    if (messagesTable) {
        messagesTable.draw();
        console.log('Messages table refreshed');
    }
    // Aggiorna anche i contatori
    updateStatistics();
}

function markAllMessagesRead() {
    if (confirm('Mark all messages as read?')) {
        fetch('/api/messages/mark-all-read', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('All messages marked as read');
                location.reload();
            } else {
                alert('Error: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error marking messages as read');
        });
    }
}

// Azioni sui messaggi individuali
function markMessageRead(messageId) {
    fetch(`/api/messages/${messageId}/read`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            console.log('Message marked as read');
            // Aggiorna la riga visivamente
            const row = document.querySelector(`[data-message-id="${messageId}"]`);
            if (row) {
                row.classList.remove('table-row-unread');
                const badge = row.querySelector('.badge.bg-warning');
                if (badge && badge.textContent === 'Unread') {
                    badge.textContent = 'Read';
                    badge.className = 'badge bg-success';
                }
            }
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error marking message as read');
    });
}

function viewMessage(messageId) {
    fetch(`/api/messages/${messageId}`)
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const message = data.data || data.message;
            alert(`Message from ${message.sender}:\n\n${message.content}`);

            // Segna come letto se non lo è già
            if (message.unread) {
                markMessageRead(messageId);
            }
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error loading message');
    });
}

function archiveMessage(messageId) {
    if (confirm('Archive this message?')) {
        fetch(`/api/messages/${messageId}/archive`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Message archived');
                location.reload();
            } else {
                alert('Error: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error archiving message');
        });
    }
}

function deleteMessage(messageId) {
    if (confirm('Delete this message permanently?')) {
        fetch(`/api/messages/${messageId}`, {
            method: 'DELETE',
            headers: { 'Content-Type': 'application/json' }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Message deleted');
                location.reload();
            } else {
                alert('Error: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error deleting message');
        });
    }
}

function updateStatistics() {
    // Aggiorna i contatori nella pagina
    fetch('/api/messages?limit=1')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const totalEl = document.getElementById('total-messages');
                const unreadEl = document.getElementById('unread-messages');

                if (totalEl) totalEl.textContent = data.total || 0;
                if (unreadEl) unreadEl.textContent = data.unread_count || 0;
            }
        })
        .catch(error => console.error('Error updating statistics:', error));
}

// Export functions (semplici per ora)
function exportMessages(format) {
    alert(`Export to ${format} - feature coming soon!`);
}

function bulkMarkRead() {
    alert('Bulk mark read - feature coming soon!');
}

function bulkArchive() {
    alert('Bulk archive - feature coming soon!');
}

function bulkDelete() {
    alert('Bulk delete - feature coming soon!');
}

function bulkExport() {
    alert('Bulk export - feature coming soon!');
}

console.log('Messages page JavaScript loaded successfully');
</script>

{% block extra_js %}
<!-- Messages specific JavaScript -->
<script>
// CORREZIONE DATATABLES - Aggiungi questo in fondo al template admin/messages.html

$(document).ready(function() {
    // Disabilita DataTables se non ci sono dati o se c'è un errore API

    // Prima controlla se l'API funziona
    fetch('/api/messages?limit=1')
        .then(response => {
            console.log('API Test Response Status:', response.status);
            return response.json();
        })
        .then(data => {
            console.log('API Test Response Data:', data);

            if (data.success && data.data) {
                console.log('API is working, initializing DataTable with AJAX');
                // API funziona, inizializza con AJAX
                initDataTableWithAjax();
            } else {
                console.log('API not working properly, using static table');
                // API non funziona, usa tabella statica
                initStaticDataTable();
            }
        })
        .catch(error => {
            console.error('API Test Failed:', error);
            console.log('Falling back to static table');
            // Fallback a tabella statica
            initStaticDataTable();
        });
});

function initDataTableWithAjax() {
    messagesTable = $('#messagesTable').DataTable({
        responsive: true,
        processing: true,
        serverSide: false, // Cambiato da true a false per semplicità
        ajax: {
            url: '/api/messages',
            type: 'GET',
            data: function(d) {
                // Converti parametri DataTables in parametri API
                return {
                    page: Math.floor(d.start / d.length) + 1,
                    per_page: d.length,
                    search: d.search.value
                };
            },
            dataSrc: function(json) {
                console.log('AJAX Response:', json);

                // Gestisci diversi formati di risposta
                if (json.success) {
                    if (json.data) {
                        return json.data; // Formato standard
                    } else if (json.messages) {
                        return json.messages; // Formato alternativo
                    }
                }

                console.error('Invalid API response format:', json);
                return [];
            },
            error: function(xhr, error, thrown) {
                console.error('DataTables AJAX Error:', error, thrown);
                $('#messagesTable tbody').html('<tr><td colspan="10" class="text-center text-danger">Error loading messages: ' + error + '</td></tr>');
            }
        },
        columns: [
            { data: null, defaultContent: '<input type="checkbox" class="message-checkbox">', orderable: false, searchable: false },
            {
                data: 'avatar',
                render: function(data, type, row) {
                    const avatar = data || '/static/assets/img/user-default.jpg';
                    return `<img src="${avatar}" alt="Avatar" class="img-circle" width="40" height="40">`;
                },
                orderable: false,
                searchable: false
            },
            { data: 'sender' },
            { data: 'subject', defaultContent: 'No Subject' },
            {
                data: 'content',
                render: function(data, type, row) {
                    if (type === 'display' && data.length > 100) {
                        return data.substr(0, 100) + '...';
                    }
                    return data;
                }
            },
            {
                data: 'type_info',
                render: function(data, type, row) {
                    if (data) {
                        return `<span class="badge bg-${data.color}"><i class="bi ${data.icon} me-1"></i>${data.label}</span>`;
                    }
                    return '<span class="badge bg-secondary">Unknown</span>';
                },
                orderable: false
            },
            {
                data: 'priority_info',
                render: function(data, type, row) {
                    if (data) {
                        return `<span class="badge bg-${data.color}"><i class="bi ${data.icon} me-1"></i>${data.label}</span>`;
                    }
                    return '<span class="badge bg-secondary">Normal</span>';
                },
                orderable: false
            },
            {
                data: 'unread',
                render: function(data, type, row) {
                    if (data) {
                        return '<span class="badge bg-warning">Unread</span>';
                    } else if (row.archived) {
                        return '<span class="badge bg-secondary">Archived</span>';
                    } else {
                        return '<span class="badge bg-success">Read</span>';
                    }
                },
                orderable: false
            },
            { data: 'time' },
            {
                data: null,
                render: function(data, type, row) {
                    let buttons = '';

                    if (row.unread) {
                        buttons += `<button class="btn btn-outline-success btn-sm" onclick="AdminLTE.Actions.markMessageRead(${row.id})" title="Mark as Read"><i class="bi bi-check"></i></button> `;
                    }

                    buttons += `<button class="btn btn-outline-primary btn-sm" onclick="AdminLTE.Actions.viewMessage(${row.id})" title="View"><i class="bi bi-eye"></i></button> `;

                    if (!row.archived) {
                        buttons += `<button class="btn btn-outline-warning btn-sm" onclick="AdminLTE.Actions.archiveMessage(${row.id})" title="Archive"><i class="bi bi-archive"></i></button> `;
                    }

                    buttons += `<button class="btn btn-outline-danger btn-sm" onclick="AdminLTE.Actions.deleteMessage(${row.id})" title="Delete"><i class="bi bi-trash"></i></button>`;

                    return `<div class="btn-group btn-group-sm">${buttons}</div>`;
                },
                orderable: false,
                searchable: false
            }
        ],
        order: [[8, 'desc']], // Ordina per data
        pageLength: 25,
        language: {
            processing: '<i class="bi bi-arrow-clockwise"></i> Loading messages...',
            emptyTable: 'No messages found',
            zeroRecords: 'No matching messages found'
        }
    });
}

function initStaticDataTable() {
    // Tabella statica semplice senza AJAX
    messagesTable = $('#messagesTable').DataTable({
        responsive: true,
        processing: false,
        serverSide: false,
        pageLength: 25,
        order: [[8, 'desc']],
        columnDefs: [
            { orderable: false, targets: [0, 1, 9] },
            { searchable: false, targets: [0, 1, 9] }
        ],
        language: {
            emptyTable: 'No messages found',
            zeroRecords: 'No matching messages found'
        }
    });

    console.log('Static DataTable initialized');
}

// CORREZIONE PRINCIPALE: Form data collection
function createMessage() {
    // Metodo più robusto per raccogliere i dati
    const sender = document.getElementById('messageSender');
    const subject = document.getElementById('messageSubject');
    const content = document.getElementById('messageContent');
    const type = document.getElementById('messageType');
    const priority = document.getElementById('messagePriority');
    const avatar = document.getElementById('messageAvatar');

    // Debug: controlla se gli elementi esistono
    console.log('Form elements check:');
    console.log('sender element:', sender);
    console.log('content element:', content);

    if (!sender || !content) {
        alert('Form elements not found! Check if the modal is properly loaded.');
        return;
    }

    const formData = {
        sender: sender.value.trim(),
        subject: subject ? subject.value.trim() : '',
        content: content.value.trim(),
        type: type ? type.value : '',
        priority: priority ? priority.value : 'medium',
        avatar: avatar ? avatar.value.trim() : ''
    };

    console.log('Form data collected:', formData);

    // Validazione
    if (!formData.sender) {
        alert('Please enter a sender name');
        sender.focus();
        return;
    }

    if (!formData.content) {
        alert('Please enter message content');
        content.focus();
        return;
    }

    if (formData.content.length > 1000) {
        alert('Message content is too long (max 1000 characters)');
        return;
    }

    // Invia i dati
    console.log('Sending to API:', formData);

    fetch('/api/messages', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(formData)
    })
    .then(response => {
        console.log('Response status:', response.status);
        if (!response.ok) {
            return response.text().then(text => {
                console.error('Response text:', text);
                try {
                    const json = JSON.parse(text);
                    throw new Error(json.error || `HTTP ${response.status}`);
                } catch (e) {
                    throw new Error(`HTTP ${response.status}: ${text}`);
                }
            });
        }
        return response.json();
    })
    .then(data => {
        console.log('Success response:', data);

        if (data.success) {
            alert('Message created successfully!');

            // Chiudi il modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('newMessageModal'));
            if (modal) {
                modal.hide();
            }

            // Reset form
            document.getElementById('newMessageForm').reset();

            // Ricarica la pagina
            setTimeout(() => {
                location.reload();
            }, 500);

        } else {
            alert('Error: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Request failed:', error);
        alert('Error creating message: ' + error.message);
    });
}
</script>
{% endblock %}