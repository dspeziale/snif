{% extends "base.html" %}

{% block title %}Message Management{% endblock %}
{% block page_title %}Message Management{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{{ url_for('index') }}">Home</a></li>
<li class="breadcrumb-item"><a href="{{ url_for('admin_dashboard') }}">Admin</a></li>
<li class="breadcrumb-item active" aria-current="page">Messages</li>
{% endblock %}

{% block content %}
<!-- Filters and Actions -->
<div class="row">
  <div class="col-12">
    <div class="card">
      <div class="card-header">
        <h3 class="card-title">
          <i class="bi bi-funnel me-2"></i>Filters & Actions
        </h3>
      </div>
      <div class="card-body">
        <div class="row">
          <div class="col-md-8">
            <div class="row">
              <div class="col-md-3">
                <select class="form-select" id="typeFilter">
                  <option value="">All Types</option>
                  {% for msg_type in message_types %}
                  <option value="{{ msg_type.type }}">{{ msg_type.label }}</option>
                  {% endfor %}
                </select>
              </div>
              <div class="col-md-3">
                <select class="form-select" id="priorityFilter">
                  <option value="">All Priorities</option>
                  {% for priority in priorities %}
                  <option value="{{ priority.level }}">{{ priority.label }}</option>
                  {% endfor %}
                </select>
              </div>
              <div class="col-md-3">
                <select class="form-select" id="statusFilter">
                  <option value="">All Status</option>
                  <option value="unread">Unread Only</option>
                  <option value="read">Read Only</option>
                  <option value="archived">Archived</option>
                </select>
              </div>
              <div class="col-md-3">
                <button type="button" class="btn btn-primary" onclick="applyFilters()">
                  <i class="bi bi-search me-1"></i>Filter
                </button>
                <button type="button" class="btn btn-secondary" onclick="clearFilters()">
                  <i class="bi bi-x-circle me-1"></i>Clear
                </button>
              </div>
            </div>
          </div>
          <div class="col-md-4 text-end">
            <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#newMessageModal">
              <i class="bi bi-plus-circle me-1"></i>New Message
            </button>
            <button type="button" class="btn btn-warning" onclick="markAllRead()">
              <i class="bi bi-check-all me-1"></i>Mark All Read
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Messages Table -->
<div class="row">
  <div class="col-12">
    <div class="card">
      <div class="card-header">
        <h3 class="card-title">
          <i class="bi bi-chat-text me-2"></i>Messages
          <span class="badge bg-primary ms-2">{{ messages|length }}</span>
        </h3>
      </div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-bordered table-striped" id="messagesTable">
            <thead>
              <tr>
                <th width="30">
                  <input type="checkbox" id="selectAllMessages" onchange="toggleAllMessages()">
                </th>
                <th width="50">Avatar</th>
                <th>Sender</th>
                <th>Subject</th>
                <th>Content</th>
                <th>Type</th>
                <th>Priority</th>
                <th>Status</th>
                <th>Timestamp</th>
                <th width="150">Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for message in messages %}
              <tr class="{% if message.unread %}table-info{% endif %}" data-message-id="{{ message.id }}">
                <td>
                  <input type="checkbox" class="message-checkbox" value="{{ message.id }}">
                </td>
                <td>
                  <img src="{{ message.avatar or url_for('static', filename='assets/img/user-default.jpg') }}"
                       alt="Avatar" class="img-circle" width="40" height="40">
                </td>
                <td>
                  <strong>{{ message.sender }}</strong>
                  {% if message.unread %}
                  <span class="badge bg-danger badge-sm ms-1">Unread</span>
                  {% endif %}
                </td>
                <td>
                  <strong>{{ message.subject or 'No Subject' }}</strong>
                </td>
                <td>
                  <div class="message-content" style="max-width: 300px;">
                    {{ message.content[:100] }}
                    {% if message.content|length > 100 %}
                    <span class="text-muted">...</span>
                    <button class="btn btn-link btn-sm p-0" onclick="toggleMessageContent({{ message.id }})">
                      <small>Show more</small>
                    </button>
                    <div class="full-content d-none">{{ message.content }}</div>
                    {% endif %}
                  </div>
                </td>
                <td>
                  {% if message.type_info %}
                  <span class="badge bg-{{ message.type_info.color }}">
                    <i class="bi {{ message.type_info.icon }} me-1"></i>{{ message.type_info.label }}
                  </span>
                  {% else %}
                  <span class="badge bg-secondary">Unknown</span>
                  {% endif %}
                </td>
                <td>
                  {% if message.priority_info %}
                  <span class="badge bg-{{ message.priority_info.color }}">
                    <i class="bi {{ message.priority_info.icon }} me-1"></i>{{ message.priority_info.label }}
                  </span>
                  {% else %}
                  <span class="badge bg-secondary">Normal</span>
                  {% endif %}
                </td>
                <td>
                  {% if message.unread %}
                  <span class="badge bg-warning">Unread</span>
                  {% elif message.archived %}
                  <span class="badge bg-secondary">Archived</span>
                  {% else %}
                  <span class="badge bg-success">Read</span>
                  {% endif %}
                </td>
                <td>
                  <small>{{ message.time }}</small>
                  <br>
                  <small class="text-muted">{{ message.timestamp[:10] if message.timestamp else '' }}</small>
                </td>
                <td>
                  <div class="btn-group btn-group-sm" role="group">
                    {% if message.unread %}
                    <button class="btn btn-outline-success" onclick="markMessageRead({{ message.id }})" title="Mark as Read">
                      <i class="bi bi-check"></i>
                    </button>
                    {% endif %}

                    <button class="btn btn-outline-primary" onclick="viewMessage({{ message.id }})" title="View">
                      <i class="bi bi-eye"></i>
                    </button>

                    {% if not message.archived %}
                    <button class="btn btn-outline-warning" onclick="archiveMessage({{ message.id }})" title="Archive">
                      <i class="bi bi-archive"></i>
                    </button>
                    {% endif %}

                    <button class="btn btn-outline-danger" onclick="deleteMessage({{ message.id }})" title="Delete">
                      <i class="bi bi-trash"></i>
                    </button>
                  </div>
                </td>
              </tr>
              {% else %}
              <tr>
                <td colspan="10" class="text-center text-muted py-4">
                  <i class="bi bi-inbox display-4"></i>
                  <br>
                  No messages found
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>

      <!-- Pagination -->
      {% if pagination and pagination.pages > 1 %}
      <div class="card-footer">
        <nav aria-label="Messages pagination">
          <ul class="pagination justify-content-center mb-0">
            <li class="page-item {% if not pagination.has_prev %}disabled{% endif %}">
              <a class="page-link" href="?page={{ pagination.page - 1 if pagination.has_prev else 1 }}">Previous</a>
            </li>

            {% for page_num in range(1, pagination.pages + 1) %}
              {% if page_num == pagination.page %}
              <li class="page-item active">
                <a class="page-link" href="?page={{ page_num }}">{{ page_num }}</a>
              </li>
              {% elif page_num <= 3 or page_num > pagination.pages - 3 or (page_num >= pagination.page - 1 and page_num <= pagination.page + 1) %}
              <li class="page-item">
                <a class="page-link" href="?page={{ page_num }}">{{ page_num }}</a>
              </li>
              {% elif page_num == 4 or page_num == pagination.pages - 3 %}
              <li class="page-item disabled">
                <span class="page-link">...</span>
              </li>
              {% endif %}
            {% endfor %}

            <li class="page-item {% if not pagination.has_next %}disabled{% endif %}">
              <a class="page-link" href="?page={{ pagination.page + 1 if pagination.has_next else pagination.pages }}">Next</a>
            </li>
          </ul>
        </nav>

        <div class="text-center mt-2">
          <small class="text-muted">
            Showing {{ ((pagination.page - 1) * pagination.per_page) + 1 }} to
            {{ pagination.page * pagination.per_page if pagination.page * pagination.per_page < pagination.total else pagination.total }}
            of {{ pagination.total }} messages
          </small>
        </div>
      </div>
      {% endif %}
    </div>
  </div>
</div>

<!-- Bulk Actions -->
<div class="row">
  <div class="col-12">
    <div class="card">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <strong>Bulk Actions:</strong>
            <button class="btn btn-sm btn-success ms-2" onclick="bulkMarkRead()" id="bulkReadBtn" disabled>
              <i class="bi bi-check-all me-1"></i>Mark Selected as Read
            </button>
            <button class="btn btn-sm btn-warning ms-1" onclick="bulkArchive()" id="bulkArchiveBtn" disabled>
              <i class="bi bi-archive me-1"></i>Archive Selected
            </button>
            <button class="btn btn-sm btn-danger ms-1" onclick="bulkDelete()" id="bulkDeleteBtn" disabled>
              <i class="bi bi-trash me-1"></i>Delete Selected
            </button>
          </div>
          <div>
            <span id="selectedCount">0</span> messages selected
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- New Message Modal -->
<div class="modal fade" id="newMessageModal" tabindex="-1" aria-labelledby="newMessageModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="newMessageModalLabel">Create New Message</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="newMessageForm">
          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <label for="messageSender" class="form-label">Sender *</label>
                <input type="text" class="form-control" id="messageSender" required>
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <label for="messageSubject" class="form-label">Subject</label>
                <input type="text" class="form-control" id="messageSubject">
              </div>
            </div>
          </div>

          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <label for="messageType" class="form-label">Type</label>
                <select class="form-select" id="messageType">
                  <option value="">Select Type</option>
                  {% for msg_type in message_types %}
                  <option value="{{ msg_type.type }}">{{ msg_type.label }}</option>
                  {% endfor %}
                </select>
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <label for="messagePriority" class="form-label">Priority</label>
                <select class="form-select" id="messagePriority">
                  {% for priority in priorities %}
                  <option value="{{ priority.level }}" {% if priority.level == 'medium' %}selected{% endif %}>
                    {{ priority.label }}
                  </option>
                  {% endfor %}
                </select>
              </div>
            </div>
          </div>

          <div class="mb-3">
            <label for="messageContent" class="form-label">Content *</label>
            <textarea class="form-control" id="messageContent" rows="4" required></textarea>
          </div>

          <div class="mb-3">
            <label for="messageAvatar" class="form-label">Avatar URL</label>
            <input type="url" class="form-control" id="messageAvatar" placeholder="https://example.com/avatar.jpg">
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" onclick="createMessage()">
          <i class="bi bi-plus-circle me-1"></i>Create Message
        </button>
      </div>
    </div>
  </div>
</div>

<!-- View Message Modal -->
<div class="modal fade" id="viewMessageModal" tabindex="-1" aria-labelledby="viewMessageModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="viewMessageModalLabel">Message Details</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="messageViewContent">
        <!-- Content will be populated by JavaScript -->
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Filter and search functionality
function applyFilters() {
  const type = document.getElementById('typeFilter').value;
  const priority = document.getElementById('priorityFilter').value;
  const status = document.getElementById('statusFilter').value;

  const params = new URLSearchParams();
  if (type) params.append('type', type);
  if (priority) params.append('priority', priority);
  if (status === 'unread') params.append('unread_only', 'true');

  window.location.href = '?' + params.toString();
}

function clearFilters() {
  window.location.href = window.location.pathname;
}

// Message content toggle
function toggleMessageContent(messageId) {
  const row = document.querySelector(`tr[data-message-id="${messageId}"]`);
  const contentDiv = row.querySelector('.message-content');
  const fullContent = contentDiv.querySelector('.full-content');
  const button = contentDiv.querySelector('button');

  if (fullContent.classList.contains('d-none')) {
    contentDiv.innerHTML = fullContent.innerHTML +
      '<button class="btn btn-link btn-sm p-0 ms-2" onclick="toggleMessageContent(' + messageId + ')"><small>Show less</small></button>';
  } else {
    location.reload(); // Simple approach - in production you'd want to restore the truncated view
  }
}

// Individual message actions
function markMessageRead(messageId) {
  fetch(`/api/messages/${messageId}/read`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' }
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      location.reload();
    } else {
      alert('Error: ' + data.error);
    }
  })
  .catch(error => {
    console.error('Error:', error);
    alert('Error marking message as read');
  });
}

function archiveMessage(messageId) {
  if (confirm('Archive this message?')) {
    fetch(`/api/messages/${messageId}/archive`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' }
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        location.reload();
      } else {
        alert('Error: ' + data.error);
      }
    })
    .catch(error => {
      console.error('Error:', error);
      alert('Error archiving message');
    });
  }
}

function deleteMessage(messageId) {
  if (confirm('⚠️ Are you sure you want to delete this message? This action cannot be undone.')) {
    fetch(`/api/messages/${messageId}`, {
      method: 'DELETE',
      headers: { 'Content-Type': 'application/json' }
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        location.reload();
      } else {
        alert('Error: ' + data.error);
      }
    })
    .catch(error => {
      console.error('Error:', error);
      alert('Error deleting message');
    });
  }
}

function viewMessage(messageId) {
  fetch(`/api/messages/${messageId}`)
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        const message = data.data;
        document.getElementById('messageViewContent').innerHTML = `
          <div class="row">
            <div class="col-md-2">
              <img src="${message.avatar || '/static/assets/img/user-default.jpg'}" class="img-circle" width="60" height="60">
            </div>
            <div class="col-md-10">
              <h5>${message.sender}</h5>
              <h6 class="text-muted">${message.subject || 'No Subject'}</h6>
              <small class="text-muted">${message.time}</small>
              ${message.type_info ? `<span class="badge bg-${message.type_info.color} ms-2">${message.type_info.label}</span>` : ''}
              ${message.priority_info ? `<span class="badge bg-${message.priority_info.color} ms-1">${message.priority_info.label}</span>` : ''}
            </div>
          </div>
          <hr>
          <div class="message-content">
            ${message.content}
          </div>
        `;

        const modal = new bootstrap.Modal(document.getElementById('viewMessageModal'));
        modal.show();

        // Mark as read if unread
        if (message.unread) {
          markMessageRead(messageId);
        }
      } else {
        alert('Error loading message: ' + data.error);
      }
    })
    .catch(error => {
      console.error('Error:', error);
      alert('Error loading message');
    });
}

// Bulk actions
function toggleAllMessages() {
  const selectAll = document.getElementById('selectAllMessages');
  const checkboxes = document.querySelectorAll('.message-checkbox');

  checkboxes.forEach(checkbox => {
    checkbox.checked = selectAll.checked;
  });

  updateBulkActionButtons();
}

function updateBulkActionButtons() {
  const checkedBoxes = document.querySelectorAll('.message-checkbox:checked');
  const count = checkedBoxes.length;

  document.getElementById('selectedCount').textContent = count;

  const buttons = ['bulkReadBtn', 'bulkArchiveBtn', 'bulkDeleteBtn'];
  buttons.forEach(btnId => {
    document.getElementById(btnId).disabled = count === 0;
  });
}

function bulkMarkRead() {
  const selectedIds = Array.from(document.querySelectorAll('.message-checkbox:checked')).map(cb => cb.value);

  if (selectedIds.length === 0) return;

  if (confirm(`Mark ${selectedIds.length} message(s) as read?`)) {
    Promise.all(selectedIds.map(id =>
      fetch(`/api/messages/${id}/read`, { method: 'POST' })
    ))
    .then(() => location.reload())
    .catch(error => {
      console.error('Error:', error);
      alert('Error in bulk operation');
    });
  }
}

function bulkArchive() {
  const selectedIds = Array.from(document.querySelectorAll('.message-checkbox:checked')).map(cb => cb.value);

  if (selectedIds.length === 0) return;

  if (confirm(`Archive ${selectedIds.length} message(s)?`)) {
    Promise.all(selectedIds.map(id =>
      fetch(`/api/messages/${id}/archive`, { method: 'POST' })
    ))
    .then(() => location.reload())
    .catch(error => {
      console.error('Error:', error);
      alert('Error in bulk operation');
    });
  }
}

function bulkDelete() {
  const selectedIds = Array.from(document.querySelectorAll('.message-checkbox:checked')).map(cb => cb.value);

  if (selectedIds.length === 0) return;

  if (confirm(`⚠️ Delete ${selectedIds.length} message(s)? This action cannot be undone.`)) {
    Promise.all(selectedIds.map(id =>
      fetch(`/api/messages/${id}`, { method: 'DELETE' })
    ))
    .then(() => location.reload())
    .catch(error => {
      console.error('Error:', error);
      alert('Error in bulk operation');
    });
  }
}

function markAllRead() {
  if (confirm('Mark all messages as read?')) {
    fetch('/api/messages/mark-all-read', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' }
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        location.reload();
      } else {
        alert('Error: ' + data.error);
      }
    })
    .catch(error => {
      console.error('Error:', error);
      alert('Error marking all messages as read');
    });
  }
}

// Create new message
function createMessage() {
  const formData = {
    sender: document.getElementById('messageSender').value,
    subject: document.getElementById('messageSubject').value,
    content: document.getElementById('messageContent').value,
    type: document.getElementById('messageType').value,
    priority: document.getElementById('messagePriority').value,
    avatar: document.getElementById('messageAvatar').value
  };

  if (!formData.sender || !formData.content) {
    alert('Please fill in all required fields.');
    return;
  }

  fetch('/api/messages', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(formData)
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      const modal = bootstrap.Modal.getInstance(document.getElementById('newMessageModal'));
      modal.hide();
      location.reload();
    } else {
      alert('Error: ' + data.error);
    }
  })
  .catch(error => {
    console.error('Error:', error);
    alert('Error creating message');
  });
}

// Event listeners
document.addEventListener('DOMContentLoaded', function() {
  // Add event listeners to checkboxes
  document.querySelectorAll('.message-checkbox').forEach(checkbox => {
    checkbox.addEventListener('change', updateBulkActionButtons);
  });

  // Clear form when modal is hidden
  document.getElementById('newMessageModal').addEventListener('hidden.bs.modal', function() {
    document.getElementById('newMessageForm').reset();
  });
});
</script>
{% endblock %}