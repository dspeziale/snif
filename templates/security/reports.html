{% extends "base.html" %}

{% block title %}Security Reports - Security{% endblock %}
{% block page_title %}Security Reports{% endblock %}

{% block breadcrumbs %}
<li class="breadcrumb-item"><a href="{{ url_for('index') }}">Home</a></li>
<li class="breadcrumb-item"><a href="{{ url_for('security.overview') }}">Security</a></li>
<li class="breadcrumb-item active">Reports</li>
{% endblock %}

{% block content %}
<div class="container-fluid">
  <!-- Report Generation -->
  <div class="card mb-3">
    <div class="card-header">
      <h3 class="card-title">
        <i class="bi bi-file-earmark-plus"></i> Generate New Report
      </h3>
    </div>
    <div class="card-body">
      <form method="POST" action="{{ url_for('security.reports') }}">
        <div class="row">
          <div class="col-md-3">
            <label class="form-label">Report Type</label>
            <select name="report_type" class="form-select" required>
              <option value="">Select Report Type</option>
              <option value="vulnerability_summary">Vulnerability Summary</option>
              <option value="host_security_report">Host Security Report</option>
              <option value="cve_analysis">CVE Analysis</option>
              <option value="compliance_check">Compliance Check</option>
              <option value="executive_summary">Executive Summary</option>
              <option value="technical_details">Technical Details</option>
            </select>
          </div>
          <div class="col-md-2">
            <label class="form-label">Format</label>
            <select name="format" class="form-select" required>
              <option value="pdf">PDF</option>
              <option value="html">HTML</option>
              <option value="csv">CSV</option>
              <option value="json">JSON</option>
            </select>
          </div>
          <div class="col-md-2">
            <label class="form-label">Date From</label>
            <input type="date" name="date_from" class="form-control">
          </div>
          <div class="col-md-2">
            <label class="form-label">Date To</label>
            <input type="date" name="date_to" class="form-control">
          </div>
          <div class="col-md-3">
            <label class="form-label">&nbsp;</label>
            <div class="d-grid">
              <button type="submit" class="btn btn-primary">
                <i class="bi bi-file-earmark-plus"></i> Generate Report
              </button>
            </div>
          </div>
        </div>

        <!-- Advanced Options -->
        <div class="mt-3">
          <button type="button" class="btn btn-outline-secondary btn-sm" data-bs-toggle="collapse" data-bs-target="#advancedOptions">
            <i class="bi bi-gear"></i> Advanced Options
          </button>
        </div>

        <div class="collapse mt-3" id="advancedOptions">
          <div class="card card-body">
            <div class="row">
              <div class="col-md-3">
                <label class="form-label">Severity Filter</label>
                <select name="severity_filter" class="form-select">
                  <option value="">All Severities</option>
                  <option value="CRITICAL">Critical Only</option>
                  <option value="HIGH">High and Above</option>
                  <option value="MEDIUM">Medium and Above</option>
                  <option value="LOW">All Severities</option>
                </select>
              </div>
              <div class="col-md-3">
                <label class="form-label">Host Filter</label>
                <input type="text" name="host_filter" class="form-control" placeholder="192.168.1.0/24">
              </div>
              <div class="col-md-3">
                <label class="form-label">Include Charts</label>
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" name="include_charts" checked>
                  <label class="form-check-label">
                    Include visual charts and graphs
                  </label>
                </div>
              </div>
              <div class="col-md-3">
                <label class="form-label">Include Raw Data</label>
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" name="include_raw_data">
                  <label class="form-check-label">
                    Include raw scan data
                  </label>
                </div>
              </div>
            </div>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- Quick Reports -->
  <div class="row mb-3">
    <div class="col-md-4">
      <div class="card">
        <div class="card-body text-center">
          <i class="bi bi-shield-exclamation fs-1 text-danger"></i>
          <h5 class="card-title mt-2">Critical Vulnerabilities</h5>
          <p class="card-text">Generate report of all critical security issues</p>
          <a href="{{ url_for('security.reports', quick='critical') }}" class="btn btn-danger">
            <i class="bi bi-download"></i> Generate
          </a>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card">
        <div class="card-body text-center">
          <i class="bi bi-graph-up fs-1 text-primary"></i>
          <h5 class="card-title mt-2">Executive Summary</h5>
          <p class="card-text">High-level security overview for management</p>
          <a href="{{ url_for('security.reports', quick='executive') }}" class="btn btn-primary">
            <i class="bi bi-download"></i> Generate
          </a>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card">
        <div class="card-body text-center">
          <i class="bi bi-list-check fs-1 text-success"></i>
          <h5 class="card-title mt-2">Compliance Report</h5>
          <p class="card-text">Security compliance and audit report</p>
          <a href="{{ url_for('security.reports', quick='compliance') }}" class="btn btn-success">
            <i class="bi bi-download"></i> Generate
          </a>
        </div>
      </div>
    </div>
  </div>

  <!-- Recent Reports -->
  <div class="card">
    <div class="card-header">
      <h3 class="card-title">
        <i class="bi bi-clock-history"></i> Recent Reports
      </h3>
      <div class="card-tools">
        <a href="{{ url_for('security.reports') }}?export=csv" class="btn btn-sm btn-outline-primary">
          <i class="bi bi-download"></i> Export List
        </a>
      </div>
    </div>
    <div class="card-body">
      {% if reports %}
      <div class="table-responsive">
        <table class="table table-hover">
          <thead>
            <tr>
              <th>Report Name</th>
              <th>Type</th>
              <th>Format</th>
              <th>Generated</th>
              <th>File Size</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for report in reports %}
            <tr>
              <td>
                <strong>{{ report.name }}</strong>
                {% if report.description %}
                <br><small class="text-muted">{{ report.description }}</small>
                {% endif %}
              </td>
              <td>
                <span class="badge bg-info">{{ report.type|replace('_', ' ')|title }}</span>
              </td>
              <td>
                <span class="badge bg-secondary">{{ report.format|upper }}</span>
              </td>
              <td>
                <small class="text-muted">{{ report.created_at|format_datetime }}</small>
                {% if report.generated_by %}
                <br><small class="text-muted">by {{ report.generated_by }}</small>
                {% endif %}
              </td>
              <td>
                {% if report.file_size %}
                <small class="text-muted">{{ report.file_size|filesizeformat }}</small>
                {% else %}
                <span class="text-muted">-</span>
                {% endif %}
              </td>
              <td>
                {% if report.status == 'completed' %}
                <span class="badge bg-success">Ready</span>
                {% elif report.status == 'generating' %}
                <span class="badge bg-primary">
                  <i class="bi bi-arrow-clockwise"></i> Generating
                </span>
                {% elif report.status == 'failed' %}
                <span class="badge bg-danger">Failed</span>
                {% else %}
                <span class="badge bg-warning">{{ report.status|title }}</span>
                {% endif %}
              </td>
              <td>
                <div class="btn-group btn-group-sm">
                  {% if report.status == 'completed' %}
                  <a href="{{ url_for('security.download_report', report_id=report.id) }}"
                     class="btn btn-outline-primary" title="Download">
                    <i class="bi bi-download"></i>
                  </a>
                  <a href="{{ url_for('security.view_report', report_id=report.id) }}"
                     class="btn btn-outline-info" title="Preview">
                    <i class="bi bi-eye"></i>
                  </a>
                  {% endif %}
                  <button class="btn btn-outline-danger"
                          onclick="deleteReport('{{ report.id }}')"
                          title="Delete">
                    <i class="bi bi-trash"></i>
                  </button>
                </div>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
      <div class="text-center py-4">
        <i class="bi bi-file-earmark fs-1 text-muted"></i>
        <p class="text-muted mt-2">No reports generated yet.</p>
        <p class="text-muted">Use the form above to generate your first security report.</p>
      </div>
      {% endif %}
    </div>
  </div>

  <!-- Report Templates -->
  <div class="card mt-3">
    <div class="card-header">
      <h3 class="card-title">
        <i class="bi bi-file-earmark-text"></i> Report Templates
      </h3>
    </div>
    <div class="card-body">
      <div class="row">
        <div class="col-md-6">
          <h5>Available Templates</h5>
          <div class="list-group">
            <div class="list-group-item d-flex justify-content-between align-items-center">
              <div>
                <strong>Vulnerability Assessment Report</strong>
                <br><small class="text-muted">Comprehensive vulnerability analysis with recommendations</small>
              </div>
              <button class="btn btn-sm btn-outline-primary" onclick="useTemplate('vuln_assessment')">
                <i class="bi bi-arrow-right"></i> Use
              </button>
            </div>
            <div class="list-group-item d-flex justify-content-between align-items-center">
              <div>
                <strong>Network Security Audit</strong>
                <br><small class="text-muted">Complete network security posture evaluation</small>
              </div>
              <button class="btn btn-sm btn-outline-primary" onclick="useTemplate('network_audit')">
                <i class="bi bi-arrow-right"></i> Use
              </button>
            </div>
            <div class="list-group-item d-flex justify-content-between align-items-center">
              <div>
                <strong>Compliance Report</strong>
                <br><small class="text-muted">Security compliance status and gaps analysis</small>
              </div>
              <button class="btn btn-sm btn-outline-primary" onclick="useTemplate('compliance')">
                <i class="bi bi-arrow-right"></i> Use
              </button>
            </div>
          </div>
        </div>
        <div class="col-md-6">
          <h5>Template Management</h5>
          <div class="alert alert-info">
            <i class="bi bi-info-circle"></i>
            <strong>Custom Templates:</strong> You can create custom report templates by modifying the existing ones or creating new ones from scratch.
          </div>
          <div class="d-grid gap-2">
            <a href="{{ url_for('admin.report_templates') }}" class="btn btn-outline-secondary">
              <i class="bi bi-gear"></i> Manage Templates
            </a>
            <button class="btn btn-outline-success" onclick="createTemplate()">
              <i class="bi bi-plus"></i> Create New Template
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
function deleteReport(reportId) {
    if (confirm('Are you sure you want to delete this report?')) {
        fetch(`/security/api/reports/${reportId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Failed to delete report: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to delete report');
        });
    }
}

function useTemplate(templateName) {
    // Pre-fill the form with template settings
    const reportTypeSelect = document.querySelector('select[name="report_type"]');
    const formatSelect = document.querySelector('select[name="format"]');

    switch(templateName) {
        case 'vuln_assessment':
            reportTypeSelect.value = 'vulnerability_summary';
            formatSelect.value = 'pdf';
            break;
        case 'network_audit':
            reportTypeSelect.value = 'host_security_report';
            formatSelect.value = 'pdf';
            break;
        case 'compliance':
            reportTypeSelect.value = 'compliance_check';
            formatSelect.value = 'pdf';
            break;
    }

    // Scroll to form
    document.querySelector('.card').scrollIntoView({ behavior: 'smooth' });
}

function createTemplate() {
    alert('Template creation feature coming soon!');
}

// Auto-refresh for generating reports
document.addEventListener('DOMContentLoaded', function() {
    const generatingReports = document.querySelectorAll('.badge:contains("Generating")');
    if (generatingReports.length > 0) {
        setTimeout(() => {
            location.reload();
        }, 30000); // Refresh every 30 seconds
    }
});
</script>
{% endblock %}