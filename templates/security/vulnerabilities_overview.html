{% extends "base.html" %}

{% block title %}Vulnerabilities Overview - Security{% endblock %}
{% block page_title %}Vulnerabilities Overview{% endblock %}

{% block breadcrumbs %}
<li class="breadcrumb-item"><a href="{{ url_for('index') }}">Home</a></li>
<li class="breadcrumb-item"><a href="{{ url_for('security.overview') }}">Security</a></li>
<li class="breadcrumb-item active">Vulnerabilities Overview</li>
{% endblock %}

{% block content %}
<div class="container-fluid">
  {% if error %}
  <div class="alert alert-danger">
    <i class="bi bi-exclamation-triangle"></i> Error: {{ error }}
  </div>
  {% endif %}

  <!-- Summary Statistics -->
  <div class="row mb-4">
    <div class="col-lg-3 col-6">
      <div class="small-box bg-danger">
        <div class="inner">
          <h3>{{ severity_stats|selectattr('severity', 'equalto', 'CRITICAL')|map(attribute='count')|first or 0 }}</h3>
          <p>Critical</p>
        </div>
        <div class="icon">
          <i class="bi bi-exclamation-triangle-fill"></i>
        </div>
        <a href="{{ url_for('security.vulnerabilities') }}?severity=CRITICAL" class="small-box-footer">
          View Details <i class="fas fa-arrow-circle-right"></i>
        </a>
      </div>
    </div>

    <div class="col-lg-3 col-6">
      <div class="small-box bg-warning">
        <div class="inner">
          <h3>{{ severity_stats|selectattr('severity', 'equalto', 'HIGH')|map(attribute='count')|first or 0 }}</h3>
          <p>High</p>
        </div>
        <div class="icon">
          <i class="bi bi-exclamation-triangle"></i>
        </div>
        <a href="{{ url_for('security.vulnerabilities') }}?severity=HIGH" class="small-box-footer">
          View Details <i class="fas fa-arrow-circle-right"></i>
        </a>
      </div>
    </div>

    <div class="col-lg-3 col-6">
      <div class="small-box bg-info">
        <div class="inner">
          <h3>{{ severity_stats|selectattr('severity', 'equalto', 'MEDIUM')|map(attribute='count')|first or 0 }}</h3>
          <p>Medium</p>
        </div>
        <div class="icon">
          <i class="bi bi-info-circle"></i>
        </div>
        <a href="{{ url_for('security.vulnerabilities') }}?severity=MEDIUM" class="small-box-footer">
          View Details <i class="fas fa-arrow-circle-right"></i>
        </a>
      </div>
    </div>

    <div class="col-lg-3 col-6">
      <div class="small-box bg-success">
        <div class="inner">
          <h3>{{ severity_stats|selectattr('severity', 'equalto', 'LOW')|map(attribute='count')|first or 0 }}</h3>
          <p>Low</p>
        </div>
        <div class="icon">
          <i class="bi bi-check-circle"></i>
        </div>
        <a href="{{ url_for('security.vulnerabilities') }}?severity=LOW" class="small-box-footer">
          View Details <i class="fas fa-arrow-circle-right"></i>
        </a>
      </div>
    </div>
  </div>

  <div class="row">
    <!-- Severity Distribution -->
    <div class="col-md-6">
      <div class="card">
        <div class="card-header">
          <h3 class="card-title">
            <i class="bi bi-pie-chart"></i> Severity Distribution
          </h3>
        </div>
        <div class="card-body">
          {% if severity_stats %}
          <canvas id="severityChart" width="400" height="200"></canvas>
          {% else %}
          <div class="text-center py-4">
            <i class="bi bi-pie-chart fs-1 text-muted"></i>
            <p class="text-muted mt-2">No vulnerability data available</p>
          </div>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Vulnerability Types -->
    <div class="col-md-6">
      <div class="card">
        <div class="card-header">
          <h3 class="card-title">
            <i class="bi bi-bar-chart"></i> Vulnerability Types
          </h3>
        </div>
        <div class="card-body">
          {% if type_stats %}
          <div class="table-responsive">
            <table class="table table-sm">
              <thead>
                <tr>
                  <th>Type</th>
                  <th>Count</th>
                  <th>Percentage</th>
                </tr>
              </thead>
              <tbody>
                {% for type in type_stats[:5] %}
                <tr>
                  <td>{{ type.vuln_type or 'Unknown' }}</td>
                  <td><span class="badge bg-info">{{ type.count }}</span></td>
                  <td>
                    {% if total_vulns > 0 %}
                    <div class="progress" style="height: 20px;">
                      <div class="progress-bar"
                           role="progressbar"
                           style="width: {{ (type.count / total_vulns * 100)|round(1) }}%">
                        {{ (type.count / total_vulns * 100)|round(1) }}%
                      </div>
                    </div>
                    {% else %}
                    0%
                    {% endif %}
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          {% else %}
          <div class="text-center py-4">
            <i class="bi bi-bar-chart fs-1 text-muted"></i>
            <p class="text-muted mt-2">No vulnerability type data available</p>
          </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <!-- Most Vulnerable Hosts -->
  <div class="card mt-3">
    <div class="card-header">
      <h3 class="card-title">
        <i class="bi bi-hdd-stack"></i> Most Vulnerable Hosts
      </h3>
      <div class="card-tools">
        <span class="badge bg-secondary">Top 10</span>
      </div>
    </div>
    <div class="card-body">
      {% if vulnerable_hosts %}
      <div class="table-responsive">
        <table class="table table-hover">
          <thead>
            <tr>
              <th>Rank</th>
              <th>Host</th>
              <th>Critical</th>
              <th>High</th>
              <th>Medium</th>
              <th>Low</th>
              <th>Total</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for host in vulnerable_hosts %}
            <tr>
              <td>
                <span class="badge bg-{{ 'danger' if loop.index <= 3 else 'warning' if loop.index <= 5 else 'info' }}">
                  #{{ loop.index }}
                </span>
              </td>
              <td>
                <strong>{{ host.ip_address }}</strong>
                {% if host.hostname %}
                <br><small class="text-muted">{{ host.hostname }}</small>
                {% endif %}
              </td>
              <td>
                {% if host.critical_count > 0 %}
                <span class="badge bg-danger">{{ host.critical_count }}</span>
                {% else %}
                <span class="text-muted">0</span>
                {% endif %}
              </td>
              <td>
                {% if host.high_count > 0 %}
                <span class="badge bg-warning">{{ host.high_count }}</span>
                {% else %}
                <span class="text-muted">0</span>
                {% endif %}
              </td>
              <td>
                {% if host.medium_count > 0 %}
                <span class="badge bg-info">{{ host.medium_count }}</span>
                {% else %}
                <span class="text-muted">0</span>
                {% endif %}
              </td>
              <td>
                {% if host.low_count > 0 %}
                <span class="badge bg-success">{{ host.low_count }}</span>
                {% else %}
                <span class="text-muted">0</span>
                {% endif %}
              </td>
              <td>
                <strong>{{ host.total_vulns }}</strong>
              </td>
              <td>
                <div class="btn-group btn-group-sm">
                  <a href="{{ url_for('network.host_detail', ip_address=host.ip_address) }}"
                     class="btn btn-outline-primary" title="Host Details">
                    <i class="bi bi-eye"></i>
                  </a>
                  <a href="{{ url_for('security.vulnerabilities') }}?host={{ host.ip_address }}"
                     class="btn btn-outline-warning" title="View Vulnerabilities">
                    <i class="bi bi-shield-exclamation"></i>
                  </a>
                </div>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
      <div class="text-center py-4">
        <i class="bi bi-hdd-stack fs-1 text-muted"></i>
        <p class="text-muted mt-2">No vulnerable hosts data available</p>
      </div>
      {% endif %}
    </div>
  </div>

  <!-- Common CVEs -->
  <div class="card mt-3">
    <div class="card-header">
      <h3 class="card-title">
        <i class="bi bi-shield-exclamation"></i> Most Common CVEs
      </h3>
      <div class="card-tools">
        <span class="badge bg-secondary">Top 10</span>
      </div>
    </div>
    <div class="card-body">
      {% if common_cves %}
      <div class="table-responsive">
        <table class="table table-hover">
          <thead>
            <tr>
              <th>Rank</th>
              <th>CVE ID</th>
              <th>Severity</th>
              <th>Occurrences</th>
              <th>Types</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for cve in common_cves %}
            <tr>
              <td>
                <span class="badge bg-{{ 'danger' if loop.index <= 3 else 'warning' if loop.index <= 5 else 'info' }}">
                  #{{ loop.index }}
                </span>
              </td>
              <td>
                <a href="{{ url_for('security.cve_detail', cve_id=cve.cve_id) }}" class="text-decoration-none">
                  <code>{{ cve.cve_id }}</code>
                </a>
              </td>
              <td>
                <span class="badge bg-{{ 'danger' if cve.severity == 'CRITICAL' else 'warning' if cve.severity == 'HIGH' else 'info' if cve.severity == 'MEDIUM' else 'success' }}">
                  {{ cve.severity }}
                </span>
              </td>
              <td>
                <strong>{{ cve.count }}</strong>
              </td>
              <td>
                {% if cve.types %}
                <small class="text-muted">{{ cve.types[:50] }}{% if cve.types|length > 50 %}...{% endif %}</small>
                {% else %}
                <span class="text-muted">N/A</span>
                {% endif %}
              </td>
              <td>
                <div class="btn-group btn-group-sm">
                  <a href="{{ url_for('security.cve_detail', cve_id=cve.cve_id) }}"
                     class="btn btn-outline-primary" title="CVE Details">
                    <i class="bi bi-eye"></i>
                  </a>
                  <a href="https://nvd.nist.gov/vuln/detail/{{ cve.cve_id }}"
                     target="_blank" class="btn btn-outline-info" title="View on NVD">
                    <i class="bi bi-box-arrow-up-right"></i>
                  </a>
                </div>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
      <div class="text-center py-4">
        <i class="bi bi-shield-exclamation fs-1 text-muted"></i>
        <p class="text-muted mt-2">No CVE data available</p>
      </div>
      {% endif %}
    </div>
  </div>

  <!-- Critical Vulnerabilities -->
  {% if critical_vulns %}
  <div class="card mt-3">
    <div class="card-header">
      <h3 class="card-title">
        <i class="bi bi-exclamation-triangle-fill text-danger"></i> Recent Critical Vulnerabilities
      </h3>
    </div>
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-hover table-sm">
          <thead>
            <tr>
              <th>CVE ID</th>
              <th>Host</th>
              <th>Type</th>
              <th>Port</th>
              <th>Service</th>
              <th>First Seen</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for vuln in critical_vulns %}
            <tr>
              <td>
                {% if vuln.cve_id %}
                <a href="{{ url_for('security.cve_detail', cve_id=vuln.cve_id) }}" class="text-decoration-none">
                  <code>{{ vuln.cve_id }}</code>
                </a>
                {% else %}
                <span class="text-muted">N/A</span>
                {% endif %}
              </td>
              <td>
                <a href="{{ url_for('network.host_detail', ip_address=vuln.ip_address) }}" class="text-decoration-none">
                  {{ vuln.ip_address }}
                </a>
                {% if vuln.hostname %}
                <br><small class="text-muted">{{ vuln.hostname }}</small>
                {% endif %}
              </td>
              <td>
                {% if vuln.vuln_type %}
                <small class="text-muted">{{ vuln.vuln_type }}</small>
                {% else %}
                <span class="text-muted">N/A</span>
                {% endif %}
              </td>
              <td>
                {% if vuln.port %}
                <code>{{ vuln.port }}</code>
                {% else %}
                <span class="text-muted">N/A</span>
                {% endif %}
              </td>
              <td>
                {% if vuln.service %}
                {{ vuln.service }}
                {% else %}
                <span class="text-muted">N/A</span>
                {% endif %}
              </td>
              <td>
                <small class="text-muted">{{ vuln.first_seen|format_datetime if vuln.first_seen else 'N/A' }}</small>
              </td>
              <td>
                <a href="{{ url_for('security.vulnerability_detail', vuln_id=vuln.id) }}"
                   class="btn btn-sm btn-outline-primary">
                  <i class="bi bi-eye"></i>
                </a>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
  {% endif %}

  <!-- Port Distribution -->
  {% if port_vulns %}
  <div class="card mt-3">
    <div class="card-header">
      <h3 class="card-title">
        <i class="bi bi-hdd-network"></i> Vulnerabilities by Port
      </h3>
    </div>
    <div class="card-body">
      <div class="row">
        {% for port in port_vulns %}
        <div class="col-md-3 col-sm-6">
          <div class="info-box">
            <span class="info-box-icon bg-info">
              <i class="bi bi-hdd-network"></i>
            </span>
            <div class="info-box-content">
              <span class="info-box-text">Port {{ port.port }}/{{ port.protocol|upper if port.protocol else 'TCP' }}</span>
              <span class="info-box-number">{{ port.count }}</span>
              <div class="progress">
                <div class="progress-bar" style="width: {{ (port.count / port_vulns[0].count * 100)|round(0) }}%"></div>
              </div>
              <span class="progress-description">vulnerabilities</span>
            </div>
          </div>
        </div>
        {% endfor %}
      </div>
    </div>
  </div>
  {% endif %}

  <!-- Quick Actions -->
  <div class="card mt-3">
    <div class="card-header">
      <h3 class="card-title">
        <i class="bi bi-lightning"></i> Quick Actions
      </h3>
    </div>
    <div class="card-body">
      <div class="btn-group" role="group">
        <a href="{{ url_for('security.vulnerabilities') }}" class="btn btn-primary">
          <i class="bi bi-list"></i> View All Vulnerabilities
        </a>
        <a href="{{ url_for('security.vulnerabilities') }}?severity=CRITICAL" class="btn btn-danger">
          <i class="bi bi-exclamation-triangle-fill"></i> Critical Only
        </a>
        <a href="{{ url_for('security.reports') }}" class="btn btn-outline-info">
          <i class="bi bi-file-earmark-text"></i> Generate Report
        </a>
        <a href="{{ url_for('tools.security_scanner') }}" class="btn btn-outline-success">
          <i class="bi bi-search"></i> New Scan
        </a>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Severity Distribution Chart
{% if severity_stats %}
const severityCtx = document.getElementById('severityChart').getContext('2d');
const severityChart = new Chart(severityCtx, {
    type: 'doughnut',
    data: {
        labels: [
            {% for stat in severity_stats %}
            '{{ stat.severity }}'{% if not loop.last %},{% endif %}
            {% endfor %}
        ],
        datasets: [{
            data: [
                {% for stat in severity_stats %}
                {{ stat.count }}{% if not loop.last %},{% endif %}
                {% endfor %}
            ],
            backgroundColor: [
                {% for stat in severity_stats %}
                {% if stat.severity == 'CRITICAL' %}'#dc3545'{% elif stat.severity == 'HIGH' %}'#ffc107'{% elif stat.severity == 'MEDIUM' %}'#17a2b8'{% elif stat.severity == 'LOW' %}'#28a745'{% else %}'#6c757d'{% endif %}{% if not loop.last %},{% endif %}
                {% endfor %}
            ]
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'bottom'
            }
        }
    }
});
{% endif %}
</script>
{% endblock %}