{% extends "base.html" %}

{% block title %}Vulnerability Details - Security{% endblock %}
{% block page_title %}Vulnerability Details{% endblock %}

{% block breadcrumbs %}
<li class="breadcrumb-item"><a href="{{ url_for('index') }}">Home</a></li>
<li class="breadcrumb-item"><a href="{{ url_for('security.overview') }}">Security</a></li>
<li class="breadcrumb-item"><a href="{{ url_for('security.vulnerabilities') }}">Vulnerabilities</a></li>
<li class="breadcrumb-item active">Details</li>
{% endblock %}

{% block content %}
<div class="container-fluid">
  <!-- Vulnerability Header -->
  <div class="card mb-3">
    <div class="card-header">
      <h3 class="card-title">
        <i class="bi bi-shield-exclamation"></i> Vulnerability #{{ vulnerability.id }}
        {% if vulnerability.severity %}
        <span class="badge bg-{{ 'danger' if vulnerability.severity == 'CRITICAL' else 'warning' if vulnerability.severity == 'HIGH' else 'info' if vulnerability.severity == 'MEDIUM' else 'success' }} ms-2">
          {{ vulnerability.severity }}
        </span>
        {% endif %}
      </h3>
      <div class="card-tools">
        {% if vulnerability.cve_id %}
        <a href="{{ url_for('security.cve_detail', cve_id=vulnerability.cve_id) }}"
           class="btn btn-outline-primary btn-sm">
          <i class="bi bi-link"></i> View CVE Details
        </a>
        <a href="https://nvd.nist.gov/vuln/detail/{{ vulnerability.cve_id }}"
           target="_blank" class="btn btn-outline-info btn-sm">
          <i class="bi bi-box-arrow-up-right"></i> NVD
        </a>
        {% endif %}
      </div>
    </div>
    <div class="card-body">
      <div class="row">
        <div class="col-md-6">
          <h5>Basic Information</h5>
          <table class="table table-sm">
            <tr>
              <td><strong>CVE ID:</strong></td>
              <td>
                {% if vulnerability.cve_id %}
                <code>{{ vulnerability.cve_id }}</code>
                {% else %}
                <span class="text-muted">N/A</span>
                {% endif %}
              </td>
            </tr>
            <tr>
              <td><strong>Host:</strong></td>
              <td>
                <a href="{{ url_for('network.host_detail', ip_address=vulnerability.ip_address) }}" class="text-decoration-none">
                  {{ vulnerability.ip_address }}
                </a>
                {% if vulnerability.hostname %}
                <br><small class="text-muted">{{ vulnerability.hostname }}</small>
                {% endif %}
              </td>
            </tr>
            <tr>
              <td><strong>Port:</strong></td>
              <td>
                {% if vulnerability.port %}
                <code>{{ vulnerability.port }}</code>
                {% else %}
                <span class="text-muted">N/A</span>
                {% endif %}
              </td>
            </tr>
            <tr>
              <td><strong>Service:</strong></td>
              <td>
                {% if vulnerability.service %}
                {{ vulnerability.service }}
                {% if vulnerability.service_version %}
                <br><small class="text-muted">Version: {{ vulnerability.service_version }}</small>
                {% endif %}
                {% else %}
                <span class="text-muted">N/A</span>
                {% endif %}
              </td>
            </tr>
            <tr>
              <td><strong>Vulnerability Type:</strong></td>
              <td>
                {% if vulnerability.vuln_type %}
                <span class="badge bg-light text-dark">{{ vulnerability.vuln_type }}</span>
                {% else %}
                <span class="text-muted">N/A</span>
                {% endif %}
              </td>
            </tr>
          </table>
        </div>
        <div class="col-md-6">
          <h5>Risk Assessment</h5>
          <table class="table table-sm">
            <tr>
              <td><strong>CVSS Score:</strong></td>
              <td>
                {% if vulnerability.cvss_score %}
                <span class="badge bg-{{ 'danger' if vulnerability.cvss_score >= 9 else 'warning' if vulnerability.cvss_score >= 7 else 'info' if vulnerability.cvss_score >= 4 else 'success' }}">
                  {{ "%.1f"|format(vulnerability.cvss_score) }}/10
                </span>
                {% else %}
                <span class="text-muted">N/A</span>
                {% endif %}
              </td>
            </tr>
            <tr>
              <td><strong>Severity:</strong></td>
              <td>
                {% if vulnerability.severity %}
                <span class="badge bg-{{ 'danger' if vulnerability.severity == 'CRITICAL' else 'warning' if vulnerability.severity == 'HIGH' else 'info' if vulnerability.severity == 'MEDIUM' else 'success' }}">
                  {{ vulnerability.severity }}
                </span>
                {% else %}
                <span class="text-muted">N/A</span>
                {% endif %}
              </td>
            </tr>
            <tr>
              <td><strong>First Seen:</strong></td>
              <td>
                <small class="text-muted">{{ vulnerability.first_seen|format_datetime }}</small>
              </td>
            </tr>
            <tr>
              <td><strong>Last Seen:</strong></td>
              <td>
                <small class="text-muted">{{ vulnerability.last_seen|format_datetime }}</small>
              </td>
            </tr>
            <tr>
              <td><strong>Status:</strong></td>
              <td>
                {% if vulnerability.status %}
                <span class="badge bg-{{ 'success' if vulnerability.status == 'RESOLVED' else 'warning' if vulnerability.status == 'IN_PROGRESS' else 'danger' }}">
                  {{ vulnerability.status|replace('_', ' ')|title }}
                </span>
                {% else %}
                <span class="badge bg-danger">Active</span>
                {% endif %}
              </td>
            </tr>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Vulnerability Description -->
  {% if vulnerability.description %}
  <div class="card mb-3">
    <div class="card-header">
      <h3 class="card-title">
        <i class="bi bi-file-text"></i> Description
      </h3>
    </div>
    <div class="card-body">
      <p class="text-muted">{{ vulnerability.description }}</p>
    </div>
  </div>
  {% endif %}

  <!-- Technical Details -->
  <div class="card mb-3">
    <div class="card-header">
      <h3 class="card-title">
        <i class="bi bi-gear"></i> Technical Details
      </h3>
    </div>
    <div class="card-body">
      <div class="row">
        <div class="col-md-6">
          <h5>Network Information</h5>
          <table class="table table-sm">
            <tr>
              <td><strong>Protocol:</strong></td>
              <td>
                {% if vulnerability.protocol %}
                <code>{{ vulnerability.protocol|upper }}</code>
                {% else %}
                <span class="text-muted">N/A</span>
                {% endif %}
              </td>
            </tr>
            <tr>
              <td><strong>Port State:</strong></td>
              <td>
                {% if vulnerability.port_state %}
                <span class="badge bg-{{ 'success' if vulnerability.port_state == 'open' else 'danger' if vulnerability.port_state == 'closed' else 'warning' }}">
                  {{ vulnerability.port_state|title }}
                </span>
                {% else %}
                <span class="text-muted">N/A</span>
                {% endif %}
              </td>
            </tr>
            <tr>
              <td><strong>Service Product:</strong></td>
              <td>
                {% if vulnerability.service_product %}
                {{ vulnerability.service_product }}
                {% else %}
                <span class="text-muted">N/A</span>
                {% endif %}
              </td>
            </tr>
            <tr>
              <td><strong>OS Information:</strong></td>
              <td>
                {% if vulnerability.os_info %}
                {{ vulnerability.os_info }}
                {% else %}
                <span class="text-muted">N/A</span>
                {% endif %}
              </td>
            </tr>
          </table>
        </div>
        <div class="col-md-6">
          <h5>Scan Information</h5>
          <table class="table table-sm">
            <tr>
              <td><strong>Scanner:</strong></td>
              <td>
                {% if vulnerability.scanner %}
                <span class="badge bg-info">{{ vulnerability.scanner }}</span>
                {% else %}
                <span class="text-muted">N/A</span>
                {% endif %}
              </td>
            </tr>
            <tr>
              <td><strong>Scan ID:</strong></td>
              <td>
                {% if vulnerability.scan_id %}
                <code>{{ vulnerability.scan_id }}</code>
                {% else %}
                <span class="text-muted">N/A</span>
                {% endif %}
              </td>
            </tr>
            <tr>
              <td><strong>Detection Method:</strong></td>
              <td>
                {% if vulnerability.detection_method %}
                {{ vulnerability.detection_method }}
                {% else %}
                <span class="text-muted">N/A</span>
                {% endif %}
              </td>
            </tr>
            <tr>
              <td><strong>Confidence:</strong></td>
              <td>
                {% if vulnerability.confidence %}
                <div class="progress" style="height: 20px;">
                  <div class="progress-bar bg-{{ 'success' if vulnerability.confidence >= 80 else 'warning' if vulnerability.confidence >= 60 else 'danger' }}"
                       role="progressbar"
                       style="width: {{ vulnerability.confidence }}%">
                    {{ vulnerability.confidence }}%
                  </div>
                </div>
                {% else %}
                <span class="text-muted">N/A</span>
                {% endif %}
              </td>
            </tr>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Raw Scan Output -->
  {% if vulnerability.raw_output %}
  <div class="card mb-3">
    <div class="card-header">
      <h3 class="card-title">
        <i class="bi bi-terminal"></i> Raw Scan Output
      </h3>
    </div>
    <div class="card-body">
      <pre class="bg-light p-3 border rounded"><code>{{ vulnerability.raw_output }}</code></pre>
    </div>
  </div>
  {% endif %}

  <!-- Remediation -->
  {% if vulnerability.remediation %}
  <div class="card mb-3">
    <div class="card-header">
      <h3 class="card-title">
        <i class="bi bi-tools"></i> Remediation
      </h3>
    </div>
    <div class="card-body">
      <div class="alert alert-info">
        <i class="bi bi-info-circle"></i>
        {{ vulnerability.remediation }}
      </div>
    </div>
  </div>
  {% endif %}

  <!-- References -->
  {% if vulnerability.references %}
  <div class="card mb-3">
    <div class="card-header">
      <h3 class="card-title">
        <i class="bi bi-link-45deg"></i> References
      </h3>
    </div>
    <div class="card-body">
      {% for reference in vulnerability.references.split(',') %}
      <div class="mb-2">
        <a href="{{ reference.strip() }}" target="_blank" class="text-decoration-none">
          <i class="bi bi-box-arrow-up-right"></i> {{ reference.strip() }}
        </a>
      </div>
      {% endfor %}
    </div>
  </div>
  {% endif %}

  <!-- Actions -->
  <div class="card">
    <div class="card-header">
      <h3 class="card-title">
        <i class="bi bi-lightning"></i> Actions
      </h3>
    </div>
    <div class="card-body">
      <div class="btn-group" role="group">
        <a href="{{ url_for('security.vulnerabilities') }}" class="btn btn-secondary">
          <i class="bi bi-arrow-left"></i> Back to Vulnerabilities
        </a>
        {% if vulnerability.cve_id %}
        <a href="{{ url_for('security.cve_detail', cve_id=vulnerability.cve_id) }}" class="btn btn-outline-primary">
          <i class="bi bi-shield-exclamation"></i> View CVE Details
        </a>
        {% endif %}
        <a href="{{ url_for('network.host_detail', ip_address=vulnerability.ip_address) }}" class="btn btn-outline-info">
          <i class="bi bi-hdd-network"></i> View Host Details
        </a>
        {% if vulnerability.port %}
        <a href="{{ url_for('network.ports', host=vulnerability.ip_address, port=vulnerability.port) }}" class="btn btn-outline-success">
          <i class="bi bi-hdd-network-fill"></i> View Port Details
        </a>
        {% endif %}
      </div>
    </div>
  </div>
</div>
{% endblock %}