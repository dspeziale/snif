{% extends "base.html" %}

{% block title %}{{ cve_info.cve_id }} - CVE Details{% endblock %}
{% block page_title %}CVE Details: {{ cve_info.cve_id }}{% endblock %}

{% block breadcrumbs %}
<li class="breadcrumb-item"><a href="{{ url_for('index') }}">Home</a></li>
<li class="breadcrumb-item"><a href="{{ url_for('security.overview') }}">Security</a></li>
<li class="breadcrumb-item"><a href="{{ url_for('security.vulnerabilities') }}">Vulnerabilities</a></li>
<li class="breadcrumb-item active">{{ cve_info.cve_id }}</li>
{% endblock %}

{% block content %}
<div class="container-fluid">
  <!-- CVE Header -->
  <div class="card mb-3">
    <div class="card-header">
      <h3 class="card-title">
        <i class="bi bi-shield-exclamation"></i> {{ cve_info.cve_id }}
      </h3>
      <div class="card-tools">
        <a href="https://nvd.nist.gov/vuln/detail/{{ cve_info.cve_id }}"
           target="_blank" class="btn btn-outline-primary btn-sm">
          <i class="bi bi-box-arrow-up-right"></i> View on NVD
        </a>
        <a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name={{ cve_info.cve_id }}"
           target="_blank" class="btn btn-outline-secondary btn-sm">
          <i class="bi bi-box-arrow-up-right"></i> View on MITRE
        </a>
      </div>
    </div>
    <div class="card-body">
      <div class="row">
        <div class="col-md-6">
          <h5>Impact Statistics</h5>
          <table class="table table-sm">
            <tr>
              <td><strong>Total Occurrences:</strong></td>
              <td><span class="badge bg-info">{{ cve_info.total_occurrences }}</span></td>
            </tr>
            <tr>
              <td><strong>Affected Hosts:</strong></td>
              <td><span class="badge bg-warning">{{ cve_info.affected_hosts }}</span></td>
            </tr>
            <tr>
              <td><strong>Max CVSS Score:</strong></td>
              <td>
                {% if cve_info.max_cvss %}
                <span class="badge bg-{{ 'danger' if cve_info.max_cvss >= 9 else 'warning' if cve_info.max_cvss >= 7 else 'info' if cve_info.max_cvss >= 4 else 'success' }}">
                  {{ "%.1f"|format(cve_info.max_cvss) }}
                </span>
                {% else %}
                <span class="text-muted">N/A</span>
                {% endif %}
              </td>
            </tr>
            <tr>
              <td><strong>Average CVSS Score:</strong></td>
              <td>
                {% if cve_info.avg_cvss %}
                <span class="badge bg-secondary">{{ "%.1f"|format(cve_info.avg_cvss) }}</span>
                {% else %}
                <span class="text-muted">N/A</span>
                {% endif %}
              </td>
            </tr>
          </table>
        </div>
        <div class="col-md-6">
          <h5>Vulnerability Characteristics</h5>
          <div class="mb-2">
            <strong>Severities:</strong>
            {% for severity in cve_info.severities %}
            <span class="badge bg-{{ 'danger' if severity == 'CRITICAL' else 'warning' if severity == 'HIGH' else 'info' if severity == 'MEDIUM' else 'success' }}">
              {{ severity }}
            </span>
            {% endfor %}
          </div>
          <div class="mb-2">
            <strong>Vulnerability Types:</strong>
            {% for vuln_type in cve_info.vuln_types %}
            <span class="badge bg-light text-dark">{{ vuln_type }}</span>
            {% endfor %}
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Affected Hosts -->
  <div class="card">
    <div class="card-header">
      <h3 class="card-title">
        <i class="bi bi-hdd-network"></i> Affected Hosts
        <span class="badge bg-secondary ms-2">{{ hosts_affected|length }} hosts</span>
      </h3>
    </div>
    <div class="card-body">
      {% for host_ip, host_data in hosts_affected.items() %}
      <div class="card mb-3">
        <div class="card-header">
          <h5 class="card-title mb-0">
            <i class="bi bi-hdd"></i>
            <a href="{{ url_for('network.host_detail', ip_address=host_ip) }}" class="text-decoration-none">
              {{ host_ip }}
            </a>
            {% if host_data.hostname %}
            <small class="text-muted">({{ host_data.hostname }})</small>
            {% endif %}
            {% if host_data.vendor %}
            <span class="badge bg-info ms-2">{{ host_data.vendor }}</span>
            {% endif %}
          </h5>
        </div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-sm table-striped">
              <thead>
                <tr>
                  <th>Severity</th>
                  <th>CVSS Score</th>
                  <th>Port</th>
                  <th>Service</th>
                  <th>Version</th>
                  <th>Type</th>
                  <th>First Seen</th>
                  <th>Last Seen</th>
                </tr>
              </thead>
              <tbody>
                {% for occurrence in host_data.occurrences %}
                <tr>
                  <td>
                    {% if occurrence.severity %}
                    <span class="badge bg-{{ 'danger' if occurrence.severity == 'CRITICAL' else 'warning' if occurrence.severity == 'HIGH' else 'info' if occurrence.severity == 'MEDIUM' else 'success' }}">
                      {{ occurrence.severity }}
                    </span>
                    {% else %}
                    <span class="text-muted">N/A</span>
                    {% endif %}
                  </td>
                  <td>
                    {% if occurrence.cvss_score %}
                    <span class="badge bg-{{ 'danger' if occurrence.cvss_score >= 9 else 'warning' if occurrence.cvss_score >= 7 else 'info' if occurrence.cvss_score >= 4 else 'success' }}">
                      {{ "%.1f"|format(occurrence.cvss_score) }}
                    </span>
                    {% else %}
                    <span class="text-muted">N/A</span>
                    {% endif %}
                  </td>
                  <td>
                    {% if occurrence.port %}
                    <code>{{ occurrence.port }}</code>
                    {% else %}
                    <span class="text-muted">N/A</span>
                    {% endif %}
                  </td>
                  <td>
                    {% if occurrence.service %}
                    {{ occurrence.service }}
                    {% else %}
                    <span class="text-muted">N/A</span>
                    {% endif %}
                  </td>
                  <td>
                    {% if occurrence.service_version %}
                    <small class="text-muted">{{ occurrence.service_version }}</small>
                    {% else %}
                    <span class="text-muted">N/A</span>
                    {% endif %}
                  </td>
                  <td>
                    {% if occurrence.vuln_type %}
                    <small class="text-muted">{{ occurrence.vuln_type }}</small>
                    {% else %}
                    <span class="text-muted">N/A</span>
                    {% endif %}
                  </td>
                  <td>
                    <small class="text-muted">{{ occurrence.first_seen|format_datetime }}</small>
                  </td>
                  <td>
                    <small class="text-muted">{{ occurrence.last_seen|format_datetime }}</small>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
  </div>

  <!-- Back Button -->
  <div class="mt-3">
    <a href="{{ url_for('security.vulnerabilities') }}" class="btn btn-secondary">
      <i class="bi bi-arrow-left"></i> Back to Vulnerabilities
    </a>
  </div>
</div>
{% endblock %}