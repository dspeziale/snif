{% extends "base.html" %}
{% set active_page = 'reports' %}

{% block title %}Export Data{% endblock %}

{% block content %}
<div class="container-fluid">
  <!-- Header -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <h1 class="h3 mb-0">
            <i class="bi bi-download text-success"></i> Data Export
          </h1>
          <p class="text-muted">Export network and security data in various formats</p>
        </div>
        <div>
          <a href="{{ url_for('reports.overview') }}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left"></i> Back to Reports
          </a>
        </div>
      </div>
    </div>
  </div>

  <!-- Export Options -->
  <div class="row">
    <div class="col-lg-8">
      <div class="card">
        <div class="card-header">
          <h5 class="card-title mb-0">
            <i class="bi bi-gear"></i> Export Configuration
          </h5>
        </div>
        <div class="card-body">
          <form id="exportForm">
            <!-- Data Source Selection -->
            <div class="row mb-4">
              <div class="col-md-6">
                <label class="form-label"><strong>Data Source</strong></label>
                <select class="form-select" id="dataSource" name="dataSource" onchange="updateFields()">
                  <option value="hosts">Network Hosts</option>
                  <option value="vulnerabilities">Vulnerabilities</option>
                  <option value="ports">Open Ports</option>
                  <option value="services">Services</option>
                  <option value="scans">Scan History</option>
                  <option value="combined">Complete Dataset</option>
                </select>
              </div>
              <div class="col-md-6">
                <label class="form-label"><strong>Export Format</strong></label>
                <select class="form-select" id="exportFormat" name="exportFormat">
                  <option value="csv">CSV (Comma Separated Values)</option>
                  <option value="json">JSON (JavaScript Object Notation)</option>
                  <option value="xlsx">XLSX (Microsoft Excel)</option>
                  <option value="xml">XML (Extensible Markup Language)</option>
                  <option value="pdf">PDF (Portable Document Format)</option>
                </select>
              </div>
            </div>

            <!-- Field Selection -->
            <div class="mb-4">
              <label class="form-label"><strong>Fields to Include</strong></label>
              <div class="row" id="fieldSelection">
                <!-- Dynamic field checkboxes will be populated here -->
              </div>
              <div class="form-check mt-2">
                <input class="form-check-input" type="checkbox" id="selectAll" onchange="toggleAllFields()">
                <label class="form-check-label" for="selectAll">
                  Select All Fields
                </label>
              </div>
            </div>

            <!-- Filters -->
            <div class="mb-4">
              <label class="form-label"><strong>Filters</strong></label>
              <div class="row">
                <div class="col-md-4">
                  <label class="form-label">Date Range</label>
                  <select class="form-select" id="dateRange" name="dateRange">
                    <option value="all">All Time</option>
                    <option value="today">Today</option>
                    <option value="week">Last Week</option>
                    <option value="month">Last Month</option>
                    <option value="quarter">Last Quarter</option>
                    <option value="custom">Custom Range</option>
                  </select>
                </div>
                <div class="col-md-4" id="customDateContainer" style="display: none;">
                  <label class="form-label">Custom Date Range</label>
                  <div class="input-group">
                    <input type="date" class="form-control" id="startDate" name="startDate">
                    <span class="input-group-text">to</span>
                    <input type="date" class="form-control" id="endDate" name="endDate">
                  </div>
                </div>
                <div class="col-md-4">
                  <label class="form-label">Status Filter</label>
                  <select class="form-select" id="statusFilter" name="statusFilter">
                    <option value="all">All Status</option>
                    <option value="up">Active Only</option>
                    <option value="down">Inactive Only</option>
                  </select>
                </div>
              </div>
            </div>

            <!-- Additional Options -->
            <div class="mb-4">
              <label class="form-label"><strong>Additional Options</strong></label>
              <div class="row">
                <div class="col-md-6">
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="includeHeaders" name="includeHeaders" checked>
                    <label class="form-check-label" for="includeHeaders">
                      Include Headers
                    </label>
                  </div>
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="compressOutput" name="compressOutput">
                    <label class="form-check-label" for="compressOutput">
                      Compress Output (ZIP)
                    </label>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="includeTimestamps" name="includeTimestamps" checked>
                    <label class="form-check-label" for="includeTimestamps">
                      Include Timestamps
                    </label>
                  </div>
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="emailResults" name="emailResults">
                    <label class="form-check-label" for="emailResults">
                      Email Results
                    </label>
                  </div>
                </div>
              </div>
            </div>

            <!-- Export Button -->
            <div class="d-grid gap-2 d-md-flex justify-content-md-end">
              <button type="button" class="btn btn-outline-secondary me-md-2" onclick="resetForm()">
                <i class="bi bi-arrow-clockwise"></i> Reset
              </button>
              <button type="button" class="btn btn-success" onclick="startExport()">
                <i class="bi bi-download"></i> Start Export
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Export Information -->
    <div class="col-lg-4">
      <div class="card">
        <div class="card-header">
          <h5 class="card-title mb-0">
            <i class="bi bi-info-circle"></i> Export Information
          </h5>
        </div>
        <div class="card-body">
          <div class="alert alert-info">
            <i class="bi bi-lightbulb"></i>
            <strong>Tips:</strong>
            <ul class="mb-0 mt-2">
              <li>CSV format is best for spreadsheet analysis</li>
              <li>JSON format is ideal for API integration</li>
              <li>PDF format creates formatted reports</li>
              <li>Large datasets will be compressed automatically</li>
            </ul>
          </div>

          <h6>Available Data Sources:</h6>
          <div class="list-group list-group-flush">
            <div class="list-group-item px-0">
              <strong>Network Hosts</strong>
              <br><small class="text-muted">IP addresses, hostnames, MAC addresses, vendor info</small>
            </div>
            <div class="list-group-item px-0">
              <strong>Vulnerabilities</strong>
              <br><small class="text-muted">Security issues, severity levels, CVE references</small>
            </div>
            <div class="list-group-item px-0">
              <strong>Open Ports</strong>
              <br><small class="text-muted">Port numbers, protocols, service detection</small>
            </div>
            <div class="list-group-item px-0">
              <strong>Services</strong>
              <br><small class="text-muted">Service names, versions, banners</small>
            </div>
            <div class="list-group-item px-0">
              <strong>Scan History</strong>
              <br><small class="text-muted">Historical scan data and trends</small>
            </div>
          </div>
        </div>
      </div>

      <!-- Quick Export -->
      <div class="card mt-3">
        <div class="card-header">
          <h5 class="card-title mb-0">
            <i class="bi bi-lightning"></i> Quick Export
          </h5>
        </div>
        <div class="card-body">
          <p class="text-muted small">Common export presets</p>
          <div class="d-grid gap-2">
            <button class="btn btn-outline-primary btn-sm" onclick="quickExport('hosts', 'csv')">
              <i class="bi bi-file-excel"></i> All Hosts (CSV)
            </button>
            <button class="btn btn-outline-danger btn-sm" onclick="quickExport('vulnerabilities', 'pdf')">
              <i class="bi bi-file-pdf"></i> Vulnerabilities (PDF)
            </button>
            <button class="btn btn-outline-info btn-sm" onclick="quickExport('combined', 'json')">
              <i class="bi bi-filetype-json"></i> Complete Data (JSON)
            </button>
            <button class="btn btn-outline-success btn-sm" onclick="quickExport('ports', 'xlsx')">
              <i class="bi bi-file-excel"></i> Open Ports (XLSX)
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Export Progress -->
  <div class="row mt-4" id="exportProgress" style="display: none;">
    <div class="col-12">
      <div class="card">
        <div class="card-header">
          <h5 class="card-title mb-0">
            <i class="bi bi-gear"></i> Export Progress
          </h5>
        </div>
        <div class="card-body">
          <div class="d-flex align-items-center">
            <strong class="me-3">Processing...</strong>
            <div class="progress flex-grow-1 me-3">
              <div class="progress-bar progress-bar-striped progress-bar-animated"
                   role="progressbar"
                   style="width: 0%"
                   id="progressBar">
              </div>
            </div>
            <span id="progressText">0%</span>
          </div>
          <div class="mt-3" id="exportStatus">
            <div class="text-muted">
              <i class="bi bi-clock"></i> Estimated time remaining: <span id="timeRemaining">Calculating...</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Recent Exports -->
  <div class="row mt-4">
    <div class="col-12">
      <div class="card">
        <div class="card-header">
          <h5 class="card-title mb-0">
            <i class="bi bi-clock-history"></i> Recent Exports
          </h5>
        </div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-hover">
              <thead>
                <tr>
                  <th>Export Time</th>
                  <th>Data Source</th>
                  <th>Format</th>
                  <th>Records</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td>Dec 11, 2024 14:30</td>
                  <td><span class="badge bg-primary">Vulnerabilities</span></td>
                  <td><span class="badge bg-danger">PDF</span></td>
                  <td>245 records</td>
                  <td><span class="badge bg-success">Completed</span></td>
                  <td>
                    <button class="btn btn-sm btn-outline-primary">
                      <i class="bi bi-download"></i> Download
                    </button>
                  </td>
                </tr>
                <tr>
                  <td>Dec 10, 2024 09:15</td>
                  <td><span class="badge bg-info">All Hosts</span></td>
                  <td><span class="badge bg-success">CSV</span></td>
                  <td>89 records</td>
                  <td><span class="badge bg-success">Completed</span></td>
                  <td>
                    <button class="btn btn-sm btn-outline-primary">
                      <i class="bi bi-download"></i> Download
                    </button>
                  </td>
                </tr>
                <tr>
                  <td>Dec 08, 2024 16:45</td>
                  <td><span class="badge bg-warning">Complete Dataset</span></td>
                  <td><span class="badge bg-info">JSON</span></td>
                  <td>1,247 records</td>
                  <td><span class="badge bg-danger">Expired</span></td>
                  <td>
                    <button class="btn btn-sm btn-outline-secondary" disabled>
                      <i class="bi bi-x-circle"></i> Expired
                    </button>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Field definitions for each data source
const fieldDefinitions = {
    hosts: [
        {id: 'ip_address', label: 'IP Address', checked: true},
        {id: 'hostname', label: 'Hostname', checked: true},
        {id: 'mac_address', label: 'MAC Address', checked: true},
        {id: 'vendor', label: 'Vendor', checked: true},
        {id: 'status', label: 'Status', checked: true},
        {id: 'os', label: 'Operating System', checked: false},
        {id: 'last_seen', label: 'Last Seen', checked: true},
        {id: 'ports_count', label: 'Open Ports Count', checked: false}
    ],
    vulnerabilities: [
        {id: 'vuln_id', label: 'Vulnerability ID', checked: true},
        {id: 'host_ip', label: 'Host IP', checked: true},
        {id: 'port', label: 'Port', checked: true},
        {id: 'severity', label: 'Severity', checked: true},
        {id: 'description', label: 'Description', checked: true},
        {id: 'cve', label: 'CVE Reference', checked: false},
        {id: 'solution', label: 'Solution', checked: false},
        {id: 'discovery_date', label: 'Discovery Date', checked: true}
    ],
    ports: [
        {id: 'host_ip', label: 'Host IP', checked: true},
        {id: 'port_number', label: 'Port Number', checked: true},
        {id: 'protocol', label: 'Protocol', checked: true},
        {id: 'state', label: 'State', checked: true},
        {id: 'service', label: 'Service', checked: false},
        {id: 'version', label: 'Version', checked: false},
        {id: 'banner', label: 'Banner', checked: false}
    ],
    services: [
        {id: 'host_ip', label: 'Host IP', checked: true},
        {id: 'port', label: 'Port', checked: true},
        {id: 'service_name', label: 'Service Name', checked: true},
        {id: 'version', label: 'Version', checked: true},
        {id: 'banner', label: 'Banner', checked: false},
        {id: 'cpe', label: 'CPE', checked: false}
    ],
    scans: [
        {id: 'scan_id', label: 'Scan ID', checked: true},
        {id: 'start_time', label: 'Start Time', checked: true},
        {id: 'end_time', label: 'End Time', checked: true},
        {id: 'target', label: 'Target', checked: true},
        {id: 'hosts_found', label: 'Hosts Found', checked: true},
        {id: 'ports_found', label: 'Ports Found', checked: false},
        {id: 'status', label: 'Status', checked: true}
    ],
    combined: [
        {id: 'all_hosts', label: 'All Host Data', checked: true},
        {id: 'all_vulnerabilities', label: 'All Vulnerabilities', checked: true},
        {id: 'all_ports', label: 'All Ports', checked: false},
        {id: 'all_services', label: 'All Services', checked: false},
        {id: 'scan_history', label: 'Scan History', checked: false}
    ]
};

function updateFields() {
    const dataSource = document.getElementById('dataSource').value;
    const container = document.getElementById('fieldSelection');
    const fields = fieldDefinitions[dataSource] || [];

    container.innerHTML = '';

    fields.forEach(field => {
        const colDiv = document.createElement('div');
        colDiv.className = 'col-md-6 col-lg-4';

        const checkDiv = document.createElement('div');
        checkDiv.className = 'form-check';

        const input = document.createElement('input');
        input.className = 'form-check-input field-checkbox';
        input.type = 'checkbox';
        input.id = 'field_' + field.id;
        input.value = field.id;
        input.checked = field.checked;

        const label = document.createElement('label');
        label.className = 'form-check-label';
        label.htmlFor = 'field_' + field.id;
        label.textContent = field.label;

        checkDiv.appendChild(input);
        checkDiv.appendChild(label);
        colDiv.appendChild(checkDiv);
        container.appendChild(colDiv);
    });
}

function toggleAllFields() {
    const selectAll = document.getElementById('selectAll');
    const fieldCheckboxes = document.querySelectorAll('.field-checkbox');

    fieldCheckboxes.forEach(checkbox => {
        checkbox.checked = selectAll.checked;
    });
}

function resetForm() {
    document.getElementById('exportForm').reset();
    document.getElementById('dataSource').value = 'hosts';
    updateFields();
    document.getElementById('customDateContainer').style.display = 'none';
}

function quickExport(dataSource, format) {
    document.getElementById('dataSource').value = dataSource;
    document.getElementById('exportFormat').value = format;
    updateFields();
    startExport();
}

function startExport() {
    const dataSource = document.getElementById('dataSource').value;
    const format = document.getElementById('exportFormat').value;

    // Get selected fields
    const selectedFields = [];
    document.querySelectorAll('.field-checkbox:checked').forEach(checkbox => {
        selectedFields.push(checkbox.value);
    });

    if (selectedFields.length === 0) {
        alert('Please select at least one field to export.');
        return;
    }

    // Show progress
    document.getElementById('exportProgress').style.display = 'block';

    // Simulate export process
    let progress = 0;
    const progressBar = document.getElementById('progressBar');
    const progressText = document.getElementById('progressText');
    const timeRemaining = document.getElementById('timeRemaining');

    const interval = setInterval(() => {
        progress += Math.random() * 20;
        if (progress > 100) progress = 100;

        progressBar.style.width = progress + '%';
        progressText.textContent = Math.round(progress) + '%';

        const remaining = Math.max(0, Math.round((100 - progress) / 20));
        timeRemaining.textContent = remaining > 0 ? remaining + ' seconds' : 'Almost done...';

        if (progress >= 100) {
            clearInterval(interval);
            setTimeout(() => {
                document.getElementById('exportProgress').style.display = 'none';

                // Trigger download
                const filename = `export_${dataSource}_${Date.now()}.${format}`;
                downloadFile(filename, dataSource, format, selectedFields);

                // Show success message
                alert('Export completed successfully! The file has been downloaded.');
            }, 1000);
        }
    }, 500);
}

function downloadFile(filename, dataSource, format, fields) {
    // Create export URL with parameters
    const params = new URLSearchParams({
        table: dataSource,
        format: format,
        fields: fields.join(','),
        filters: JSON.stringify(getFilters())
    });

    // Trigger download
    window.open(`/reports/export/${format}?${params.toString()}`, '_blank');
}

function getFilters() {
    return {
        dateRange: document.getElementById('dateRange').value,
        startDate: document.getElementById('startDate').value,
        endDate: document.getElementById('endDate').value,
        statusFilter: document.getElementById('statusFilter').value,
        includeHeaders: document.getElementById('includeHeaders').checked,
        compressOutput: document.getElementById('compressOutput').checked,
        includeTimestamps: document.getElementById('includeTimestamps').checked
    };
}

// Date range change handler
document.getElementById('dateRange').addEventListener('change', function() {
    const customContainer = document.getElementById('customDateContainer');
    if (this.value === 'custom') {
        customContainer.style.display = 'block';
    } else {
        customContainer.style.display = 'none';
    }
});

// Initialize fields on page load
document.addEventListener('DOMContentLoaded', function() {
    updateFields();
});
</script>
{% endblock %}